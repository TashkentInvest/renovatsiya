<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ИнвестУз - Интерактив харита</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

    <style>
        /* Government Style Variables */
        :root {
            --primary-blue: #1e3a8a;
            --secondary-blue: #3b82f6;
            --accent-gold: #f59e0b;
            --success-green: #10b981;
            --warning-orange: #f97316;
            --error-red: #ef4444;
            --white: #ffffff;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            --border-radius: 8px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--gray-50);
            overflow: hidden;
            color: var(--gray-900);
        }

        /* Government Header with Uzbek Flag Colors */
        .app-header {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--secondary-blue) 100%);
            color: var(--white);
            padding: 0 24px;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: var(--shadow);
            z-index: 1000;
            position: relative;
        }

        .uzbek-flag-stripe {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg,
                #0099cc 0%, #0099cc 33.33%,
                #ffffff 33.33%, #ffffff 66.66%,
                #1eb53a 66.66%, #1eb53a 100%);
        }

        .app-logo {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .logo-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--accent-gold), #fbbf24);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .logo-icon i {
            font-size: 24px;
            color: var(--white);
        }

        .app-title {
            font-size: 24px;
            font-weight: 700;
            letter-spacing: -0.025em;
        }

        .app-subtitle {
            font-size: 14px;
            opacity: 0.9;
            font-weight: 400;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .lang-switcher {
            display: flex;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 25px;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .lang-btn {
            padding: 8px 16px;
            background: transparent;
            border: none;
            color: var(--white);
            cursor: pointer;
            transition: var(--transition);
            font-size: 14px;
            font-weight: 500;
        }

        .lang-btn.active {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
        }

        .lang-btn:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        /* Main Layout */
        .main-content {
            height: calc(100vh - 70px);
            position: relative;
            display: flex;
        }

        .map-container {
            flex: 1;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        /* Enhanced Control Panels */
        .control-panel {
            position: absolute;
            background: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            max-height: 80vh;
            overflow-y: auto;
            backdrop-filter: blur(10px);
            border: 1px solid var(--gray-200);
        }

        .layer-controls {
            top: 20px;
            right: 20px;
            width: 320px;
            padding: 24px;
        }

        .map-style-controls {
            top: 90px;
            left: 20px;
            width: 200px;
            padding: 20px;
        }

        .geojson-controls {
            bottom: 20px;
            left: 20px;
            width: 340px;
            padding: 24px;
        }

        .control-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--gray-900);
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--gray-100);
        }

        .control-title i {
            color: var(--primary-blue);
        }

        /* Enhanced Layer Buttons */
        .layer-button {
            width: 100%;
            padding: 16px 20px;
            background: var(--white);
            border: 2px solid var(--gray-200);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 14px;
            font-weight: 500;
            position: relative;
            overflow: hidden;
        }

        .layer-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.1), transparent);
            transition: left 0.5s;
        }

        .layer-button:hover::before {
            left: 100%;
        }

        .layer-button:hover {
            border-color: var(--secondary-blue);
            background: var(--gray-50);
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .layer-button.active {
            background: linear-gradient(135deg, var(--primary-blue), var(--secondary-blue));
            color: var(--white);
            border-color: var(--primary-blue);
            transform: translateY(-1px);
            box-shadow: var(--shadow);
        }

        .layer-button-content {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .layer-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .count-badge {
            background: linear-gradient(135deg, var(--error-red), #dc2626);
            color: var(--white);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            min-width: 24px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(239, 68, 68, 0.3);
        }

        .layer-button.active .count-badge {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(5px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* Map Style Controls */
        .style-button {
            width: 100%;
            padding: 12px 16px;
            background: var(--white);
            border: 2px solid var(--gray-200);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            margin-bottom: 10px;
            font-size: 14px;
            font-weight: 500;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .style-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(245, 158, 11, 0.1), transparent);
            transition: left 0.5s;
        }

        .style-button:hover::before {
            left: 100%;
        }

        .style-button:hover {
            border-color: var(--accent-gold);
            transform: translateY(-1px);
            box-shadow: var(--shadow);
        }

        .style-button.active {
            background: linear-gradient(135deg, var(--accent-gold), #f59e0b);
            color: var(--white);
            border-color: var(--accent-gold);
            box-shadow: var(--shadow);
        }

        /* GeoJSON Controls */
        .file-input-group {
            margin-bottom: 20px;
        }

        .file-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--gray-200);
            border-radius: var(--border-radius);
            font-size: 14px;
            margin-bottom: 12px;
            transition: var(--transition);
            background: var(--white);
        }

        .file-input:focus {
            outline: none;
            border-color: var(--secondary-blue);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .button-group {
            display: flex;
            gap: 12px;
        }

        .primary-btn {
            flex: 1;
            padding: 12px 16px;
            background: linear-gradient(135deg, var(--secondary-blue), var(--primary-blue));
            color: var(--white);
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .primary-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .secondary-btn {
            flex: 1;
            padding: 12px 16px;
            background: var(--white);
            color: var(--error-red);
            border: 2px solid var(--error-red);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .secondary-btn:hover {
            background: var(--error-red);
            color: var(--white);
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .status-text {
            font-size: 12px;
            color: var(--gray-600);
            background: var(--gray-50);
            padding: 10px;
            border-radius: var(--border-radius);
            margin-top: 12px;
            border-left: 4px solid var(--secondary-blue);
        }

        /* Enhanced Legend */
        .legend {
            background: var(--white);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-top: 20px;
            border: 1px solid var(--gray-200);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .legend-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--gray-900);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
            font-size: 13px;
            padding: 8px;
            border-radius: var(--border-radius);
            transition: var(--transition);
        }

        .legend-item:hover {
            background: var(--gray-50);
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 2px solid var(--white);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* Enhanced Statistics Panel */
        .stats-panel {
            background: linear-gradient(135deg, var(--gray-50), var(--white));
            border-radius: var(--border-radius);
            padding: 20px;
            margin-top: 20px;
            border: 1px solid var(--gray-200);
        }

        .stats-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--gray-900);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            font-size: 13px;
        }

        .stats-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: var(--white);
            border-radius: var(--border-radius);
            border: 1px solid var(--gray-200);
            transition: var(--transition);
        }

        .stats-item:hover {
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .stats-label {
            color: var(--gray-600);
            font-weight: 500;
        }

        .stats-value {
            font-weight: 600;
            color: var(--gray-900);
            background: var(--gray-50);
            padding: 2px 8px;
            border-radius: 4px;
        }

        /* Enhanced Sidebar */
        .sidebar {
            position: fixed;
            top: 70px;
            right: -420px;
            width: 400px;
            height: calc(100vh - 70px);
            background: var(--white);
            box-shadow: var(--shadow-lg);
            z-index: 1001;
            transition: right 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            overflow-y: auto;
            border-left: 1px solid var(--gray-200);
        }

        .sidebar.open {
            right: 0;
        }

        .sidebar-header {
            padding: 24px;
            background: linear-gradient(135deg, var(--primary-blue), var(--secondary-blue));
            color: var(--white);
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .sidebar-title {
            font-size: 20px;
            font-weight: 600;
            max-width: 320px;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.3;
        }

        .close-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: var(--white);
            padding: 8px;
            border-radius: var(--border-radius);
            transition: var(--transition);
            backdrop-filter: blur(10px);
        }

        .close-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: rotate(90deg);
        }

        .sidebar-content {
            padding: 24px;
        }

        .section {
            margin-bottom: 32px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--gray-900);
            padding-bottom: 8px;
            border-bottom: 2px solid var(--gray-100);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .info-table {
            width: 100%;
            border-collapse: collapse;
        }

        .info-table td {
            padding: 12px 0;
            font-size: 14px;
            border-bottom: 1px solid var(--gray-100);
            vertical-align: top;
        }

        .info-table td:first-child {
            font-weight: 600;
            color: var(--gray-600);
            width: 40%;
            padding-right: 16px;
        }

        .info-table td:last-child {
            color: var(--gray-900);
        }

        /* Enhanced Badges */
        .badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        .badge-renovation {
            background: linear-gradient(135deg, #f3e8ff, #e9d5ff);
            color: #7c3aed;
            border: 1px solid #c4b5fd;
        }

        .badge-investment {
            background: linear-gradient(135deg, #dbeafe, #bfdbfe);
            color: #2563eb;
            border: 1px solid #93c5fd;
        }

        .badge-auction {
            background: linear-gradient(135deg, #fed7aa, #fdba74);
            color: #ea580c;
            border: 1px solid #fb923c;
        }

        .badge-sold {
            background: linear-gradient(135deg, #dcfce7, #bbf7d0);
            color: #16a34a;
            border: 1px solid #86efac;
        }

        .badge-conservation {
            background: linear-gradient(135deg, #e0f2fe, #b3e5fc);
            color: #0277bd;
            border: 1px solid #4fc3f7;
        }

        .badge-reconstruction {
            background: linear-gradient(135deg, #fff3e0, #ffe0b2);
            color: #f57c00;
            border: 1px solid #ffb74d;
        }

        .badge-new-construction {
            background: linear-gradient(135deg, #f3e5f5, #e1bee7);
            color: #8e24aa;
            border: 1px solid #ce93d8;
        }

        /* Enhanced Loading */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            backdrop-filter: blur(5px);
        }

        .loading-content {
            text-align: center;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid var(--gray-200);
            border-top: 4px solid var(--secondary-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        .loading-text {
            font-size: 18px;
            font-weight: 500;
            color: var(--gray-700);
            margin-bottom: 8px;
        }

        .loading-subtext {
            font-size: 14px;
            color: var(--gray-500);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Enhanced Toast */
        .toast-container {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 2001;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .toast {
            padding: 16px 24px;
            border-radius: var(--border-radius);
            margin-bottom: 10px;
            color: var(--white);
            font-size: 14px;
            font-weight: 500;
            box-shadow: var(--shadow-lg);
            animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: var(--transition);
        }

        .toast:hover {
            transform: translateY(-2px);
        }

        .toast.info {
            background: linear-gradient(135deg, var(--secondary-blue), var(--primary-blue));
        }

        .toast.success {
            background: linear-gradient(135deg, var(--success-green), #059669);
        }

        .toast.warning {
            background: linear-gradient(135deg, var(--warning-orange), var(--accent-gold));
        }

        .toast.error {
            background: linear-gradient(135deg, var(--error-red), #dc2626);
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Drag and Drop */
        .drag-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(30, 58, 138, 0.1));
            border: 3px dashed var(--secondary-blue);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1500;
            font-size: 24px;
            color: var(--secondary-blue);
            font-weight: 600;
            backdrop-filter: blur(5px);
            border-radius: var(--border-radius);
            margin: 20px;
        }

        .drag-overlay.active {
            display: flex;
        }

        .drag-content {
            text-align: center;
            padding: 40px;
            background: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
        }

        /* Enhanced Popup Styles */
        .leaflet-popup-content {
            margin: 16px 20px;
            font-size: 14px;
            line-height: 1.5;
        }

        .popup-header {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--gray-900);
            border-bottom: 2px solid var(--gray-100);
            padding-bottom: 8px;
        }

        .popup-image {
            width: 100%;
            max-height: 150px;
            object-fit: cover;
            border-radius: var(--border-radius);
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .popup-details {
            font-size: 13px;
            line-height: 1.4;
        }

        .popup-details p {
            margin: 6px 0;
        }

        .popup-details strong {
            color: var(--gray-700);
            font-weight: 600;
        }

        .details-btn {
            margin-top: 12px;
            padding: 10px 16px;
            background: linear-gradient(135deg, var(--secondary-blue), var(--primary-blue));
            color: var(--white);
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: var(--transition);
            width: 100%;
        }

        .details-btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow);
        }

        /* Layer List */
        .layer-list {
            max-height: 250px;
            overflow-y: auto;
            margin-top: 20px;
        }

        .layer-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: var(--gray-50);
            border-radius: var(--border-radius);
            margin-bottom: 10px;
            font-size: 13px;
            border: 1px solid var(--gray-200);
            transition: var(--transition);
        }

        .layer-item:hover {
            background: var(--white);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .layer-name {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-weight: 500;
            color: var(--gray-900);
        }

        .layer-actions {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            padding: 6px 10px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 11px;
            font-weight: 500;
            transition: var(--transition);
        }

        .toggle-btn {
            background: var(--success-green);
            color: var(--white);
        }

        .toggle-btn.hidden {
            background: var(--gray-400);
        }

        .toggle-btn:hover {
            transform: translateY(-1px);
        }

        .remove-btn {
            background: var(--error-red);
            color: var(--white);
        }

        .remove-btn:hover {
            transform: translateY(-1px);
            background: #dc2626;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .app-title {
                font-size: 18px;
            }

            .app-subtitle {
                display: none;
            }

            .layer-controls,
            .geojson-controls {
                width: 300px;
                right: 10px;
                padding: 20px;
            }

            .map-style-controls {
                width: 180px;
                left: 10px;
                padding: 16px;
            }

            .sidebar {
                width: 100%;
                right: -100%;
            }

            .control-panel {
                max-height: 60vh;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Custom marker styles */
        .custom-marker {
            background: none !important;
            border: none !important;
        }

        .marker-icon {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 3px solid var(--white);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .marker-renovation {
            background: #7c3aed;
        }

        .marker-investment {
            background: #2563eb;
        }

        .marker-auction {
            background: #ea580c;
        }

        .marker-sold {
            background: #dc2626;
        }

        .marker-regular {
            background: #059669;
        }

        .marker-kmz {
            background: #f59e0b;
        }

        .marker-conservation {
            background: #0277bd;
        }

        .marker-reconstruction {
            background: #f57c00;
        }

        .marker-new-construction {
            background: #8e24aa;
        }

        /* Custom scrollbar */
        .control-panel::-webkit-scrollbar,
        .sidebar::-webkit-scrollbar,
        .layer-list::-webkit-scrollbar {
            width: 6px;
        }

        .control-panel::-webkit-scrollbar-track,
        .sidebar::-webkit-scrollbar-track,
        .layer-list::-webkit-scrollbar-track {
            background: var(--gray-100);
            border-radius: 3px;
        }

        .control-panel::-webkit-scrollbar-thumb,
        .sidebar::-webkit-scrollbar-thumb,
        .layer-list::-webkit-scrollbar-thumb {
            background: var(--gray-300);
            border-radius: 3px;
        }

        .control-panel::-webkit-scrollbar-thumb:hover,
        .sidebar::-webkit-scrollbar-thumb:hover,
        .layer-list::-webkit-scrollbar-thumb:hover {
            background: var(--gray-400);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- External Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <script src="https://unpkg.com/jszip@3.10.1/dist/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/togeojson/0.16.0/togeojson.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.8.0/proj4.min.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback, useMemo } = React;
        const { createRoot } = ReactDOM;

        // Enhanced Uzbek Cyrillic translations
        const TEXTS = {
            appTitle: 'ИнвестУз - Интерактив харита',
            appSubtitle: 'Тошкент шаҳар ҳокимлиги',
            mapLayers: 'Харита қатламлари',
            mapStyle: 'Харита услуби',
            geojsonManager: 'GeoJSON бошқарув',
            apiData: 'API маълумотлар',
            jsonData: 'JSON маълумотлар',
            auctions: 'Аукционлар',
            soldProperties: 'Сотилган мулклар',
            kmzData: 'KMZ маълумотлар',
            geojsonLayers: 'GeoJSON қатламлари',
            strategyLayers: 'Стратегия қатламлари',
            standard: 'Стандарт',
            satellite: 'Сунъий йўлдош',
            hybrid: 'Гибрид',
            load: 'Юклаш',
            clearAll: 'Ҳаммасини тозалаш',
            hide: 'Яшириш',
            show: 'Кўрсатиш',
            remove: '✕',
            total: 'Жами',
            visible: 'Кўринадиган',
            objectDetails: 'Объект тафсилотлари',
            basicInfo: 'Асосий маълумотлар',
            name: 'Ном',
            type: 'Тури',
            location: 'Жойлашув',
            district: 'Туман',
            area: 'Майдон',
            price: 'Нарх',
            image: 'Расм',
            viewDetails: 'Тафсилотларни кўриш',
            loadingData: 'Маълумотлар юкланмоқда...',
            loadingSubtext: 'Серверлардан маълумотлар олинмоқда',
            errorLoading: 'Юклашда хатолик',
            successLoaded: 'Муваффақиятли юкланди',
            dropFiles: 'Файлларни бу ерга ташланг',
            legend: 'Шартли белгилар',
            conservation: 'Консервация',
            reconstruction: 'Реконструкция',
            newConstruction: 'Янги қурилиш',
            statistics: 'Статистика',
            renovation: 'Реновация',
            investment: 'Инвестиция',
            auction: 'Аукцион',
            sold: 'Сотилган',
            strategy: 'Стратегия',
            function: 'Функция',
            floors: 'Қаватлар',
            globalId: 'Глобал ID',
            mahalla: 'Маҳалла',
            region: 'Вилоят',
            seismicZone: 'Сейсмик зона',
            buildingArea: 'Қурилиш майдони',
            areaRatio: 'Майдон нисбати',
            createdDate: 'Яратилган сана',
            lastEdited: 'Охирги таҳрир',
            technicalParams: 'Техник параметрлар',
            administrativeInfo: 'Маъмурий маълумот',
            buildingInfo: 'Қурилиш маълумотлари'
        };

        // Enhanced API endpoints
        const API_ENDPOINTS = {
            aktivs: '/api/aktivs',
            auction: 'https://projects.toshkentinvest.uz/api/markersing',
            sold: 'https://projects.toshkentinvest.uz/api/sotilgan',
            jsonData: '/assets/data/443_output.json',
            geoJsonStrategy: '/tashkent_master_plan.geojson'
        };

        // Enhanced map styles
        const MAP_STYLES = {
            osm: {
                name: TEXTS.standard,
                url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
                attribution: '© OpenStreetMap contributors'
            },
            satellite: {
                name: TEXTS.satellite,
                url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
                attribution: '© Esri, Maxar, Earthstar Geographics'
            },
            hybrid: {
                name: TEXTS.hybrid,
                baseUrl: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
                labelUrl: 'https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}',
                attribution: '© Esri, Maxar, Earthstar Geographics'
            }
        };

        // Enhanced strategy colors with government color scheme
        const STRATEGY_COLORS = {
            'Konservatsiya': '#0277bd',
            'Rekonstruktsiya': '#f57c00',
            'Yangi_qurilish': '#8e24aa',
            'Rekonstruksiya': '#f57c00',
            'Новое строительство': '#8e24aa',
            'Реконструкция': '#f57c00',
            'Консервация': '#0277bd',
            'Aholi_yashash_joyi': '#2563eb',
            'Savdo_xizmat': '#059669',
            'Sanoat': '#dc2626',
            'Madaniy_tarixiy': '#7c3aed',
            'default': '#6b7280'
        };

        // Enhanced function colors
        const FUNCTION_COLORS = {
            'Aholi_yashash_joyi': '#2563eb',
            'Savdo_xizmat': '#059669',
            'Sanoat': '#dc2626',
            'Madaniy_tarixiy': '#7c3aed',
            'Rekreatsiya': '#10b981',
            'Transport': '#f59e0b',
            'Kommunal': '#6b7280',
            'default': '#8e24aa'
        };

        // Utility Functions
        const initProj4 = () => {
            if (typeof proj4 !== 'undefined') {
                proj4.defs("EPSG:32642", "+proj=utm +zone=42 +datum=WGS84 +units=m +no_defs");
            }
        };

        const utmToLatLng = (x, y) => {
            try {
                if (typeof proj4 !== 'undefined') {
                    const lonLat = proj4("EPSG:32642", "EPSG:4326", [x, y]);
                    return [lonLat[1], lonLat[0]];
                }
            } catch (error) {
                console.warn('Coordinate conversion failed:', error);
            }
            return null;
        };

        const isUTM = (x, y) => Math.abs(x) > 180 || Math.abs(y) > 90;

        const convertCoordinates = (coords) => {
            if (isUTM(coords[0], coords[1])) {
                return utmToLatLng(coords[0], coords[1]);
            }
            return [coords[1], coords[0]];
        };

        // Enhanced coordinate extraction
        const extractCoordinatesFromUrl = (url) => {
            if (!url) return null;

            try {
                const decodedUrl = decodeURIComponent(url);

                // Yandex Maps
                if (decodedUrl.includes('yandex.uz/maps') || decodedUrl.includes('yandex.com/maps')) {
                    const llMatch = decodedUrl.match(/ll=([^&]+)/);
                    if (llMatch) {
                        const coords = llMatch[1].split(',');
                        if (coords.length === 2) {
                            const lng = parseFloat(coords[0]);
                            const lat = parseFloat(coords[1]);
                            if (lat >= 39 && lat <= 43 && lng >= 68 && lng <= 71) {
                                return [lat, lng];
                            }
                        }
                    }
                }

                // Google Maps patterns
                const patterns = [
                    /@(-?\d+\.?\d*),(-?\d+\.?\d*),?\d*z?/,
                    /(-?\d+\.\d{4,}),(-?\d+\.\d{4,})/,
                    /!3d(-?\d+\.?\d*)!4d(-?\d+\.?\d*)/,
                    /\/place\/[^@]*@(-?\d+\.?\d*),(-?\d+\.?\d*)/
                ];

                for (const pattern of patterns) {
                    const match = decodedUrl.match(pattern);
                    if (match) {
                        const lat = parseFloat(match[1]);
                        const lng = parseFloat(match[2]);
                        if (lat >= 39 && lat <= 43 && lng >= 68 && lng <= 71) {
                            return [lat, lng];
                        }
                    }
                }

                return null;
            } catch (error) {
                console.error('Error extracting coordinates:', error);
                return null;
            }
        };

        // Enhanced marker creation
        const createMarkerIcon = (type, size = 16) => {
            const colors = {
                renovation: '#7c3aed',
                investment: '#2563eb',
                auction: '#ea580c',
                sold: '#dc2626',
                regular: '#059669',
                kmz: '#f59e0b',
                conservation: '#0277bd',
                reconstruction: '#f57c00',
                'new-construction': '#8e24aa'
            };

            return L.divIcon({
                html: `<div class="marker-icon marker-${type}" style="width:${size}px;height:${size}px;background:${colors[type] || colors.regular}"></div>`,
                className: 'custom-marker',
                iconSize: [size + 6, size + 6],
                iconAnchor: [(size + 6) / 2, (size + 6) / 2]
            });
        };

        // Enhanced KMZ processing
        const processKMZFile = async (fileUrl) => {
            try {
                const response = await fetch(fileUrl);
                const arrayBuffer = await response.arrayBuffer();

                const zip = new JSZip();
                const contents = await zip.loadAsync(arrayBuffer);

                const kmlFile = Object.keys(contents.files).find(filename =>
                    filename.toLowerCase().endsWith('.kml')
                );

                if (!kmlFile) {
                    throw new Error('No KML file found in KMZ');
                }

                const kmlContent = await contents.files[kmlFile].async('string');
                const parser = new DOMParser();
                const kmlDoc = parser.parseFromString(kmlContent, 'text/xml');

                const geoJSON = toGeoJSON.kml(kmlDoc);
                return geoJSON;
            } catch (error) {
                console.error('Error processing KMZ:', error);
                throw error;
            }
        };

        // Enhanced strategy color function
        const getStrategyColor = (properties) => {
            if (!properties) return STRATEGY_COLORS.default;

            // Check strategy first
            const strategy = properties.strategiya || properties.strategy || properties.type;
            if (strategy) {
                const normalizedStrategy = strategy.toString().toLowerCase();

                for (const [key, color] of Object.entries(STRATEGY_COLORS)) {
                    if (key.toLowerCase() === normalizedStrategy) {
                        return color;
                    }
                }

                if (normalizedStrategy.includes('konservat') || normalizedStrategy.includes('консерв')) {
                    return STRATEGY_COLORS['Konservatsiya'];
                }
                if (normalizedStrategy.includes('rekonstrukt') || normalizedStrategy.includes('реконструк')) {
                    return STRATEGY_COLORS['Rekonstruktsiya'];
                }
                if (normalizedStrategy.includes('yangi') || normalizedStrategy.includes('новое') || normalizedStrategy.includes('строитель')) {
                    return STRATEGY_COLORS['Yangi_qurilish'];
                }
            }

            // Check function if no strategy
            const func = properties.funksiya || properties.function;
            if (func) {
                return FUNCTION_COLORS[func] || FUNCTION_COLORS.default;
            }

            return STRATEGY_COLORS.default;
        };

        // Enhanced format functions
        const formatDate = (timestamp) => {
            if (!timestamp) return 'N/A';
            try {
                const date = new Date(timestamp);
                return date.toLocaleDateString('uz-UZ');
            } catch {
                return 'N/A';
            }
        };

        const formatArea = (area) => {
            if (!area) return 'N/A';
            if (area > 10000) {
                return `${(area / 10000).toFixed(2)} га`;
            }
            return `${area.toFixed(2)} м²`;
        };

        const formatStrategy = (strategy) => {
            const strategies = {
                'Konservatsiya': TEXTS.conservation,
                'Rekonstruktsiya': TEXTS.reconstruction,
                'Yangi_qurilish': TEXTS.newConstruction,
                'Rekonstruksiya': TEXTS.reconstruction
            };
            return strategies[strategy] || strategy || 'N/A';
        };

        const formatFunction = (func) => {
            const functions = {
                'Aholi_yashash_joyi': 'Аҳоли яшаш жойи',
                'Savdo_xizmat': 'Савдо-хизмат',
                'Sanoat': 'Саноат',
                'Madaniy_tarixiy': 'Маданий-тарихий',
                'Rekreatsiya': 'Рекреация',
                'Transport': 'Транспорт',
                'Kommunal': 'Коммунал'
            };
            return functions[func] || func || 'N/A';
        };

        // Toast Component
        const Toast = ({ toasts, removeToast }) => (
            React.createElement('div', { className: 'toast-container' },
                toasts.map(toast =>
                    React.createElement('div', {
                        key: toast.id,
                        className: `toast ${toast.type}`,
                        onClick: () => removeToast(toast.id)
                    },
                        React.createElement('i', {
                            className: `fas ${
                                toast.type === 'success' ? 'fa-check-circle' :
                                toast.type === 'error' ? 'fa-exclamation-circle' :
                                toast.type === 'warning' ? 'fa-exclamation-triangle' :
                                'fa-info-circle'
                            }`
                        }),
                        React.createElement('span', null, toast.message)
                    )
                )
            )
        );

        // Enhanced Loading Component
        const Loading = ({ show }) => (
            show ? React.createElement('div', { className: 'loading-overlay' },
                React.createElement('div', { className: 'loading-content' },
                    React.createElement('div', { className: 'loading-spinner' }),
                    React.createElement('div', { className: 'loading-text' }, TEXTS.loadingData),
                    React.createElement('div', { className: 'loading-subtext' }, TEXTS.loadingSubtext)
                )
            ) : null
        );

        // Enhanced Legend Component
        const Legend = () => (
            React.createElement('div', { className: 'legend' },
                React.createElement('div', { className: 'legend-title' },
                    React.createElement('i', { className: 'fas fa-palette' }),
                    TEXTS.legend
                ),
                React.createElement('div', { className: 'legend-item' },
                    React.createElement('div', {
                        className: 'legend-color',
                        style: { backgroundColor: STRATEGY_COLORS['Konservatsiya'] }
                    }),
                    React.createElement('span', null, TEXTS.conservation)
                ),
                React.createElement('div', { className: 'legend-item' },
                    React.createElement('div', {
                        className: 'legend-color',
                        style: { backgroundColor: STRATEGY_COLORS['Rekonstruktsiya'] }
                    }),
                    React.createElement('span', null, TEXTS.reconstruction)
                ),
                React.createElement('div', { className: 'legend-item' },
                    React.createElement('div', {
                        className: 'legend-color',
                        style: { backgroundColor: STRATEGY_COLORS['Yangi_qurilish'] }
                    }),
                    React.createElement('span', null, TEXTS.newConstruction)
                ),
                React.createElement('div', { className: 'legend-item' },
                    React.createElement('div', {
                        className: 'legend-color',
                        style: { backgroundColor: FUNCTION_COLORS['Aholi_yashash_joyi'] }
                    }),
                    React.createElement('span', null, 'Аҳоли яшаш жойи')
                ),
                React.createElement('div', { className: 'legend-item' },
                    React.createElement('div', {
                        className: 'legend-color',
                        style: { backgroundColor: FUNCTION_COLORS['Savdo_xizmat'] }
                    }),
                    React.createElement('span', null, 'Савдо-хизмат')
                )
            )
        );

        // Enhanced Sidebar Component
        const Sidebar = ({ isOpen, onClose, item }) => (
            React.createElement('div', { className: `sidebar ${isOpen ? 'open' : ''}` },
                React.createElement('div', { className: 'sidebar-header' },
                    React.createElement('div', null,
                        React.createElement('h2', { className: 'sidebar-title' },
                            item?.property_name ||
                            item?.mahalla_nomi ||
                            item?.funksiya ||
                            item?.['Объект_номи'] ||
                            TEXTS.objectDetails
                        ),
                        item?.district && React.createElement('div', { className: 'app-subtitle' }, item.district)
                    ),
                    React.createElement('button', { className: 'close-btn', onClick: onClose },
                        React.createElement('i', { className: 'fas fa-times' })
                    )
                ),
                React.createElement('div', { className: 'sidebar-content' },
                    item && React.createElement('div', null,
                        // Basic Information Section
                        React.createElement('div', { className: 'section' },
                            React.createElement('h3', { className: 'section-title' },
                                React.createElement('i', { className: 'fas fa-info-circle' }),
                                TEXTS.basicInfo
                            ),
                            React.createElement('table', { className: 'info-table' },
                                React.createElement('tbody', null,
                                    // Name
                                    React.createElement('tr', null,
                                        React.createElement('td', null, TEXTS.name + ':'),
                                        React.createElement('td', null,
                                            item.property_name ||
                                            item.mahalla_nomi ||
                                            item['Объект_номи'] ||
                                            item.funksiya ||
                                            'N/A'
                                        )
                                    ),
                                    // Strategy/Type
                                    React.createElement('tr', null,
                                        React.createElement('td', null, TEXTS.strategy + ':'),
                                        React.createElement('td', null,
                                            React.createElement('span', {
                                                className: `badge badge-${
                                                    item.strategiya === 'Konservatsiya' ? 'conservation' :
                                                    item.strategiya === 'Rekonstruktsiya' ? 'reconstruction' :
                                                    item.strategiya === 'Yangi_qurilish' ? 'new-construction' :
                                                    'investment'
                                                }`
                                            }, formatStrategy(item.strategiya) || formatStrategy(item.type) || 'N/A')
                                        )
                                    ),
                                    // Function
                                    item.funksiya && React.createElement('tr', null,
                                        React.createElement('td', null, TEXTS.function + ':'),
                                        React.createElement('td', null, formatFunction(item.funksiya))
                                    ),
                                    // District/Region
                                    React.createElement('tr', null,
                                        React.createElement('td', null, TEXTS.district + ':'),
                                        React.createElement('td', null,
                                            item.district ||
                                            item.region_name ||
                                            item['Туман'] ||
                                            'N/A'
                                        )
                                    ),
                                    // Mahalla
                                    item.mahalla_nomi && React.createElement('tr', null,
                                        React.createElement('td', null, TEXTS.mahalla + ':'),
                                        React.createElement('td', null, item.mahalla_nomi)
                                    ),
                                    // Area
                                    React.createElement('tr', null,
                                        React.createElement('td', null, TEXTS.area + ':'),
                                        React.createElement('td', null,
                                            item.maydoni ? formatArea(item.maydoni * 10000) :
                                            item.land_area ? `${item.land_area} га` :
                                            item['SHAPE__Area'] ? formatArea(item['SHAPE__Area']) :
                                            'N/A'
                                        )
                                    ),
                                    // Floors
                                    item.qavatlilik && React.createElement('tr', null,
                                        React.createElement('td', null, TEXTS.floors + ':'),
                                        React.createElement('td', null, item.qavatlilik)
                                    ),
                                    // Price
                                    (item.start_price || item.sold_price) && React.createElement('tr', null,
                                        React.createElement('td', null, TEXTS.price + ':'),
                                        React.createElement('td', null,
                                            `${Number(item.start_price || item.sold_price).toLocaleString('uz-UZ')} сум`
                                        )
                                    )
                                )
                            )
                        ),

                        // Technical Parameters Section (for GeoJSON data)
                        item.code && React.createElement('div', { className: 'section' },
                            React.createElement('h3', { className: 'section-title' },
                                React.createElement('i', { className: 'fas fa-cogs' }),
                                TEXTS.technicalParams
                            ),
                            React.createElement('table', { className: 'info-table' },
                                React.createElement('tbody', null,
                                    item.code && React.createElement('tr', null,
                                        React.createElement('td', null, 'Код:'),
                                        React.createElement('td', null, item.code)
                                    ),
                                    item.globalid && React.createElement('tr', null,
                                        React.createElement('td', null, TEXTS.globalId + ':'),
                                        React.createElement('td', null, item.globalid)
                                    ),
                                    item.seysmologik_zonasi && React.createElement('tr', null,
                                        React.createElement('td', null, TEXTS.seismicZone + ':'),
                                        React.createElement('td', null, item.seysmologik_zonasi)
                                    ),
                                    item.qurilish_maydonining_yer_maydon && React.createElement('tr', null,
                                        React.createElement('td', null, TEXTS.buildingArea + ':'),
                                        React.createElement('td', null, `${item.qurilish_maydonining_yer_maydon}%`)
                                    ),
                                    item.umumiy_maydonning_yer_maydoniga && React.createElement('tr', null,
                                        React.createElement('td', null, TEXTS.areaRatio + ':'),
                                        React.createElement('td', null, item.umumiy_maydonning_yer_maydoniga)
                                    )
                                )
                            )
                        ),

                        // Administrative Information Section
                        (item.created_date || item.last_edited_date || item.created_user) && React.createElement('div', { className: 'section' },
                            React.createElement('h3', { className: 'section-title' },
                                React.createElement('i', { className: 'fas fa-user-shield' }),
                                TEXTS.administrativeInfo
                            ),
                            React.createElement('table', { className: 'info-table' },
                                React.createElement('tbody', null,
                                    item.created_date && React.createElement('tr', null,
                                        React.createElement('td', null, TEXTS.createdDate + ':'),
                                        React.createElement('td', null, formatDate(item.created_date))
                                    ),
                                    item.last_edited_date && React.createElement('tr', null,
                                        React.createElement('td', null, TEXTS.lastEdited + ':'),
                                        React.createElement('td', null, formatDate(item.last_edited_date))
                                    ),
                                    item.created_user && React.createElement('tr', null,
                                        React.createElement('td', null, 'Яратувчи:'),
                                        React.createElement('td', null, item.created_user)
                                    ),
                                    item.last_edited_user && React.createElement('tr', null,
                                        React.createElement('td', null, 'Таҳрирчи:'),
                                        React.createElement('td', null, item.last_edited_user)
                                    )
                                )
                            )
                        ),

                        // Image Section
                        item.main_image && React.createElement('div', { className: 'section' },
                            React.createElement('h3', { className: 'section-title' },
                                React.createElement('i', { className: 'fas fa-image' }),
                                TEXTS.image
                            ),
                            React.createElement('img', {
                                src: item.main_image,
                                alt: item.property_name || 'Property',
                                style: {
                                    width: '100%',
                                    maxHeight: '200px',
                                    objectFit: 'cover',
                                    borderRadius: 'var(--border-radius)',
                                    boxShadow: 'var(--shadow)'
                                },
                                onError: (e) => e.target.style.display = 'none'
                            })
                        )
                    )
                )
            )
        );

        // Layer Controls Component
        const LayerControls = ({ layers, onToggle, counts }) => (
            React.createElement('div', { className: 'control-panel layer-controls' },
                React.createElement('h3', { className: 'control-title' },
                    React.createElement('i', { className: 'fas fa-layer-group' }),
                    TEXTS.mapLayers
                ),

                Object.entries(layers).map(([key, layer]) =>
                    React.createElement('button', {
                        key: key,
                        className: `layer-button ${layer.visible ? 'active' : ''}`,
                        onClick: () => onToggle(key)
                    },
                        React.createElement('div', { className: 'layer-button-content' },
                            React.createElement('div', { className: 'layer-icon' },
                                React.createElement('i', { className: layer.icon })
                            ),
                            React.createElement('span', null, layer.name)
                        ),
                        React.createElement('span', { className: 'count-badge' }, counts[key] || 0)
                    )
                ),



                React.createElement(Legend)
            )
        );

        // Map Style Controls Component
        const MapStyleControls = ({ currentStyle, onStyleChange }) => (
            React.createElement('div', { className: 'control-panel map-style-controls' },
                React.createElement('h3', { className: 'control-title' },
                    React.createElement('i', { className: 'fas fa-map' }),
                    TEXTS.mapStyle
                ),

                Object.entries(MAP_STYLES).map(([key, style]) =>
                    React.createElement('button', {
                        key: key,
                        className: `style-button ${currentStyle === key ? 'active' : ''}`,
                        onClick: () => onStyleChange(key)
                    }, style.name)
                )
            )
        );

        // GeoJSON Controls Component
        const GeoJSONControls = ({
            geoJsonLayers,
            onLoad,
            onToggle,
            onRemove,
            onClear,
            status,
            filepath,
            setFilepath
        }) => (
            React.createElement('div', { className: 'control-panel geojson-controls' },
                React.createElement('h3', { className: 'control-title' },
                    React.createElement('i', { className: 'fas fa-file-code' }),
                    TEXTS.geojsonManager
                ),

                React.createElement('div', { className: 'file-input-group' },
                    React.createElement('input', {
                        type: 'text',
                        className: 'file-input',
                        placeholder: '/path/to/file.geojson',
                        value: filepath,
                        onChange: (e) => setFilepath(e.target.value)
                    }),
                    React.createElement('div', { className: 'button-group' },
                        React.createElement('button', { className: 'primary-btn', onClick: onLoad },
                            React.createElement('i', { className: 'fas fa-upload' }),
                            TEXTS.load
                        ),
                        React.createElement('button', { className: 'secondary-btn', onClick: onClear },
                            React.createElement('i', { className: 'fas fa-trash' }),
                            TEXTS.clearAll
                        )
                    )
                ),

                status && React.createElement('div', { className: 'status-text' }, status),

                geoJsonLayers.size > 0 && React.createElement('div', { className: 'layer-list' },
                    Array.from(geoJsonLayers.entries()).map(([layerId, layerData]) =>
                        React.createElement('div', { key: layerId, className: 'layer-item' },
                            React.createElement('span', { className: 'layer-name', title: layerId }, layerId),
                            React.createElement('div', { className: 'layer-actions' },
                                React.createElement('button', {
                                    className: `action-btn toggle-btn ${layerData.visible ? '' : 'hidden'}`,
                                    onClick: () => onToggle(layerId)
                                }, layerData.visible ? TEXTS.hide : TEXTS.show),
                                React.createElement('button', {
                                    className: 'action-btn remove-btn',
                                    onClick: () => onRemove(layerId)
                                }, TEXTS.remove)
                            )
                        )
                    )
                )
            )
        );

        // Main App Component
        const InvestUzMap = () => {
            // State Management
            const [loading, setLoading] = useState(true);
            const [toasts, setToasts] = useState([]);
            const [sidebarOpen, setSidebarOpen] = useState(false);
            const [selectedItem, setSelectedItem] = useState(null);
            const [currentMapStyle, setCurrentMapStyle] = useState('osm');
            const [geoJsonFilepath, setGeoJsonFilepath] = useState('/tashkent_master_plan.geojson');
            const [geoJsonStatus, setGeoJsonStatus] = useState('GeoJSON файллари учун тайёр...');
            const [dragActive, setDragActive] = useState(false);

            // Enhanced layer state
            const [layers, setLayers] = useState({
                // regular: { name: TEXTS.apiData, icon: 'fas fa-building', visible: true },
                jsonData: { name: TEXTS.jsonData, icon: 'fas fa-layer-group', visible: true },
                auction: { name: TEXTS.auctions, icon: 'fas fa-gavel', visible: false },
                sold: { name: TEXTS.soldProperties, icon: 'fas fa-check-circle', visible: true },
                kmz: { name: TEXTS.kmzData, icon: 'fas fa-file-archive', visible: true },
                // geojson: { name: TEXTS.strategyLayers, icon: 'fas fa-map', visible: true }
            });

            const [counts, setCounts] = useState({
                regular: 0,
                jsonData: 0,
                auction: 0,
                sold: 0,
                kmz: 0,
                geojson: 0
            });

            // Refs
            const mapRef = useRef(null);
            const mapInstanceRef = useRef(null);
            const layerGroupsRef = useRef({});
            const geoJsonLayersRef = useRef(new Map());

            // Toast Management
            const addToast = useCallback((message, type = 'info') => {
                const id = Date.now();
                setToasts(prev => [...prev, { id, message, type }]);
                setTimeout(() => {
                    setToasts(prev => prev.filter(toast => toast.id !== id));
                }, 5000);
            }, []);

            const removeToast = useCallback((id) => {
                setToasts(prev => prev.filter(toast => toast.id !== id));
            }, []);

            // Map Initialization
            const initializeMap = useCallback(() => {
                if (!mapRef.current || mapInstanceRef.current) return;

                const map = L.map(mapRef.current, {
                    center: [41.311, 69.279],
                    zoom: 11,
                    minZoom: 10,
                    maxZoom: 18,
                    preferCanvas: true
                });

                // Initialize enhanced layer groups
                const groups = {
                    regular: L.markerClusterGroup({
                        chunkedLoading: true,
                        maxClusterRadius: 40,
                        spiderfyOnMaxZoom: true,
                        showCoverageOnHover: false,
                        disableClusteringAtZoom: 15,
                        iconCreateFunction: function(cluster) {
                            const count = cluster.getChildCount();
                            let size = 'small';
                            if (count > 100) size = 'large';
                            else if (count > 10) size = 'medium';

                            return L.divIcon({
                                html: `<div class="cluster-${size}">${count}</div>`,
                                className: 'marker-cluster marker-cluster-regular',
                                iconSize: L.point(40, 40)
                            });
                        }
                    }),
                    jsonData: L.markerClusterGroup({
                        chunkedLoading: true,
                        maxClusterRadius: 40,
                        spiderfyOnMaxZoom: true,
                        showCoverageOnHover: false,
                        disableClusteringAtZoom: 15
                    }),
                    auction: L.markerClusterGroup({
                        chunkedLoading: true,
                        maxClusterRadius: 40,
                        spiderfyOnMaxZoom: true,
                        showCoverageOnHover: false,
                        disableClusteringAtZoom: 15
                    }),
                    sold: L.markerClusterGroup({
                        chunkedLoading: true,
                        maxClusterRadius: 40,
                        spiderfyOnMaxZoom: true,
                        showCoverageOnHover: false,
                        disableClusteringAtZoom: 15
                    }),
                    kmz: L.markerClusterGroup({
                        chunkedLoading: true,
                        maxClusterRadius: 40,
                        spiderfyOnMaxZoom: true,
                        showCoverageOnHover: false,
                        disableClusteringAtZoom: 15
                    })
                };

                // Add initial visible layers
                Object.entries(groups).forEach(([key, group]) => {
                    if (layers[key]?.visible) {
                        map.addLayer(group);
                    }
                });

                layerGroupsRef.current = groups;

                // Add initial map layer
                const osmLayer = L.tileLayer(MAP_STYLES.osm.url, {
                    attribution: MAP_STYLES.osm.attribution
                });
                osmLayer.addTo(map);

                mapInstanceRef.current = map;

                // Initialize coordinate system
                initProj4();
            }, [layers]);

            // Enhanced Data Fetching Functions
            const fetchRegularData = useCallback(async () => {
                try {
                    const response = await fetch(API_ENDPOINTS.aktivs);
                    if (!response.ok) throw new Error(`API request failed: ${response.status}`);

                    const data = await response.json();
                    const lots = data.lots || data || [];

                    let processed = 0;
                    let kmzProcessed = 0;
                    const group = layerGroupsRef.current.regular;
                    const kmzGroup = layerGroupsRef.current.kmz;

                    for (const lot of lots) {
                        if (!lot) continue;

                        // Add regular marker if coordinates exist
                        if (lot.lat && lot.lng) {
                            const marker = L.marker([parseFloat(lot.lat), parseFloat(lot.lng)], {
                                icon: createMarkerIcon('regular')
                            });

                            const popup = `
                                <div class="popup-header">${lot.property_name || 'Инвестиция мулки'}</div>
                                ${lot.main_image ? `<img src="${lot.main_image}" class="popup-image" onerror="this.style.display='none'">` : ''}
                                <div class="popup-details">
                                    <p><strong>${TEXTS.district}:</strong> ${lot.district || 'N/A'}</p>
                                    <p><strong>${TEXTS.location}:</strong> ${lot.address || 'N/A'}</p>
                                    ${lot.land_area ? `<p><strong>${TEXTS.area}:</strong> ${lot.land_area} га</p>` : ''}
                                    ${lot.start_price ? `<p><strong>${TEXTS.price}:</strong> ${Number(lot.start_price).toLocaleString('uz-UZ')} сум</p>` : ''}
                                </div>
                                <button class="details-btn" onclick="window.showDetails('${lot.id || processed}', 'regular')">
                                    ${TEXTS.viewDetails}
                                </button>
                            `;

                            marker.bindPopup(popup, { maxWidth: 300 });
                            marker.lotData = lot;
                            group.addLayer(marker);
                            processed++;
                        }

                        // Process KMZ files if available
                        if (lot.documents && Array.isArray(lot.documents)) {
                            const kmzDocs = lot.documents.filter(doc =>
                                doc.doc_type === 'kmz-document' && doc.file_path
                            );

                            for (const kmzDoc of kmzDocs) {
                                try {
                                    const geoJSON = await processKMZFile(kmzDoc.file_path);

                                    if (geoJSON && geoJSON.features) {
                                        geoJSON.features.forEach(feature => {
                                            const layer = createKMZLayer(feature, lot);
                                            if (layer) {
                                                kmzGroup.addLayer(layer);
                                                kmzProcessed++;
                                            }
                                        });
                                    }
                                } catch (error) {
                                    console.warn(`Failed to process KMZ for lot ${lot.id}:`, error);
                                }
                            }
                        }
                    }

                    setCounts(prev => ({
                        ...prev,
                        regular: processed,
                        kmz: kmzProcessed
                    }));

                    if (processed > 0 || kmzProcessed > 0) {
                        addToast(`${TEXTS.successLoaded}: ${processed} маркер, ${kmzProcessed} KMZ`, 'success');
                    }

                    return processed > 0 || kmzProcessed > 0;
                } catch (error) {
                    console.error('Error fetching regular data:', error);
                    addToast(`${TEXTS.errorLoading}: API маълумотлар`, 'error');
                    return false;
                }
            }, [addToast]);

            const createKMZLayer = useCallback((feature, lotData) => {
                if (!feature.geometry || !feature.geometry.coordinates) return null;

                const geomType = feature.geometry.type;

                try {
                    let layer = null;

                    switch (geomType) {
                        case 'Point':
                            const coords = convertCoordinates(feature.geometry.coordinates);
                            if (!coords) return null;
                            layer = L.marker(coords, { icon: createMarkerIcon('kmz') });
                            break;

                        case 'Polygon':
                            const rings = feature.geometry.coordinates.map(ring =>
                                ring.map(coord => convertCoordinates(coord)).filter(Boolean)
                            ).filter(ring => ring.length > 0);

                            if (rings.length === 0) return null;

                            layer = L.polygon(rings, {
                                fillColor: '#f59e0b',
                                weight: 2,
                                opacity: 0.8,
                                color: '#ffffff',
                                fillOpacity: 0.6
                            });
                            break;

                        case 'LineString':
                            const latLngs = feature.geometry.coordinates
                                .map(coord => convertCoordinates(coord))
                                .filter(Boolean);

                            if (latLngs.length === 0) return null;

                            layer = L.polyline(latLngs, {
                                color: '#f59e0b',
                                weight: 3,
                                opacity: 0.8
                            });
                            break;

                        default:
                            return null;
                    }

                    if (layer) {
                        const popup = `
                            <div class="popup-header">KMZ: ${lotData.property_name || 'Объект'}</div>
                            <div class="popup-details">
                                <p><strong>Тур:</strong> <span class="badge badge-renovation">KMZ маълумот</span></p>
                                <p><strong>${TEXTS.district}:</strong> ${lotData.district || 'N/A'}</p>
                                <p><strong>${TEXTS.location}:</strong> ${lotData.address || 'N/A'}</p>
                                ${feature.properties?.name ? `<p><strong>KMZ номи:</strong> ${feature.properties.name}</p>` : ''}
                            </div>
                            <button class="details-btn" onclick="window.showDetails('${lotData.id}', 'kmz')">
                                ${TEXTS.viewDetails}
                            </button>
                        `;

                        layer.bindPopup(popup, { maxWidth: 300 });
                        layer.kmzData = { ...lotData, kmzFeature: feature };
                    }

                    return layer;
                } catch (error) {
                    console.warn('Error creating KMZ layer:', error);
                    return null;
                }
            }, []);

            const fetchJsonData = useCallback(async () => {
                try {
                    const response = await fetch(API_ENDPOINTS.jsonData);
                    if (!response.ok) return false;

                    const data = await response.json();
                    if (!Array.isArray(data)) return false;

                    let processed = 0;
                    const group = layerGroupsRef.current.jsonData;

                    data.forEach((item, index) => {
                        const coordinates = extractCoordinatesFromUrl(item['Таклиф_Харита']);
                        if (!coordinates) return;

                        const type = item['Таклиф_тури_(Реновация,_Инвестиция,_Аукцион)'];
                        let markerType = 'investment';
                        if (type === 'Реновация') markerType = 'renovation';
                        else if (type === 'Аукцион') markerType = 'auction';

                        const marker = L.marker(coordinates, {
                            icon: createMarkerIcon(markerType)
                        });

                        const popup = `
                            <div class="popup-header">${item['Объект_номи'] || 'JSON объект'}</div>
                            <div class="popup-details">
                                <p><strong>Тур:</strong> <span class="badge badge-${markerType}">${type || 'Номаълум'}</span></p>
                                <p><strong>${TEXTS.district}:</strong> ${item['Туман'] || 'N/A'}</p>
                                <p><strong>${TEXTS.location}:</strong> ${item['Манзил_(МФЙ,_кўча)'] || 'N/A'}</p>
                            </div>
                            <button class="details-btn" onclick="window.showDetails('${index}', 'jsonData')">
                                ${TEXTS.viewDetails}
                            </button>
                        `;

                        marker.bindPopup(popup, { maxWidth: 300 });
                        marker.itemData = item;
                        group.addLayer(marker);
                        processed++;
                    });

                    setCounts(prev => ({ ...prev, jsonData: processed }));
                    if (processed > 0) {
                        addToast(`${TEXTS.successLoaded}: ${processed} JSON объект`, 'success');
                    }
                    return processed > 0;
                } catch (error) {
                    console.error('Error fetching JSON data:', error);
                    return false;
                }
            }, [addToast]);

            const fetchAuctionData = useCallback(async () => {
                try {
                    const response = await fetch(API_ENDPOINTS.auction);
                    if (!response.ok) return false;

                    const data = await response.json();
                    const lots = data.lots || [];

                    let processed = 0;
                    const group = layerGroupsRef.current.auction;

                    lots.forEach((lot, index) => {
                        if (!lot.lat || !lot.lng) return;

                        const marker = L.marker([parseFloat(lot.lat), parseFloat(lot.lng)], {
                            icon: createMarkerIcon('auction')
                        });

                        const popup = `
                            <div class="popup-header">${lot.property_name || 'Аукцион мулки'}</div>
                            ${lot.main_image ? `<img src="${lot.main_image}" class="popup-image" onerror="this.style.display='none'">` : ''}
                            <div class="popup-details">
                                <p><strong>Бошланғич нарх:</strong> ${lot.start_price ? Number(lot.start_price).toLocaleString('uz-UZ') + ' сум' : 'N/A'}</p>
                                <p><strong>Аукцион санаси:</strong> ${lot.auction_date || 'N/A'}</p>
                                <p><strong>${TEXTS.location}:</strong> ${lot.region || ''} ${lot.area || ''} ${lot.address || ''}</p>
                                <p><strong>${TEXTS.area}:</strong> ${lot.land_area || 'N/A'} га</p>
                                <p><strong>Ҳолат:</strong> <span class="badge badge-auction">Аукцион</span></p>
                            </div>
                            <button class="details-btn" onclick="window.showDetails('${index}', 'auction')">
                                ${TEXTS.viewDetails}
                            </button>
                        `;

                        marker.bindPopup(popup, { maxWidth: 300 });
                        marker.auctionData = lot;
                        group.addLayer(marker);
                        processed++;
                    });

                    setCounts(prev => ({ ...prev, auction: processed }));
                    if (processed > 0) {
                        addToast(`${TEXTS.successLoaded}: ${processed} аукцион мулки`, 'success');
                    }
                    return processed > 0;
                } catch (error) {
                    console.error('Error fetching auction data:', error);
                    return false;
                }
            }, [addToast]);

            const fetchSoldData = useCallback(async () => {
                try {
                    const response = await fetch(API_ENDPOINTS.sold);
                    if (!response.ok) return false;

                    const data = await response.json();
                    const lots = data.lots || [];

                    let processed = 0;
                    const group = layerGroupsRef.current.sold;

                    lots.forEach((lot, index) => {
                        if (!lot.lat || !lot.lng) return;

                        const marker = L.marker([parseFloat(lot.lat), parseFloat(lot.lng)], {
                            icon: createMarkerIcon('sold')
                        });

                        const popup = `
                            <div class="popup-header">🏆 ${lot.property_name || 'Сотилган мулк'}</div>
                            ${lot.main_image ? `<img src="${lot.main_image}" class="popup-image" onerror="this.style.display='none'">` : ''}
                            <div class="popup-details">
                                <p><strong>Сотилди:</strong> ${lot.sold_price ? Number(lot.sold_price).toLocaleString('uz-UZ') + ' сум' : 'N/A'}</p>
                                <p><strong>Бошланғич нарх:</strong> ${lot.start_price ? Number(lot.start_price).toLocaleString('uz-UZ') + ' сум' : 'N/A'}</p>
                                <p><strong>Ғолиб:</strong> ${lot.winner_name || 'N/A'}</p>
                                <p><strong>Аукцион санаси:</strong> ${lot.auction_date || 'N/A'}</p>
                                <p><strong>${TEXTS.location}:</strong> ${lot.region || ''} ${lot.area || ''} ${lot.address || ''}</p>
                                <p><strong>Ҳолат:</strong> <span class="badge badge-sold">✅ Сотилган</span></p>
                            </div>
                            <button class="details-btn" onclick="window.showDetails('${index}', 'sold')">
                                ${TEXTS.viewDetails}
                            </button>
                        `;

                        marker.bindPopup(popup, { maxWidth: 300 });
                        marker.soldData = lot;
                        group.addLayer(marker);
                        processed++;
                    });

                    setCounts(prev => ({ ...prev, sold: processed }));
                    if (processed > 0) {
                        addToast(`${TEXTS.successLoaded}: ${processed} сотилган мулк`, 'success');
                    }
                    return processed > 0;
                } catch (error) {
                    console.error('Error fetching sold data:', error);
                    return false;
                }
            }, [addToast]);

            // Layer Toggle
            const toggleLayer = useCallback((layerKey) => {
                setLayers(prev => {
                    const newLayers = {
                        ...prev,
                        [layerKey]: { ...prev[layerKey], visible: !prev[layerKey].visible }
                    };

                    // Update map layers
                    const map = mapInstanceRef.current;
                    const group = layerGroupsRef.current[layerKey];

                    if (group && map) {
                        if (newLayers[layerKey].visible) {
                            map.addLayer(group);
                        } else {
                            map.removeLayer(group);
                        }
                    }

                    return newLayers;
                });
            }, []);

            // Map Style Change
            const changeMapStyle = useCallback((styleKey) => {
                const map = mapInstanceRef.current;
                if (!map) return;

                // Remove current layers
                map.eachLayer(layer => {
                    if (layer._url) { // Tile layer
                        map.removeLayer(layer);
                    }
                });

                const style = MAP_STYLES[styleKey];

                if (styleKey === 'hybrid') {
                    const baseLayer = L.tileLayer(style.baseUrl, { attribution: style.attribution });
                    const labelLayer = L.tileLayer(style.labelUrl, { attribution: '' });
                    map.addLayer(baseLayer);
                    map.addLayer(labelLayer);
                } else {
                    const layer = L.tileLayer(style.url, { attribution: style.attribution });
                    map.addLayer(layer);
                }

                setCurrentMapStyle(styleKey);
            }, []);

            // Enhanced GeoJSON Functions
            const loadGeoJSON = useCallback(async (filepath) => {
                if (!filepath.trim()) {
                    addToast('Файл йўлини киритинг', 'error');
                    return;
                }

                try {
                    setGeoJsonStatus('GeoJSON юкланмоқда...');
                    const response = await fetch(filepath);
                    if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);

                    const data = await response.json();
                    if (!data.features || !Array.isArray(data.features)) {
                        throw new Error('Нотўғри GeoJSON формати');
                    }

                    const layerId = filepath.split('/').pop().replace(/\.[^/.]+$/, '');

                    // Remove existing layer if it exists
                    if (geoJsonLayersRef.current.has(layerId)) {
                        const existingLayer = geoJsonLayersRef.current.get(layerId);
                        mapInstanceRef.current.removeLayer(existingLayer.group);
                        geoJsonLayersRef.current.delete(layerId);
                    }

                    const featureGroup = L.featureGroup();
                    let featuresProcessed = 0;

                    // Process features with enhanced styling
                    data.features.forEach(feature => {
                        const layer = createGeoJSONLayer(feature);
                        if (layer) {
                            addGeoJSONPopup(layer, feature.properties);
                            featureGroup.addLayer(layer);
                            featuresProcessed++;
                        }
                    });

                    geoJsonLayersRef.current.set(layerId, {
                        group: featureGroup,
                        visible: true,
                        count: featuresProcessed
                    });

                    mapInstanceRef.current.addLayer(featureGroup);
                    setCounts(prev => ({ ...prev, geojson: prev.geojson + featuresProcessed }));

                    // Fit bounds if this is the first layer
                    if (geoJsonLayersRef.current.size === 1) {
                        try {
                            mapInstanceRef.current.fitBounds(featureGroup.getBounds(), { padding: [20, 20] });
                        } catch (e) {
                            console.warn('Could not fit bounds:', e);
                        }
                    }

                    setGeoJsonStatus(`${featuresProcessed} объект юкланди`);
                    addToast(`GeoJSON муваффақиятли юкланди: ${featuresProcessed} объект`, 'success');

                } catch (error) {
                    console.error('Error loading GeoJSON:', error);
                    setGeoJsonStatus(`Хатолик: ${error.message}`);
                    addToast(`GeoJSON юклашда хатолик: ${error.message}`, 'error');
                }
            }, [addToast]);


            const createGeoJSONLayer = useCallback((feature) => {
                if (!feature.geometry || !feature.geometry.coordinates) return null;

                const geomType = feature.geometry.type;
                const coords = feature.geometry.coordinates;
                const properties = feature.properties || {};

                try {
                    switch (geomType) {
                        case 'Point':
                            const latLng = convertCoordinates(coords);
                            if (!latLng) return null;
                            return L.circleMarker(latLng, {
                                radius: 6,
                                fillColor: getStrategyColor(properties),
                                color: '#fff',
                                weight: 2,
                                opacity: 1,
                                fillOpacity: 0.8
                            });

                        case 'LineString':
                            const latLngs = coords.map(coord => convertCoordinates(coord)).filter(Boolean);
                            if (latLngs.length === 0) return null;
                            return L.polyline(latLngs, {
                                color: getStrategyColor(properties),
                                weight: 3,
                                opacity: 0.8
                            });

                        case 'Polygon':
                            const rings = coords.map(ring =>
                                ring.map(coord => convertCoordinates(coord)).filter(Boolean)
                            ).filter(ring => ring.length > 0);
                            if (rings.length === 0) return null;

                            const polygon = L.polygon(rings, {
                                fillColor: getStrategyColor(properties),
                                weight: 1.5,
                                opacity: 0.8,
                                color: '#ffffff',
                                fillOpacity: 0.7
                            });
                            return polygon;

                        case 'MultiPolygon':
                            const multiLatLngs = coords.map(polygon =>
                                polygon.map(ring =>
                                    ring.map(coord => convertCoordinates(coord)).filter(Boolean)
                                ).filter(ring => ring.length > 0)
                            ).filter(polygon => polygon.length > 0);
                            if (multiLatLngs.length === 0) return null;

                            const multiPolygon = L.polygon(multiLatLngs, {
                                fillColor: getStrategyColor(properties),
                                weight: 1.5,
                                opacity: 0.8,
                                color: '#ffffff',
                                fillOpacity: 0.7
                            });
                            return multiPolygon;

                        default:
                            console.warn('Unsupported geometry type:', geomType);
                            return null;
                    }
                } catch (error) {
                    console.warn('Error creating feature layer:', error);
                    return null;
                }
            }, []);

            const addGeoJSONPopup = useCallback((layer, properties) => {
                if (!properties) return;

                const titleKey = Object.keys(properties).find(key =>
                    ['name', 'title', 'id', 'funksiya', 'function', 'property_name'].includes(key.toLowerCase())
                ) || Object.keys(properties)[0];

                const title = properties[titleKey] || 'GeoJSON объект';
                const strategy = properties.strategiya || properties.strategy || 'Номаълум';

                layer.bindPopup(() => {
                    let content = `
                        <div class="popup-header">${title}</div>
                        <div class="popup-details">
                            <p><strong>Стратегия:</strong>
                                <span class="badge badge-${
                                    strategy === 'Konservatsiya' ? 'conservation' :
                                    strategy === 'Rekonstruktsiya' ? 'reconstruction' :
                                    strategy === 'Yangi_qurilish' ? 'new-construction' :
                                    'investment'
                                }">${strategy}</span>
                            </p>
                    `;

                    // Add other important properties
                    const importantKeys = ['district', 'region_name', 'mahalla_nomi', 'funksiya', 'maydoni'];
                    importantKeys.forEach(key => {
                        if (properties[key]) {
                            const displayKey = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                            let value = properties[key];
                            if (key === 'maydoni') value += ' га';
                            content += `<p><strong>${displayKey}:</strong> ${value}</p>`;
                        }
                    });

                    content += '</div>';
                    return content;
                }, {
                    maxWidth: 400,
                    className: 'geojson-popup'
                });
            }, []);

            const toggleGeoJSONLayer = useCallback((layerId) => {
                const layerData = geoJsonLayersRef.current.get(layerId);
                if (!layerData) return;

                const map = mapInstanceRef.current;
                if (layerData.visible) {
                    map.removeLayer(layerData.group);
                } else {
                    map.addLayer(layerData.group);
                }

                geoJsonLayersRef.current.set(layerId, {
                    ...layerData,
                    visible: !layerData.visible
                });
            }, []);

            const removeGeoJSONLayer = useCallback((layerId) => {
                const layerData = geoJsonLayersRef.current.get(layerId);
                if (!layerData) return;

                mapInstanceRef.current.removeLayer(layerData.group);
                geoJsonLayersRef.current.delete(layerId);
                setCounts(prev => ({ ...prev, geojson: Math.max(0, prev.geojson - 1) }));
                addToast(`${layerId} қатлам ўчирилди`, 'info');
            }, [addToast]);

            const clearAllGeoJSON = useCallback(() => {
                geoJsonLayersRef.current.forEach((layerData) => {
                    mapInstanceRef.current.removeLayer(layerData.group);
                });
                geoJsonLayersRef.current.clear();
                setCounts(prev => ({ ...prev, geojson: 0 }));
                setGeoJsonStatus('Барча GeoJSON қатламлари тозаланди');
                addToast('Барча GeoJSON қатламлари тозаланди', 'info');
            }, [addToast]);

            // Global functions for popup buttons
            window.showDetails = useCallback((id, type) => {
                let item = null;

                // Find the item based on type
                const groups = layerGroupsRef.current;
                if (groups[type]) {
                    groups[type].eachLayer(layer => {
                        if (layer.lotData && (layer.lotData.id === id || layer.lotData.id === `lot-${id}`)) {
                            item = layer.lotData;
                        } else if (layer.itemData) {
                            item = layer.itemData;
                        } else if (layer.auctionData) {
                            item = layer.auctionData;
                        } else if (layer.soldData) {
                            item = layer.soldData;
                        } else if (layer.kmzData) {
                            item = layer.kmzData;
                        }
                    });
                }

                if (item) {
                    setSelectedItem(item);
                    setSidebarOpen(true);
                }
            }, []);

            // Drag and Drop
            const handleDragEnter = useCallback((e) => {
                e.preventDefault();
                e.stopPropagation();
                setDragActive(true);
            }, []);

            const handleDragLeave = useCallback((e) => {
                e.preventDefault();
                e.stopPropagation();
                setDragActive(false);
            }, []);

            const handleDragOver = useCallback((e) => {
                e.preventDefault();
                e.stopPropagation();
            }, []);

            const handleDrop = useCallback(async (e) => {
                e.preventDefault();
                e.stopPropagation();
                setDragActive(false);

                const files = Array.from(e.dataTransfer.files);
                const geoJsonFile = files.find(file =>
                    file.name.toLowerCase().endsWith('.geojson') ||
                    file.name.toLowerCase().endsWith('.json')
                );

                const kmzFile = files.find(file =>
                    file.name.toLowerCase().endsWith('.kmz')
                );

                if (geoJsonFile) {
                    try {
                        const text = await geoJsonFile.text();
                        const data = JSON.parse(text);

                        if (!data.features || !Array.isArray(data.features)) {
                            throw new Error('Нотўғри GeoJSON формати');
                        }

                        const layerId = geoJsonFile.name.replace(/\.[^/.]+$/, '');

                        const featureGroup = L.featureGroup();

                        data.features.forEach(feature => {
                            const layer = createGeoJSONLayer(feature);
                            if (layer) {
                                addGeoJSONPopup(layer, feature.properties);
                                featureGroup.addLayer(layer);
                            }
                        });

                        geoJsonLayersRef.current.set(layerId, {
                            group: featureGroup,
                            visible: true
                        });

                        mapInstanceRef.current.addLayer(featureGroup);
                        setCounts(prev => ({ ...prev, geojson: prev.geojson + 1 }));

                        addToast(`${geoJsonFile.name} муваффақиятли юкланди`, 'success');
                    } catch (error) {
                        addToast(`${geoJsonFile.name} юклашда хатолик: ${error.message}`, 'error');
                    }
                } else if (kmzFile) {
                    try {
                        const geoJSON = await processKMZFile(URL.createObjectURL(kmzFile));

                        if (geoJSON && geoJSON.features) {
                            const kmzGroup = layerGroupsRef.current.kmz;
                            let processed = 0;

                            geoJSON.features.forEach(feature => {
                                const layer = createKMZLayer(feature, {
                                    property_name: kmzFile.name,
                                    id: `dropped-${Date.now()}`
                                });
                                if (layer) {
                                    kmzGroup.addLayer(layer);
                                    processed++;
                                }
                            });

                            setCounts(prev => ({ ...prev, kmz: prev.kmz + processed }));
                            addToast(`${kmzFile.name} юкланди: ${processed} объект`, 'success');
                        }
                    } catch (error) {
                        addToast(`${kmzFile.name} юклашда хатолик: ${error.message}`, 'error');
                    }
                } else {
                    addToast('Фақат GeoJSON (.geojson, .json) ва KMZ файллари қўллаб-қувватланади', 'error');
                }
            }, [createGeoJSONLayer, addGeoJSONPopup, createKMZLayer, addToast]);

            // Data Loading Effect
            useEffect(() => {
                const loadAllData = async () => {
                    if (!mapInstanceRef.current) return;

                    setLoading(true);

                    try {
                        // Load all data sources concurrently
                        const results = await Promise.allSettled([
                            fetchRegularData(),
                            fetchJsonData(),
                            fetchAuctionData(),
                            fetchSoldData()
                        ]);

                        // Count successful loads
                        const successCount = results.filter(result =>
                            result.status === 'fulfilled' && result.value
                        ).length;

                        if (successCount > 0) {
                            // Auto-load default GeoJSON file
                            setTimeout(() => {
                                loadGeoJSON('/tashkent_master_plan.geojson');
                            }, 1000);

                            // Fit map to show all data
                            const allLayers = [];
                            Object.values(layerGroupsRef.current).forEach(group => {
                                group.eachLayer(layer => allLayers.push(layer));
                            });

                            if (allLayers.length > 0) {
                                const group = L.featureGroup(allLayers);
                                try {
                                    mapInstanceRef.current.fitBounds(group.getBounds(), {
                                        padding: [50, 50]
                                    });
                                } catch (e) {
                                    // Fallback to default center
                                    mapInstanceRef.current.setView([41.311, 69.279], 11);
                                }
                            } else {
                                mapInstanceRef.current.setView([41.311, 69.279], 11);
                            }

                            const totalLoaded = Object.values(counts).reduce((a, b) => a + b, 0);
                            addToast(`Жами юкланди: ${totalLoaded} маълумот`, 'success');
                        } else {
                            addToast('Ҳеч қандай маълумот юкланмади. Серверни текширинг.', 'warning');
                            mapInstanceRef.current.setView([41.311, 69.279], 11);
                        }
                    } catch (error) {
                        console.error('Error during data loading:', error);
                        addToast('Ишга туширишда хатолик', 'error');
                        mapInstanceRef.current.setView([41.311, 69.279], 11);
                    } finally {
                        setLoading(false);
                    }
                };

                // Initialize map first, then load data
                if (mapRef.current && !mapInstanceRef.current) {
                    initializeMap();
                    setTimeout(loadAllData, 100); // Small delay to ensure map is ready
                }
            }, [
                initializeMap,
                fetchRegularData,
                fetchJsonData,
                fetchAuctionData,
                fetchSoldData,
                loadGeoJSON,
                addToast,
                counts
            ]);

            // Memoized components
            const memoizedLayerControls = useMemo(() => (
                React.createElement(LayerControls, {
                    layers: layers,
                    onToggle: toggleLayer,
                    counts: counts
                })
            ), [layers, counts, toggleLayer]);

            const memoizedMapStyleControls = useMemo(() => (
                React.createElement(MapStyleControls, {
                    currentStyle: currentMapStyle,
                    onStyleChange: changeMapStyle
                })
            ), [currentMapStyle, changeMapStyle]);

            const memoizedGeoJSONControls = useMemo(() => (
                React.createElement(GeoJSONControls, {
                    geoJsonLayers: geoJsonLayersRef.current,
                    onLoad: () => loadGeoJSON(geoJsonFilepath),
                    onToggle: toggleGeoJSONLayer,
                    onRemove: removeGeoJSONLayer,
                    onClear: clearAllGeoJSON,
                    status: geoJsonStatus,
                    filepath: geoJsonFilepath,
                    setFilepath: setGeoJsonFilepath
                })
            ), [
                geoJsonFilepath,
                geoJsonStatus,
                loadGeoJSON,
                toggleGeoJSONLayer,
                removeGeoJSONLayer,
                clearAllGeoJSON
            ]);

            return React.createElement('div', { className: 'app-container' },
                // Header
                React.createElement('header', { className: 'app-header' },
                    React.createElement('div', { className: 'app-logo' },
                        React.createElement('i', { className: 'fas fa-map-marked-alt fa-2x' }),
                        React.createElement('div', { className: 'app-title' }, TEXTS.appTitle)
                    ),
                    React.createElement('div', { className: 'header-controls' },
                        React.createElement('div', { className: 'lang-switcher' },
                            React.createElement('button', { className: 'lang-btn active' }, 'УЗ'),
                            React.createElement('button', { className: 'lang-btn' }, 'RU'),
                            React.createElement('button', { className: 'lang-btn' }, 'EN')
                        )
                    )
                ),

                // Main Content
                React.createElement('div', { className: 'main-content' },
                    React.createElement('div', { className: 'map-container' },
                        // Map
                        React.createElement('div', {
                            ref: mapRef,
                            id: 'map',
                            onDragEnter: handleDragEnter,
                            onDragLeave: handleDragLeave,
                            onDragOver: handleDragOver,
                            onDrop: handleDrop
                        }),

                        // Drag Overlay
                        React.createElement('div', { className: `drag-overlay ${dragActive ? 'active' : ''}` },
                            React.createElement('div', null,
                                React.createElement('i', { className: 'fas fa-upload fa-3x', style: { marginBottom: '20px' } }),
                                React.createElement('div', null, TEXTS.dropFiles)
                            )
                        ),

                        // Control Panels
                        memoizedMapStyleControls,
                        memoizedLayerControls,
                        memoizedGeoJSONControls
                    ),

                    // Sidebar
                    React.createElement(Sidebar, {
                        isOpen: sidebarOpen,
                        onClose: () => setSidebarOpen(false),
                        item: selectedItem
                    })
                ),

                // Loading Overlay
                React.createElement(Loading, { show: loading }),

                // Toast Notifications
                React.createElement(Toast, { toasts: toasts, removeToast: removeToast })
            );
        };

        // Render the app using React 18's createRoot
        const root = createRoot(document.getElementById('root'));
        root.render(React.createElement(InvestUzMap));
    </script>
</body>
</html>
