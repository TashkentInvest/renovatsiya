<!DOCTYPE html>
<html lang="uz">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>ИнвестУз - Интерактив харита</title>

        <!-- Leaflet CSS -->
        <link
            rel="stylesheet"
            href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        />
        <link
            rel="stylesheet"
            href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css"
        />
        <link
            rel="stylesheet"
            href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css"
        />

        <!-- Font Awesome -->
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        />

        <style>
  /* Government Official Blinker Animation */
.blinker-overlay {
    position: absolute;
    pointer-events: none;
    z-index: 1000;
    border: 5px solid #1e3a8a;
    border-radius: 12px;
    background: linear-gradient(135deg, rgba(30, 58, 138, 0.15), rgba(59, 130, 246, 0.1));
    animation: officialBlink 3s ease-in-out;
    box-shadow:
        0 0 20px rgba(30, 58, 138, 0.4),
        inset 0 0 20px rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(2px);
}

@keyframes officialBlink {
    0% {
        opacity: 0;
        transform: scale(0.8);
        border-color: #1e3a8a;
        box-shadow:
            0 0 30px rgba(30, 58, 138, 0.8),
            inset 0 0 20px rgba(255, 255, 255, 0.2);
    }
    20% {
        opacity: 0.9;
        transform: scale(1.05);
        border-color: #f59e0b;
        box-shadow:
            0 0 40px rgba(245, 158, 11, 0.9),
            inset 0 0 25px rgba(255, 255, 255, 0.3);
    }
    40% {
        opacity: 1;
        transform: scale(1);
        border-color: #dc2626;
        box-shadow:
            0 0 35px rgba(220, 38, 38, 0.8),
            inset 0 0 30px rgba(255, 255, 255, 0.2);
    }
    60% {
        opacity: 0.95;
        transform: scale(1.02);
        border-color: #059669;
        box-shadow:
            0 0 45px rgba(5, 150, 105, 0.7),
            inset 0 0 25px rgba(255, 255, 255, 0.25);
    }
    80% {
        opacity: 0.8;
        transform: scale(1);
        border-color: #3b82f6;
        box-shadow:
            0 0 35px rgba(59, 130, 246, 0.6),
            inset 0 0 20px rgba(255, 255, 255, 0.15);
    }
    100% {
        opacity: 0;
        transform: scale(0.95);
        border-color: #1e3a8a;
        box-shadow:
            0 0 20px rgba(30, 58, 138, 0.3),
            inset 0 0 15px rgba(255, 255, 255, 0.1);
    }
}

/* Government Official Search Counter */
.search-results-counter {
    background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 50%, #1e40af 100%);
    color: #ffffff;
    padding: 12px 20px;
    border-radius: 8px;
    font-family: 'Arial', 'Segoe UI', sans-serif;
    font-size: 13px;
    font-weight: 700;
    margin-bottom: 15px;
    text-align: center;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    box-shadow:
        0 4px 12px rgba(30, 58, 138, 0.3),
        0 2px 4px rgba(0, 0, 0, 0.1);
    border: 2px solid rgba(255, 255, 255, 0.2);
    position: relative;
    overflow: hidden;
}

.search-results-counter::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 2px;
    background: linear-gradient(90deg, #f59e0b 0%, #ffffff 50%, #10b981 100%);
}

.search-results-counter i {
    margin-right: 8px;
    font-size: 14px;
    color: #f59e0b;
}

/* Government Official Result Items */
.result-item {
    position: relative;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    margin-bottom: 8px;
    background: linear-gradient(135deg, #ffffff 0%, #f9fafb 100%);
    overflow: hidden;
}

.result-item::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 4px;
    background: linear-gradient(180deg, #1e3a8a, #3b82f6);
    transform: scaleY(0);
    transition: transform 0.3s ease;
}

.result-item:hover {
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    transform: translateY(-2px);
    box-shadow:
        0 8px 25px rgba(30, 58, 138, 0.15),
        0 4px 10px rgba(0, 0, 0, 0.1);
    border-color: #3b82f6;
}

.result-item:hover::before {
    transform: scaleY(1);
}

.result-main {
    font-weight: 700;
    color: #1e3a8a;
    font-size: 14px;
    margin-bottom: 6px;
    text-transform: uppercase;
    letter-spacing: 0.3px;
}

.result-details {
    font-size: 12px;
    color: #4b5563;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

/* Government Official Zoom Button */
.zoom-btn {
    background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 50%, #1e40af 100%);
    color: #ffffff;
    border: 2px solid rgba(255, 255, 255, 0.3);
    padding: 8px 16px;
    border-radius: 6px;
    font-size: 11px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    box-shadow:
        0 3px 8px rgba(30, 58, 138, 0.3),
        inset 0 1px 2px rgba(255, 255, 255, 0.2);
    position: relative;
    overflow: hidden;
}

.zoom-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    transition: left 0.5s ease;
}

.zoom-btn:hover {
    background: linear-gradient(135deg, #f59e0b 0%, #ffee04 50%, #f59e0b 100%);
    transform: translateY(-3px);
    box-shadow:
        0 6px 15px rgba(245, 158, 11, 0.4),
        0 3px 8px rgba(0, 0, 0, 0.15),
        inset 0 1px 2px rgba(255, 255, 255, 0.3);
    border-color: rgba(255, 255, 255, 0.5);
}

.zoom-btn:hover::before {
    left: 100%;
}

.zoom-btn:active {
    transform: translateY(-1px);
    box-shadow:
        0 3px 8px rgba(245, 158, 11, 0.3),
        inset 0 2px 4px rgba(0, 0, 0, 0.1);
}

.zoom-btn i {
    margin-right: 6px;
    font-size: 12px;
}

/* Government Official No Results */
.no-results {
    padding: 24px;
    text-align: center;
    color: #6b7280;
    font-size: 14px;
    font-weight: 600;
    background: linear-gradient(135deg, #f9fafb, #f3f4f6);
    border: 2px dashed #d1d5db;
    border-radius: 8px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* Government Official Loading */
.loading-text {
    padding: 20px;
    text-align: center;
    color: #1e3a8a;
    font-size: 14px;
    font-weight: 700;
    background: linear-gradient(135deg, #dbeafe, #eff6ff);
    border: 1px solid #3b82f6;
    border-radius: 8px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    position: relative;
}

.loading-text::after {
    content: '...';
    animation: loadingDots 1.5s infinite;
}

@keyframes loadingDots {
    0%, 20% { opacity: 0; }
    50% { opacity: 1; }
    100% { opacity: 0; }
}

/* Government Badge Styles for Results */
.badge {
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    padding: 4px 8px;
    border-radius: 4px;
    border: 1px solid rgba(255, 255, 255, 0.3);
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

/* Responsive Government Design */
@media (max-width: 768px) {
    .search-results-counter {
        font-size: 12px;
        padding: 10px 16px;
    }

    .result-item {
        margin-bottom: 6px;
    }

    .zoom-btn {
        padding: 6px 12px;
        font-size: 10px;
    }

    .blinker-overlay {
        border-width: 3px;
    }
}
            /* Government Style Variables */
            :root {
                --primary-blue: #1e3a8a;
                --secondary-blue: #3b82f6;
                --accent-gold: #f59e0b;
                --success-green: #10b981;
                --warning-orange: #f97316;
                --error-red: #ef4444;
                --red-line-color: #dc2626;
                --white: #ffffff;
                --gray-50: #f9fafb;
                --gray-100: #f3f4f6;
                --gray-200: #e5e7eb;
                --gray-300: #d1d5db;
                --gray-400: #9ca3af;
                --gray-500: #6b7280;
                --gray-600: #4b5563;
                --gray-700: #374151;
                --gray-800: #1f2937;
                --gray-900: #111827;
                --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1),
                    0 4px 6px -2px rgba(0, 0, 0, 0.05);
                --shadow-lg: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
                --border-radius: 8px;
                --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }

            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family: "Inter", "Segoe UI", Tahoma, Geneva, Verdana,
                    sans-serif;
                background: var(--gray-50);
                overflow: hidden;
                color: var(--gray-900);
            }

            /* Government Header with Uzbek Flag Colors */
            .app-header {
                background: linear-gradient(
                    135deg,
                    var(--primary-blue) 0%,
                    var(--secondary-blue) 100%
                );
                color: var(--white);
                padding: 0 24px;
                height: 70px;
                display: flex;
                align-items: center;
                justify-content: space-between;
                box-shadow: var(--shadow);
                z-index: 1000;
                position: relative;
            }

            .uzbek-flag-stripe {
                position: absolute;
                bottom: 0;
                left: 0;
                right: 0;
                height: 4px;
                background: linear-gradient(
                    90deg,
                    #0099cc 0%,
                    #0099cc 33.33%,
                    #ffffff 33.33%,
                    #ffffff 66.66%,
                    #1eb53a 66.66%,
                    #1eb53a 100%
                );
            }

            .app-logo {
                display: flex;
                align-items: center;
                gap: 16px;
            }

            .logo-icon {
                width: 48px;
                height: 48px;
                background: linear-gradient(
                    135deg,
                    var(--accent-gold),
                    #ffee04
                );
                border-radius: 12px;
                display: flex;
                align-items: center;
                justify-content: center;
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            }

            .logo-icon i {
                font-size: 24px;
                color: var(--white);
            }

            .app-title {
                font-size: 24px;
                font-weight: 700;
                letter-spacing: -0.025em;
            }

            .app-subtitle {
                font-size: 14px;
                opacity: 0.9;
                font-weight: 400;
            }

            .header-controls {
                display: flex;
                align-items: center;
                gap: 20px;
            }

            .lang-switcher {
                display: flex;
                background: rgba(255, 255, 255, 0.1);
                border-radius: 25px;
                overflow: hidden;
                backdrop-filter: blur(10px);
            }

            .lang-btn {
                padding: 8px 16px;
                background: transparent;
                border: none;
                color: var(--white);
                cursor: pointer;
                transition: var(--transition);
                font-size: 14px;
                font-weight: 500;
            }

            .lang-btn.active {
                background: rgba(255, 255, 255, 0.2);
                backdrop-filter: blur(10px);
            }

            .lang-btn:hover {
                background: rgba(255, 255, 255, 0.15);
            }

            /* Main Layout */
            .main-content {
                height: calc(100vh - 70px);
                position: relative;
                display: flex;
            }

            .map-container {
                flex: 1;
                position: relative;
            }

            #map {
                width: 100%;
                height: 100%;
            }

            /* Enhanced Control Panels */
            .control-panel {
                position: absolute;
                background: var(--white);
                border-radius: var(--border-radius);
                box-shadow: var(--shadow-lg);
                z-index: 1000;
                max-height: 80vh;
                overflow-y: auto;
                backdrop-filter: blur(10px);
                border: 1px solid var(--gray-200);
            }

            .layer-controls {
                top: 20px;
                right: 20px;
                width: 320px;
                padding: 24px;
            }

            .map-style-controls {
                top: 90px;
                left: 20px;
                width: 200px;
                padding: 20px;
            }

            .geojson-controls {
                bottom: 20px;
                left: 20px;
                width: 340px;
                padding: 24px;
            }

            /* Location Search Control */
            .location-search-control {
                top: 20px;
                left: 610px;
                width: 350px;
                padding: 20px;
            }

            /* KMZ Search Control */
            .kmz-search-control {
                top: 20px;
                left: 240px;
                width: 350px;
                padding: 20px;
            }

            .search-title {
                font-size: 16px;
                font-weight: 600;
                margin-bottom: 16px;
                color: var(--gray-900);
                display: flex;
                align-items: center;
                gap: 8px;
                padding-bottom: 12px;
                border-bottom: 2px solid var(--gray-100);
            }

            .search-title i {
                color: var(--primary-blue);
            }

            .search-input {
                width: 100%;
                padding: 10px 12px;
                border: 2px solid var(--gray-200);
                border-radius: var(--border-radius);
                font-size: 14px;
                margin-bottom: 12px;
                outline: none;
                transition: var(--transition);
            }

            .search-input:focus {
                border-color: var(--secondary-blue);
                box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            }

            .results-container {
                max-height: 200px;
                overflow-y: auto;
                border: 1px solid var(--gray-200);
                border-radius: var(--border-radius);
                background: var(--white);
                display: none;
            }

            .results-container.show {
                display: block;
            }

            .result-item {
                padding: 10px 12px;
                cursor: pointer;
                border-bottom: 1px solid var(--gray-100);
                transition: var(--transition);
                font-size: 13px;
            }

            .result-item:hover {
                background-color: var(--gray-50);
            }

            .result-item:last-child {
                border-bottom: none;
            }

            .result-main {
                font-weight: 500;
                color: var(--gray-900);
                margin-bottom: 4px;
            }

            .result-details {
                color: var(--gray-600);
                font-size: 12px;
                display: flex;
                align-items: center;
                justify-content: space-between;
            }

            .zoom-btn {
                background: var(--secondary-blue);
                color: var(--white);
                border: none;
                padding: 4px 8px;
                border-radius: 4px;
                font-size: 11px;
                cursor: pointer;
                transition: var(--transition);
            }

            .zoom-btn:hover {
                background: var(--primary-blue);
                transform: translateY(-1px);
            }

            .no-results {
                padding: 16px;
                text-align: center;
                color: var(--gray-500);
                font-size: 14px;
            }

            .loading-text {
                padding: 16px;
                text-align: center;
                color: var(--gray-500);
                font-size: 14px;
            }

            .stats-info {
                font-size: 12px;
                color: var(--gray-600);
                margin-top: 8px;
                padding-top: 8px;
                border-top: 1px solid var(--gray-100);
            }

            .control-title {
                font-size: 18px;
                font-weight: 600;
                margin-bottom: 20px;
                color: var(--gray-900);
                display: flex;
                align-items: center;
                gap: 10px;
                padding-bottom: 12px;
                border-bottom: 2px solid var(--gray-100);
            }

            .control-title i {
                color: var(--primary-blue);
            }

            /* Enhanced Layer Buttons */
            .layer-button {
                width: 100%;
                padding: 16px 20px;
                background: var(--white);
                border: 2px solid var(--gray-200);
                border-radius: var(--border-radius);
                cursor: pointer;
                transition: var(--transition);
                margin-bottom: 12px;
                display: flex;
                align-items: center;
                justify-content: space-between;
                font-size: 14px;
                font-weight: 500;
                position: relative;
                overflow: hidden;
            }

            .layer-button::before {
                content: "";
                position: absolute;
                top: 0;
                left: -100%;
                width: 100%;
                height: 100%;
                background: linear-gradient(
                    90deg,
                    transparent,
                    rgba(59, 130, 246, 0.1),
                    transparent
                );
                transition: left 0.5s;
            }

            .layer-button:hover::before {
                left: 100%;
            }

            .layer-button:hover {
                border-color: var(--secondary-blue);
                background: var(--gray-50);
                transform: translateY(-2px);
                box-shadow: var(--shadow);
            }

            .layer-button.active {
                background: linear-gradient(
                    135deg,
                    var(--primary-blue),
                    var(--secondary-blue)
                );
                color: var(--white);
                border-color: var(--primary-blue);
                transform: translateY(-1px);
                box-shadow: var(--shadow);
            }

            .layer-button-content {
                display: flex;
                align-items: center;
                gap: 12px;
            }

            .layer-icon {
                width: 20px;
                height: 20px;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .count-badge {
                background: linear-gradient(135deg, var(--error-red), #dc2626);
                color: var(--white);
                padding: 4px 10px;
                border-radius: 12px;
                font-size: 11px;
                font-weight: 600;
                min-width: 24px;
                text-align: center;
                box-shadow: 0 2px 4px rgba(239, 68, 68, 0.3);
            }

            .layer-button.active .count-badge {
                background: rgba(255, 255, 255, 0.2);
                backdrop-filter: blur(5px);
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            }

            /* Map Style Controls */
            .style-button {
                width: 100%;
                padding: 12px 16px;
                background: var(--white);
                border: 2px solid var(--gray-200);
                border-radius: var(--border-radius);
                cursor: pointer;
                transition: var(--transition);
                margin-bottom: 10px;
                font-size: 14px;
                font-weight: 500;
                text-align: center;
                position: relative;
                overflow: hidden;
            }

            .style-button::before {
                content: "";
                position: absolute;
                top: 0;
                left: -100%;
                width: 100%;
                height: 100%;
                background: linear-gradient(
                    90deg,
                    transparent,
                    rgba(245, 158, 11, 0.1),
                    transparent
                );
                transition: left 0.5s;
            }

            .style-button:hover::before {
                left: 100%;
            }

            .style-button:hover {
                border-color: var(--accent-gold);
                transform: translateY(-1px);
                box-shadow: var(--shadow);
            }

            .style-button.active {
                background: linear-gradient(
                    135deg,
                    var(--accent-gold),
                    #f59e0b
                );
                color: var(--white);
                border-color: var(--accent-gold);
                box-shadow: var(--shadow);
            }

            /* GeoJSON Controls */
            .file-input-group {
                margin-bottom: 20px;
            }

            .file-input {
                width: 100%;
                padding: 12px 16px;
                border: 2px solid var(--gray-200);
                border-radius: var(--border-radius);
                font-size: 14px;
                margin-bottom: 12px;
                transition: var(--transition);
                background: var(--white);
                display: none !important;
            }

            .file-input:focus {
                outline: none;
                border-color: var(--secondary-blue);
                box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            }

            .button-group {
                display: flex;
                gap: 12px;
            }

            .primary-btn {
                flex: 1;
                padding: 12px 16px;
                background: linear-gradient(
                    135deg,
                    var(--secondary-blue),
                    var(--primary-blue)
                );
                color: var(--white);
                border: none;
                border-radius: var(--border-radius);
                cursor: pointer;
                transition: var(--transition);
                font-size: 14px;
                font-weight: 500;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 8px;
            }

            .primary-btn:hover {
                transform: translateY(-2px);
                box-shadow: var(--shadow);
            }

            .secondary-btn {
                flex: 1;
                padding: 12px 16px;
                background: var(--white);
                color: var(--error-red);
                border: 2px solid var(--error-red);
                border-radius: var(--border-radius);
                cursor: pointer;
                transition: var(--transition);
                font-size: 14px;
                font-weight: 500;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 8px;
            }

            .secondary-btn:hover {
                background: var(--error-red);
                color: var(--white);
                transform: translateY(-2px);
                box-shadow: var(--shadow);
            }

            .status-text {
                font-size: 12px;
                color: var(--gray-600);
                background: var(--gray-50);
                padding: 10px;
                border-radius: var(--border-radius);
                margin-top: 12px;
                border-left: 4px solid var(--secondary-blue);
            }

            /* Enhanced Legend */
            .legend {
                background: var(--white);
                border-radius: var(--border-radius);
                padding: 20px;
                margin-top: 20px;
                border: 1px solid var(--gray-200);
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            }

            .legend-title {
                font-size: 16px;
                font-weight: 600;
                margin-bottom: 16px;
                color: var(--gray-900);
                display: flex;
                align-items: center;
                gap: 8px;
            }

            .legend-item {
                display: flex;
                align-items: center;
                gap: 12px;
                margin-bottom: 8px;
                font-size: 13px;
                padding: 8px;
                border-radius: var(--border-radius);
                transition: var(--transition);
            }

            .legend-item:hover {
                background: var(--gray-50);
            }

            .legend-color {
                width: 20px;
                height: 20px;
                border-radius: 4px;
                border: 2px solid var(--white);
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            }

            /* Enhanced Statistics Panel */
            .stats-panel {
                background: linear-gradient(
                    135deg,
                    var(--gray-50),
                    var(--white)
                );
                border-radius: var(--border-radius);
                padding: 20px;
                margin-top: 20px;
                border: 1px solid var(--gray-200);
            }

            .stats-title {
                font-size: 16px;
                font-weight: 600;
                margin-bottom: 16px;
                color: var(--gray-900);
                display: flex;
                align-items: center;
                gap: 8px;
            }

            .stats-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 12px;
                font-size: 13px;
            }

            .stats-item {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 8px 12px;
                background: var(--white);
                border-radius: var(--border-radius);
                border: 1px solid var(--gray-200);
                transition: var(--transition);
            }

            .stats-item:hover {
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            }

            .stats-label {
                color: var(--gray-600);
                font-weight: 500;
            }

            .stats-value {
                font-weight: 600;
                color: var(--gray-900);
                background: var(--gray-50);
                padding: 2px 8px;
                border-radius: 4px;
            }

            /* Enhanced Sidebar */
            .sidebar {
                position: fixed;
                top: 70px;
                right: -420px;
                width: 400px;
                height: calc(100vh - 70px);
                background: var(--white);
                box-shadow: var(--shadow-lg);
                z-index: 1001;
                transition: right 0.4s cubic-bezier(0.4, 0, 0.2, 1);
                overflow-y: auto;
                border-left: 1px solid var(--gray-200);
            }

            .sidebar.open {
                right: 0;
            }

            .sidebar-header {
                padding: 24px;
                background: linear-gradient(
                    135deg,
                    var(--primary-blue),
                    var(--secondary-blue)
                );
                color: var(--white);
                border-bottom: 1px solid var(--gray-200);
                display: flex;
                justify-content: space-between;
                align-items: center;
                position: sticky;
                top: 0;
                z-index: 10;
            }

            .sidebar-title {
                font-size: 20px;
                font-weight: 600;
                max-width: 320px;
                overflow: hidden;
                text-overflow: ellipsis;
                line-height: 1.3;
            }

            .close-btn {
                background: rgba(255, 255, 255, 0.1);
                border: none;
                font-size: 20px;
                cursor: pointer;
                color: var(--white);
                padding: 8px;
                border-radius: var(--border-radius);
                transition: var(--transition);
                backdrop-filter: blur(10px);
            }

            .close-btn:hover {
                background: rgba(255, 255, 255, 0.2);
                transform: rotate(90deg);
            }

            .sidebar-content {
                padding: 24px;
            }

            .section {
                margin-bottom: 32px;
            }

            .section-title {
                font-size: 18px;
                font-weight: 600;
                margin-bottom: 16px;
                color: var(--gray-900);
                padding-bottom: 8px;
                border-bottom: 2px solid var(--gray-100);
                display: flex;
                align-items: center;
                gap: 8px;
            }

            .info-table {
                width: 100%;
                border-collapse: collapse;
            }

            .info-table td {
                padding: 12px 0;
                font-size: 14px;
                border-bottom: 1px solid var(--gray-100);
                vertical-align: top;
            }

            .info-table td:first-child {
                font-weight: 600;
                color: var(--gray-600);
                width: 40%;
                padding-right: 16px;
            }

            .info-table td:last-child {
                color: var(--gray-900);
            }

            /* Enhanced Badges */
            .badge {
                display: inline-block;
                padding: 6px 12px;
                border-radius: 20px;
                font-size: 12px;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.025em;
            }

            .badge-renovation {
                background: linear-gradient(135deg, #f3e8ff, #e9d5ff);
                color: #7c3aed;
                border: 1px solid #c4b5fd;
            }

            .badge-investment {
                background: linear-gradient(135deg, #dbeafe, #bfdbfe);
                color: #2563eb;
                border: 1px solid #93c5fd;
            }

            .badge-auction {
                background: linear-gradient(135deg, #fed7aa, #fdba74);
                color: #ea580c;
                border: 1px solid #fb923c;
            }

            .badge-sold {
                background: linear-gradient(135deg, #dcfce7, #bbf7d0);
                color: #16a34a;
                border: 1px solid #86efac;
            }

            .badge-conservation {
                background: linear-gradient(135deg, #e0f2fe, #b3e5fc);
                color: #0277bd;
                border: 1px solid #4fc3f7;
            }

            .badge-reconstruction {
                background: linear-gradient(135deg, #fff3e0, #ffe0b2);
                color: #f57c00;
                border: 1px solid #ffb74d;
            }

            .badge-new-construction {
                background: linear-gradient(135deg, #f3e5f5, #e1bee7);
                color: #8e24aa;
                border: 1px solid #ce93d8;
            }

            .badge-red-line {
                background: linear-gradient(135deg, #fef2f2, #fecaca);
                color: var(--red-line-color);
                border: 1px solid #fca5a5;
            }

            /* Enhanced Loading */
            .loading-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(255, 255, 255, 0.95);
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                z-index: 2000;
                backdrop-filter: blur(5px);
            }

            .loading-content {
                text-align: center;
            }

            .loading-spinner {
                width: 60px;
                height: 60px;
                border: 4px solid var(--gray-200);
                border-top: 4px solid var(--secondary-blue);
                border-radius: 50%;
                animation: spin 1s linear infinite;
                margin-bottom: 20px;
            }

            .loading-text {
                font-size: 18px;
                font-weight: 500;
                color: var(--gray-700);
                margin-bottom: 8px;
            }

            .loading-subtext {
                font-size: 14px;
                color: var(--gray-500);
            }

            @keyframes spin {
                0% {
                    transform: rotate(0deg);
                }
                100% {
                    transform: rotate(360deg);
                }
            }

            /* Enhanced Toast */
            .toast-container {
                position: fixed;
                bottom: 20px;
                left: 50%;
                transform: translateX(-50%);
                z-index: 2001;
                display: flex;
                flex-direction: column;
                gap: 12px;
            }

            .toast {
                padding: 16px 24px;
                border-radius: var(--border-radius);
                margin-bottom: 10px;
                color: var(--white);
                font-size: 14px;
                font-weight: 500;
                box-shadow: var(--shadow-lg);
                animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.1);
                display: flex;
                align-items: center;
                gap: 12px;
                cursor: pointer;
                transition: var(--transition);
            }

            .toast:hover {
                transform: translateY(-2px);
            }

            .toast.info {
                background: linear-gradient(
                    135deg,
                    var(--secondary-blue),
                    var(--primary-blue)
                );
            }

            .toast.success {
                background: linear-gradient(
                    135deg,
                    var(--success-green),
                    #059669
                );
            }

            .toast.warning {
                background: linear-gradient(
                    135deg,
                    var(--warning-orange),
                    var(--accent-gold)
                );
            }

            .toast.error {
                background: linear-gradient(135deg, var(--error-red), #dc2626);
            }

            @keyframes slideUp {
                from {
                    transform: translateY(100%);
                    opacity: 0;
                }
                to {
                    transform: translateY(0);
                    opacity: 1;
                }
            }

            /* Drag and Drop */
            .drag-overlay {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: linear-gradient(
                    135deg,
                    rgba(59, 130, 246, 0.1),
                    rgba(30, 58, 138, 0.1)
                );
                border: 3px dashed var(--secondary-blue);
                display: none;
                align-items: center;
                justify-content: center;
                z-index: 1500;
                font-size: 24px;
                color: var(--secondary-blue);
                font-weight: 600;
                backdrop-filter: blur(5px);
                border-radius: var(--border-radius);
                margin: 20px;
            }

            .drag-overlay.active {
                display: flex;
            }

            .drag-content {
                text-align: center;
                padding: 40px;
                background: var(--white);
                border-radius: var(--border-radius);
                box-shadow: var(--shadow-lg);
            }

            /* Enhanced Popup Styles */
            .leaflet-popup-content {
                margin: 16px 20px;
                font-size: 14px;
                line-height: 1.5;
            }

            .popup-header {
                font-size: 18px;
                font-weight: 600;
                margin-bottom: 12px;
                color: var(--gray-900);
                border-bottom: 2px solid var(--gray-100);
                padding-bottom: 8px;
            }

            .popup-image {
                width: 100%;
                max-height: 150px;
                object-fit: cover;
                border-radius: var(--border-radius);
                margin-bottom: 12px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            }

            .popup-details {
                font-size: 13px;
                line-height: 1.4;
            }

            .popup-details p {
                margin: 6px 0;
            }

            .popup-details strong {
                color: var(--gray-700);
                font-weight: 600;
            }

            .details-btn {
                margin-top: 12px;
                padding: 10px 16px;
                background: linear-gradient(
                    135deg,
                    var(--secondary-blue),
                    var(--primary-blue)
                );
                color: var(--white);
                border: none;
                border-radius: var(--border-radius);
                cursor: pointer;
                font-size: 13px;
                font-weight: 500;
                transition: var(--transition);
                width: 100%;
            }

            .details-btn:hover {
                transform: translateY(-1px);
                box-shadow: var(--shadow);
            }

            /* Layer List */
            .layer-list {
                max-height: 250px;
                overflow-y: auto;
                margin-top: 20px;
            }

            .layer-item {
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 12px 16px;
                background: var(--gray-50);
                border-radius: var(--border-radius);
                margin-bottom: 10px;
                font-size: 13px;
                border: 1px solid var(--gray-200);
                transition: var(--transition);
            }

            .layer-item:hover {
                background: var(--white);
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            }

            .layer-name {
                flex: 1;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
                font-weight: 500;
                color: var(--gray-900);
            }

            .layer-actions {
                display: flex;
                gap: 8px;
            }

            .action-btn {
                padding: 6px 10px;
                border: none;
                border-radius: var(--border-radius);
                cursor: pointer;
                font-size: 11px;
                font-weight: 500;
                transition: var(--transition);
            }

            .toggle-btn {
                background: var(--success-green);
                color: var(--white);
            }

            .toggle-btn.hidden {
                background: var(--gray-400);
            }

            .toggle-btn:hover {
                transform: translateY(-1px);
            }

            .remove-btn {
                background: var(--error-red);
                color: var(--white);
            }

            .remove-btn:hover {
                transform: translateY(-1px);
                background: #dc2626;
            }

            /* Custom marker styles */
            .custom-marker {
                background: none !important;
                border: none !important;
            }

            .marker-icon {
                width: 16px;
                height: 16px;
                border-radius: 50%;
                border: 3px solid var(--white);
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            }

            .marker-renovation {
                background: #7c3aed;
            }

            .marker-investment {
                background: #2563eb;
            }

            .marker-auction {
                background: #ea580c;
            }

            .marker-sold {
                background: #dc2626;
            }

            .marker-regular {
                background: #059669;
            }

            .marker-kmz {
                background: #f59e0b;
            }

            .marker-conservation {
                background: #0277bd;
            }

            .marker-reconstruction {
                background: #f57c00;
            }

            .marker-new-construction {
                background: #8e24aa;
            }

            /* Custom scrollbar */
            .control-panel::-webkit-scrollbar,
            .sidebar::-webkit-scrollbar,
            .layer-list::-webkit-scrollbar,
            .results-container::-webkit-scrollbar {
                width: 6px;
            }

            .control-panel::-webkit-scrollbar-track,
            .sidebar::-webkit-scrollbar-track,
            .layer-list::-webkit-scrollbar-track,
            .results-container::-webkit-scrollbar-track {
                background: var(--gray-100);
                border-radius: 3px;
            }

            .control-panel::-webkit-scrollbar-thumb,
            .sidebar::-webkit-scrollbar-thumb,
            .layer-list::-webkit-scrollbar-thumb,
            .results-container::-webkit-scrollbar-thumb {
                background: var(--gray-300);
                border-radius: 3px;
            }

            .control-panel::-webkit-scrollbar-thumb:hover,
            .sidebar::-webkit-scrollbar-thumb:hover,
            .layer-list::-webkit-scrollbar-thumb:hover,
            .results-container::-webkit-scrollbar-thumb:hover {
                background: var(--gray-400);
            }

            /* Responsive Design */
            @media (max-width: 768px) {
                .app-title {
                    font-size: 18px;
                }

                .app-subtitle {
                    display: none;
                }

                .layer-controls,
                .geojson-controls,
                .kmz-search-control {
                    width: 300px;
                    right: 10px;
                    padding: 20px;
                }

                .map-style-controls {
                    width: 180px;
                    left: 10px;
                    padding: 16px;
                }

                .sidebar {
                    width: 100%;
                    right: -100%;
                }

                .control-panel {
                    max-height: 60vh;
                }

                .stats-grid {
                    grid-template-columns: 1fr;
                }
            }
        </style>
    </head>
    <body>
        <div id="root"></div>

        <!-- External Scripts -->
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
        <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
        <script src="https://unpkg.com/jszip@3.10.1/dist/jszip.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/togeojson/0.16.0/togeojson.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.8.0/proj4.min.js"></script>
        <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
        <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
        <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

        <script type="text/babel">
            const { useState, useEffect, useRef, useCallback, useMemo } = React;
            const { createRoot } = ReactDOM;

            // Enhanced Uzbek Cyrillic translations
            const TEXTS = {
                appTitle: "ИнвестУз - Интерактив харита",
                appSubtitle: "Тошкент шаҳар ҳокимлиги",
                mapLayers: "Харита қатламлари",
                mapStyle: "Харита услуби",
                geojsonManager: "GeoJSON бошқарув",
                apiData: "API маълумотлар",
                jsonData: "Минстрой маълумотлар",
                auctions: "Аукционлар",
                soldProperties: "Сотилган мулклар",
                kmzData: "TIC (Реновация)",
                renovatsiyaProjects: "Реновация лойихалари",
                kmzSearch: "KMZ Қидириш ва Танлаш",
                geojsonLayers: "GeoJSON қатламлари",
                strategyLayers: "Стратегия қатламлари",
                standard: "Стандарт",
                satellite: "Сунъий йўлдош",
                hybrid: "Гибрид",
                load: "Юклаш",
                clearAll: "Ҳаммасини тозалаш",
                hide: "Яшириш",
                show: "Кўрсатиш",
                remove: "✕",
                total: "Жами",
                visible: "Кўринадиган",
                objectDetails: "Объект тафсилотлари",
                basicInfo: "Асосий маълумотлар",
                name: "Ном",
                type: "Тури",
                location: "Жойлашув",
                district: "Туман",
                area: "Майдон",
                price: "Нарх",
                image: "Расм",
                viewDetails: "Тафсилотларни кўриш",
                loadingData: "Маълумотлар юкланмоқда...",
                loadingSubtext: "Серверлардан маълумотлар олинмоқда",
                errorLoading: "Юклашда хатолик",
                successLoaded: "Муваффақиятли юкланди",
                dropFiles: "Файлларни бу ерга ташланг",
                legend: "Шартли белгилар",
                conservation: "Консервация",
                reconstruction: "Реконструкция",
                newConstruction: "Генплан (Реновация)",
                investConstruction: "TIC (Реновация)",
                statistics: "Статистика",
                renovation: "Реновация",
                investment: "Инвестиция",
                auction: "Аукцион",
                sold: "Сотилган",
                strategy: "Стратегия",
                function: "Функция",
                floors: "Қаватлар",
                globalId: "Глобал ID",
                mahalla: "Маҳалла",
                region: "Вилоят",
                seismicZone: "Сейсмик зона",
                buildingArea: "Қурилиш майдони",
                areaRatio: "Майдон нисбати",
                createdDate: "Яратилган сана",
                lastEdited: "Охирги таҳрир",
                technicalParams: "Техник параметрлар",
                administrativeInfo: "Маъмурий маълумот",
                buildingInfo: "Қурилиш маълумотлари",
                redLines: "Қизил чизиқлар",
            };

            // Enhanced API endpoints with your specific URLs
            const API_ENDPOINTS = {
                aktivs: "/api/aktivs",
                auction: "https://projects.toshkentinvest.uz/api/markersing",
                sold: "https://projects.toshkentinvest.uz/api/sotilgan",
                jsonData: "/assets/data/443_output.json",
                geoJsonStrategy: "/tashkent_master_plan.geojson",
                renovatsiyaProjects: "/assets/data/DOP_DATA/tic_data_renovatsiya_loyihalar.kmz",
            };

            // Enhanced map styles
            const MAP_STYLES = {
                osm: {
                    name: TEXTS.standard,
                    url: "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
                    attribution: "© OpenStreetMap contributors",
                },
                satellite: {
                    name: TEXTS.satellite,
                    url: "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
                    attribution: "© Esri, Maxar, Earthstar Geographics",
                },
                hybrid: {
                    name: TEXTS.hybrid,
                    baseUrl:
                        "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
                    labelUrl:
                        "https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}",
                    attribution: "© Esri, Maxar, Earthstar Geographics",
                },
            };

            // Enhanced strategy colors with government color scheme
            const STRATEGY_COLORS = {
                Konservatsiya: "#0277bd",
                Rekonstruktsiya: "#f57c00",
                Yangi_qurilish: "#8e24aa",
                Invest_qurilish: "#059669",
                Rekonstruksiya: "#f57c00",
                "Новое строительство": "#8e24aa",
                Реконструкция: "#f57c00",
                Консервация: "#0277bd",
                Aholi_yashash_joyi: "#2563eb",
                Savdo_xizmat: "#059669",
                Sanoat: "#dc2626",
                Madaniy_tarixiy: "#7c3aed",
                Qizil_chiziqlar: "#dc2626",
                default: "#6b7280",
            };

            // Enhanced function colors
            const FUNCTION_COLORS = {
                Aholi_yashash_joyi: "#2563eb",
                Savdo_xizmat: "#059669",
                Sanoat: "#dc2626",
                Madaniy_tarixiy: "#7c3aed",
                Rekreatsiya: "#10b981",
                Transport: "#f59e0b",
                Kommunal: "#6b7280",
                Qizil_chiziqlar: "#dc2626",
                default: "#8e24aa",
            };

            // Fixed KMZ Search Manager Class
            class KMZSearchManager {
                 constructor() {
        this.kmzData = [];
        this.filteredData = [];
        this.searchInput = null;
        this.resultsContainer = null;
        this.statsElement = null;
        this.totalCountElement = null;
        this.addToast = null;
        this.isInitialized = false;
        this.currentBlinker = null; // Add this for blinker functionality
    }
   init(searchInput, resultsContainer, statsElement, totalCountElement, addToast) {
        this.searchInput = searchInput;
        this.resultsContainer = resultsContainer;
        this.statsElement = statsElement;
        this.totalCountElement = totalCountElement;
        this.addToast = addToast;
        this.isInitialized = true;

        // Bind search input events
        if (this.searchInput) {
            this.searchInput.addEventListener("input", this.handleSearch.bind(this));
            this.searchInput.addEventListener("focus", this.showResults.bind(this));
        }

        // Hide results when clicking outside
        document.addEventListener("click", (e) => {
            if (!e.target.closest(".kmz-search-control")) {
                this.hideResults();
            }
        });

                // Initial data collection
        this.collectExistingKMZData();

        // Process any pending KMZ items
        if (window.pendingKMZItems && window.pendingKMZItems.length > 0) {
            window.pendingKMZItems.forEach((item) => {
                this.addKMZItem(item.data, item.layer);
            });
            window.pendingKMZItems = [];
        }

        // Set up periodic check for new data
        setInterval(() => {
            this.collectExistingKMZData();
        }, 2000);
    }


    // Add the blinker methods
    createBlinker(bounds) {
        // Remove existing blinker
        this.removeBlinker();

        const map = window.mapInstanceRef?.current;
        if (!map) return;

        // Get map container
        const mapContainer = map.getContainer();

        // Convert bounds to pixel coordinates
        const topLeft = map.latLngToContainerPoint(bounds.getNorthWest());
        const bottomRight = map.latLngToContainerPoint(bounds.getSouthEast());

        // Create blinker element
        const blinker = document.createElement('div');
        blinker.className = 'blinker-overlay';

        // Position and size the blinker
        const left = Math.min(topLeft.x, bottomRight.x) - 20;
        const top = Math.min(topLeft.y, bottomRight.y) - 20;
        const width = Math.abs(bottomRight.x - topLeft.x) + 40;
        const height = Math.abs(bottomRight.y - topLeft.y) + 40;

        blinker.style.left = `${left}px`;
        blinker.style.top = `${top}px`;
        blinker.style.width = `${width}px`;
        blinker.style.height = `${height}px`;

        // Add to map container
        mapContainer.appendChild(blinker);
        this.currentBlinker = blinker;

        // Auto-remove after animation
        setTimeout(() => {
            this.removeBlinker();
        }, 2000);
    }

    removeBlinker() {
        if (this.currentBlinker && this.currentBlinker.parentNode) {
            this.currentBlinker.parentNode.removeChild(this.currentBlinker);
            this.currentBlinker = null;
        }
    }

                 collectExistingKMZData() {
        if (!window.layerGroupsRef || !window.layerGroupsRef.current || !window.layerGroupsRef.current.kmz) {
            return;
        }

        const newKmzData = [];
        const kmzGroup = window.layerGroupsRef.current.kmz;

        kmzGroup.eachLayer((layer) => {
            if (layer.kmzData) {
                const data = layer.kmzData;
                const item = {
                    id: data.id || `kmz-${Date.now()}-${newKmzData.length}`,
                    layer: layer,
                    district_name: data.district_name || "Noma'lum tuman",
                    neighborhood_name: data.neighborhood_name || "Noma'lum mahalla",
                    residential_area: data.residential_area || 0,
                    total_building_area: data.total_building_area || 0,
                    property_name: data.property_name || data.neighborhood_name || "KMZ Obyekt",
                    area_hectare: data.area_hectare || 0,
                    designated_floors: data.designated_floors || 0,
                    proposed_floors: data.proposed_floors || 0,
                    investor: data.investor || "",
                    status: data.status || "KMZ Ma'lumot",
                };
                newKmzData.push(item);
            }
        });

        if (newKmzData.length !== this.kmzData.length) {
            this.kmzData = newKmzData;
            this.updateStats();

            if (this.searchInput && this.searchInput.value) {
                this.handleSearch();
            } else {
                this.showAllResults();
            }
        }
    }


    handleSearch() {
        const query = this.searchInput.value.toLowerCase().trim();

        if (!query) {
            this.showAllResults();
            return;
        }

        this.filteredData = this.kmzData.filter((item) => {
            const searchFields = [
                item.district_name,
                item.neighborhood_name,
                item.property_name,
                item.investor,
                item.residential_area.toString(),
                item.total_building_area.toString(),
                item.area_hectare.toString(),
            ].join(" ").toLowerCase();

            return searchFields.includes(query);
        });

        this.renderResults();
    }

  showAllResults() {
        this.filteredData = [...this.kmzData];
        this.renderResults();
    }

    showResults() {
        if (this.searchInput && this.searchInput.value) {
            this.handleSearch();
        } else {
            this.showAllResults();
        }
        if (this.resultsContainer) {
            this.resultsContainer.classList.add("show");
        }
    }

                hideResults() {
        if (this.resultsContainer) {
            this.resultsContainer.classList.remove("show");
        }
    }

                renderResults() {
                    if (!this.resultsContainer) return;

                    this.resultsContainer.classList.add("show");

                    // Create counter display
                    const counterHtml = `
            <div class="search-results-counter">
                <i class="fas fa-search"></i>
                ${this.filteredData.length} та натижа топилди
                ${
                    this.kmzData.length > this.filteredData.length
                        ? ` (${this.kmzData.length} тадан)`
                        : ""
                }
            </div>
        `;

                    if (this.filteredData.length === 0) {
                        this.resultsContainer.innerHTML =
                            counterHtml +
                            '<div class="no-results">Hech narsa topilmadi</div>';
                        return;
                    }

                    const resultsHtml = this.filteredData
                        .map(
                            (item, index) => `
            <div class="result-item" onclick="window.kmzSearchManager.selectAndZoom('${
                item.id
            }')">
                <div class="result-main">${item.property_name}</div>
                <div class="result-details">
                    <span>${item.district_name} • ${item.neighborhood_name}
                    ${
                        item.residential_area > 0
                            ? ` • ${item.residential_area} m² yashash`
                            : ""
                    }
                    ${
                        item.area_hectare > 0
                            ? ` • ${item.area_hectare} ga`
                            : ""
                    }</span>
                    <button class="zoom-btn" onclick="event.stopPropagation(); window.kmzSearchManager.zoomToItem('${
                        item.id
                    }')">
                        <i class="fas fa-crosshairs"></i> Zoom
                    </button>
                </div>
            </div>
        `
                        )
                        .join("");

                    this.resultsContainer.innerHTML = counterHtml + resultsHtml;
                }

                selectAndZoom(itemId) {
                    const item = this.kmzData.find((d) => d.id === itemId);
                    if (!item) return;

                    // Zoom to the layer
                    this.zoomToItem(itemId);

                    // Show popup if available
                    if (
                        item.layer &&
                        typeof item.layer.openPopup === "function"
                    ) {
                        setTimeout(() => {
                            try {
                                item.layer.openPopup();
                            } catch (error) {
                                // Ignore popup errors
                            }
                        }, 500);
                    }

                    // Hide search results
                    this.hideResults();

                    // Clear search input
                    if (this.searchInput) {
                        this.searchInput.value = "";
                    }

                    // Show toast notification
                    if (this.addToast) {
                        this.addToast(
                            `${item.property_name} ga o'tildi`,
                            "success"
                        );
                    }
                }

                zoomToItem(itemId) {
                    console.log(
                        "🔍 Enhanced zoomToItem called with itemId:",
                        itemId
                    );

                    const searchId = String(itemId);
                    const item = this.kmzData.find(
                        (d) => String(d.id) === searchId
                    );

                    if (!item) {
                        console.error("❌ Item not found with id:", itemId);
                        return;
                    }

                    const map = window.mapInstanceRef?.current;
                    if (!map) {
                        console.error("❌ Map instance not available");
                        return;
                    }

                    console.log("✅ Found item:", item.property_name);

                    try {
                        let bounds = null;
                        let zoomSuccess = false;

                        // Try to get bounds from the layer
                        if (typeof item.layer.getBounds === "function") {
                            try {
                                bounds = item.layer.getBounds();
                                if (
                                    bounds &&
                                    ((bounds.isValid && bounds.isValid()) ||
                                        (bounds._southWest &&
                                            bounds._northEast))
                                ) {
                                    map.fitBounds(bounds, {
                                        padding: [50, 50],
                                        maxZoom: 16,
                                    });
                                    zoomSuccess = true;
                                    console.log(
                                        "✅ Zoom successful with getBounds"
                                    );
                                }
                            } catch (e) {
                                console.log("❌ getBounds failed:", e.message);
                            }
                        }

                        // Fallback to point zoom
                        if (
                            !zoomSuccess &&
                            typeof item.layer.getLatLng === "function"
                        ) {
                            try {
                                const latlng = item.layer.getLatLng();
                                if (latlng && latlng.lat && latlng.lng) {
                                    map.setView([latlng.lat, latlng.lng], 16);
                                    // Create artificial bounds for point
                                    bounds = L.latLngBounds(
                                        [
                                            latlng.lat - 0.001,
                                            latlng.lng - 0.001,
                                        ],
                                        [latlng.lat + 0.001, latlng.lng + 0.001]
                                    );
                                    zoomSuccess = true;
                                    console.log(
                                        "✅ Zoom successful with getLatLng"
                                    );
                                }
                            } catch (e) {
                                console.log("❌ getLatLng failed:", e.message);
                            }
                        }

                        // More fallback methods...
                        if (!zoomSuccess && item.layer._latlng) {
                            try {
                                map.setView(
                                    [
                                        item.layer._latlng.lat,
                                        item.layer._latlng.lng,
                                    ],
                                    16
                                );
                                bounds = L.latLngBounds(
                                    [
                                        item.layer._latlng.lat - 0.001,
                                        item.layer._latlng.lng - 0.001,
                                    ],
                                    [
                                        item.layer._latlng.lat + 0.001,
                                        item.layer._latlng.lng + 0.001,
                                    ]
                                );
                                zoomSuccess = true;
                                console.log("✅ Zoom successful with _latlng");
                            } catch (e) {
                                console.log("❌ _latlng failed:", e.message);
                            }
                        }

                        // Try _latlngs for polygons
                        if (
                            !zoomSuccess &&
                            item.layer._latlngs &&
                            Array.isArray(item.layer._latlngs)
                        ) {
                            try {
                                let allLatLngs = [];
                                const flattenLatLngs = (arr) => {
                                    arr.forEach((item) => {
                                        if (Array.isArray(item)) {
                                            flattenLatLngs(item);
                                        } else if (
                                            item &&
                                            item.lat !== undefined &&
                                            item.lng !== undefined
                                        ) {
                                            allLatLngs.push([
                                                item.lat,
                                                item.lng,
                                            ]);
                                        }
                                    });
                                };

                                flattenLatLngs(item.layer._latlngs);

                                if (allLatLngs.length > 0) {
                                    bounds = L.latLngBounds(allLatLngs);
                                    map.fitBounds(bounds, {
                                        padding: [50, 50],
                                        maxZoom: 16,
                                    });
                                    zoomSuccess = true;
                                    console.log(
                                        "✅ Zoom successful with _latlngs"
                                    );
                                }
                            } catch (e) {
                                console.log("❌ _latlngs failed:", e.message);
                            }
                        }

                        // Create blinker effect if we have bounds
                        if (zoomSuccess && bounds) {
                            setTimeout(() => {
                                this.createBlinker(bounds);
                            }, 200); // Small delay to let zoom complete

                            if (this.addToast) {
                                this.addToast(
                                    `${item.property_name} га муваффақиятли ўтилди`,
                                    "success"
                                );
                            }
                        } else {
                            // Final fallback
                            map.setView([41.311, 69.279], 14);
                            if (this.addToast) {
                                this.addToast(
                                    "Объектга зум қилиб бўлмади, хаританинг марказига ўтилди",
                                    "warning"
                                );
                            }
                        }
                    } catch (error) {
                        console.error(
                            "💥 Critical error during zoom operation:",
                            error
                        );

                        try {
                            map.setView([41.311, 69.279], 14);
                        } catch (fallbackError) {
                            console.error(
                                "💥 Even fallback failed:",
                                fallbackError
                            );
                        }

                        if (this.addToast) {
                            this.addToast(
                                `Зум қилишда хатолик: ${error.message}`,
                                "error"
                            );
                        }
                    }
                }
                updateStats() {
                    if (this.totalCountElement) {
                        this.totalCountElement.textContent =
                            this.kmzData.length;
                    }
                }

                addKMZItem(data, layer) {
                    const item = {
                        id:
                            data.id ||
                            `kmz-${Date.now()}-${this.kmzData.length}`,
                        layer: layer,
                        district_name: data.district_name || "Noma'lum tuman",
                        neighborhood_name:
                            data.neighborhood_name || "Noma'lum mahalla",
                        residential_area: data.residential_area || 0,
                        total_building_area: data.total_building_area || 0,
                        property_name:
                            data.property_name ||
                            data.neighborhood_name ||
                            "KMZ Obyekt",
                        area_hectare: data.area_hectare || 0,
                        designated_floors: data.designated_floors || 0,
                        proposed_floors: data.proposed_floors || 0,
                        investor: data.investor || "",
                        status: data.status || "KMZ Ma'lumot",
                    };

                    this.kmzData.push(item);
                    this.updateStats();
                }

                clearData() {
                    this.kmzData = [];
                    this.filteredData = [];
                    this.updateStats();
                    if (this.resultsContainer) {
                        this.resultsContainer.innerHTML =
                            '<div class="loading-text">KMZ ma\'lumotlar yuklanmoqda...</div>';
                    }
                }
            }
            // Global KMZ Search Manager instance
            window.kmzSearchManager = new KMZSearchManager();

            // Location Search Manager for finding any locations
            class LocationSearchManager {
                constructor() {
                    this.searchInput = null;
                    this.resultsContainer = null;
                    this.addToast = null;
                    this.isInitialized = false;
                }

                init(searchInput, resultsContainer, addToast) {
                    this.searchInput = searchInput;
                    this.resultsContainer = resultsContainer;
                    this.addToast = addToast;
                    this.isInitialized = true;

                    if (this.searchInput) {
                        this.searchInput.addEventListener("input", this.handleSearch.bind(this));
                        this.searchInput.addEventListener("keypress", this.handleKeyPress.bind(this));
                        this.searchInput.addEventListener("focus", this.showHelp.bind(this));
                    }

                    // Hide results when clicking outside
                    document.addEventListener("click", (e) => {
                        if (!e.target.closest(".location-search-control")) {
                            this.hideResults();
                        }
                    });
                }

                handleKeyPress(e) {
                    if (e.key === "Enter") {
                        this.findLocation();
                    }
                }

                handleSearch() {
                    // Show help text on focus
                    const query = this.searchInput.value.trim();
                    if (query.length === 0) {
                        this.showHelp();
                    } else {
                        this.renderPreview();
                    }
                }

                // Parse DMS format: 48°51'30.24"N, 2°17'40.2"E
                parseDMS(dmsString) {
                    const dmsRegex = /(\d+)°(\d+)'([\d.]+)"([NS])\s*,?\s*(\d+)°(\d+)'([\d.]+)"([EW])/i;
                    const match = dmsString.match(dmsRegex);

                    if (!match) return null;

                    let lat = parseInt(match[1]) + parseInt(match[2]) / 60 + parseFloat(match[3]) / 3600;
                    let lng = parseInt(match[5]) + parseInt(match[6]) / 60 + parseFloat(match[7]) / 3600;

                    if (match[4].toUpperCase() === "S") lat = -lat;
                    if (match[8].toUpperCase() === "W") lng = -lng;

                    return [lat, lng];
                }

                // Parse decimal coordinates: 41.3639259, 69.2740783 or 69.2740783, 41.3639259
                parseDecimal(input) {
                    // Handle multiple coordinate separators
                    const decimalRegex = /(-?\d+\.?\d*)\s*[,;\s]\s*(-?\d+\.?\d*)/;
                    const match = input.match(decimalRegex);

                    if (!match) return null;

                    const num1 = parseFloat(match[1]);
                    const num2 = parseFloat(match[2]);

                    console.log("Parsing decimal coordinates:", num1, num2);

                    // Try both orders and validate for Uzbekistan bounds
                    // Latitude: 39-43, Longitude: 68-71
                    if (num1 >= 39 && num1 <= 43 && num2 >= 68 && num2 <= 71) {
                        console.log("Valid as lat,lng:", [num1, num2]);
                        return [num1, num2]; // lat, lng
                    }
                    if (num2 >= 39 && num2 <= 43 && num1 >= 68 && num1 <= 71) {
                        console.log("Valid as lng,lat (swapped to lat,lng):", [num2, num1]);
                        return [num2, num1]; // swap to lat, lng
                    }

                    // Fallback: be more lenient and try to match pattern even if outside strict bounds
                    // This handles border coordinates or satellite view quirks
                    if ((num1 >= 38 && num1 <= 44) && (num2 >= 67 && num2 <= 72)) {
                        if (num1 >= 39 && num1 <= 43) {
                            console.log("Lenient match (num1 is lat):", [num1, num2]);
                            return [num1, num2];
                        }
                        if (num2 >= 39 && num2 <= 43) {
                            console.log("Lenient match (num2 is lat):", [num2, num1]);
                            return [num2, num1];
                        }
                    }

                    console.log("Coordinates out of bounds:", num1, num2);
                    return null;
                }

                // Parse Google Maps URL and Yandex Maps URL
                parseGoogleMapsUrl(url) {
                    try {
                        const decodedUrl = decodeURIComponent(url);

                        // Yandex Maps pattern: ll=lng,lat
                        if (decodedUrl.includes("yandex")) {
                            const llPattern = /ll=(-?\d+\.?\d*),(-?\d+\.?\d*)/;
                            const llMatch = decodedUrl.match(llPattern);
                            if (llMatch) {
                                const lng = parseFloat(llMatch[1]);
                                const lat = parseFloat(llMatch[2]);
                                console.log("Yandex coords extracted:", [lat, lng]);
                                if (lat >= 39 && lat <= 43 && lng >= 68 && lng <= 71) {
                                    return [lat, lng];
                                }
                            }
                        }

                        // Google Maps pattern: @lat,lng,zoom
                        const atPattern = /@(-?\d+\.?\d*),(-?\d+\.?\d*)/;
                        const atMatch = decodedUrl.match(atPattern);
                        if (atMatch) {
                            const lat = parseFloat(atMatch[1]);
                            const lng = parseFloat(atMatch[2]);
                            console.log("Google @ pattern coords extracted:", [lat, lng]);
                            if (lat >= 39 && lat <= 43 && lng >= 68 && lng <= 71) {
                                return [lat, lng];
                            }
                        }

                        // Google Maps pattern: !3d!4d
                        const dataPattern = /!3d(-?\d+\.?\d*)!4d(-?\d+\.?\d*)/;
                        const dataMatch = decodedUrl.match(dataPattern);
                        if (dataMatch) {
                            const lat = parseFloat(dataMatch[1]);
                            const lng = parseFloat(dataMatch[2]);
                            console.log("Google !3d!4d pattern coords extracted:", [lat, lng]);
                            if (lat >= 39 && lat <= 43 && lng >= 68 && lng <= 71) {
                                return [lat, lng];
                            }
                        }

                        // Try URL object parsing for query params
                        try {
                            const urlObj = new URL(decodedUrl);
                            const params = urlObj.searchParams;

                            if (params.has("q")) {
                                const qMatch = params.get("q").match(/(-?\d+\.?\d*),(-?\d+\.?\d*)/);
                                if (qMatch) {
                                    const lat = parseFloat(qMatch[1]);
                                    const lng = parseFloat(qMatch[2]);
                                    console.log("Query param coords extracted:", [lat, lng]);
                                    if (lat >= 39 && lat <= 43 && lng >= 68 && lng <= 71) {
                                        return [lat, lng];
                                    }
                                }
                            }
                        } catch (urlError) {
                            // URL parsing failed, continue with fallback
                        }

                        // Fallback: look for any decimal numbers in sequence that might be coordinates
                        const fallbackPattern = /(\d+\.\d+),\s*(\d+\.\d+)/;
                        const fallbackMatch = decodedUrl.match(fallbackPattern);
                        if (fallbackMatch) {
                            const num1 = parseFloat(fallbackMatch[1]);
                            const num2 = parseFloat(fallbackMatch[2]);
                            console.log("Fallback coords found:", [num1, num2]);

                            // Try both orders
                            if (num1 >= 39 && num1 <= 43 && num2 >= 68 && num2 <= 71) {
                                return [num1, num2]; // lat, lng
                            }
                            if (num2 >= 39 && num2 <= 43 && num1 >= 68 && num1 <= 71) {
                                return [num2, num1]; // swap to lat, lng
                            }
                        }
                    } catch (e) {
                        console.log("URL parsing error:", e);
                    }
                    return null;
                }

                // Main location finder
                findLocation() {
                    const input = this.searchInput.value.trim();
                    if (!input) return;

                    let coords = null;
                    let source = "Noma'lum";

                    // Try different parsing methods
                    if (input.includes("°") || input.match(/\d+°\d+'/)) {
                        coords = this.parseDMS(input);
                        source = "DMS koordinatalari";
                    } else if (input.includes("http")) {
                        coords = this.parseGoogleMapsUrl(input);
                        source = "Google Maps havolasi";
                        // If short URL didn't work, try decimal fallback
                        if (!coords && input.includes("maps.app.goo.gl")) {
                            console.log("Short URL couldn't be resolved, this may require API expansion");
                        }
                    } else {
                        coords = this.parseDecimal(input);
                        source = "O'nlik koordinatalari";
                    }

                    if (coords) {
                        this.zoomToLocation(coords, source);
                    } else {
                        if (this.addToast) {
                            this.addToast("Joylashuv topilmadi. Iltimos, to'g'ri format kiriting", "warning");
                        }
                        this.showFormatHelp();
                    }
                }

                // Zoom to location on map
                zoomToLocation(coords, source) {
                    const map = window.mapInstanceRef?.current;
                    if (!map) {
                        console.error("Map not available");
                        if (this.addToast) {
                            this.addToast("Xarita yuklana olmadi", "error");
                        }
                        return;
                    }

                    try {
                        const [lat, lng] = coords;
                        console.log("Zooming to coordinates:", [lat, lng]);

                        // Validate coordinates
                        if (isNaN(lat) || isNaN(lng)) {
                            console.error("Invalid coordinates - NaN detected");
                            if (this.addToast) {
                                this.addToast("Noto'g'ri koordinatalar", "warning");
                            }
                            return;
                        }

                        if (lat < 39 || lat > 43 || lng < 68 || lng > 71) {
                            console.error(`Coordinates out of bounds: lat=${lat}, lng=${lng}`);
                            if (this.addToast) {
                                this.addToast("Koordinatalar Toshkent uchun amal qilmaydi (39-43°N, 68-71°E)", "warning");
                            }
                            return;
                        }

                        // Set map view
                        map.setView([lat, lng], 17);
                        console.log("Map view set successfully");

                        // Add marker
                        const marker = L.marker([lat, lng], {
                            icon: createMarkerIcon("regular", 20),
                            title: source
                        });

                        // Create popup
                        const popup = `
                            <div class="popup-header">${source}</div>
                            <div class="popup-details">
                                <p><strong>Latitude:</strong> ${lat.toFixed(6)}</p>
                                <p><strong>Longitude:</strong> ${lng.toFixed(6)}</p>
                            </div>
                        `;

                        marker.bindPopup(popup).addTo(map).openPopup();
                        console.log("Marker added to map");

                        if (this.addToast) {
                            this.addToast(`Joylashuv topildi: ${lat.toFixed(4)}, ${lng.toFixed(4)}`, "success");
                        }

                        this.hideResults();
                    } catch (error) {
                        console.error("Zoom error:", error);
                        if (this.addToast) {
                            this.addToast("Xatolik: " + error.message, "error");
                        }
                    }
                }

                showHelp() {
                    if (!this.resultsContainer) return;

                    const helpHtml = `
                        <div class="search-results-counter">
                            <i class="fas fa-info-circle"></i>
                            Joylashuvni topish
                        </div>
                        <div style="padding: 12px; font-size: 12px; line-height: 1.6; color: #666;">
                            <strong>Qo'llanma:</strong><br>
                            📍 <strong>DMS format:</strong><br>48°51'30.24"N, 2°17'40.2"E<br><br>
                            📍 <strong>O'nlik:</strong><br>41.3639259, 69.2740783<br><br>
                            📍 <strong>Google Maps URL:</strong><br>https://maps.app.goo.gl/...<br><br>
                            ↵ Enter tugmasini bosing
                        </div>
                    `;

                    this.resultsContainer.innerHTML = helpHtml;
                    this.resultsContainer.classList.add("show");
                }

                showFormatHelp() {
                    if (!this.resultsContainer) return;

                    const helpHtml = `
                        <div class="search-results-counter">
                            <i class="fas fa-exclamation"></i>
                            Noto'g'ri format
                        </div>
                        <div style="padding: 12px; font-size: 12px; color: #d32f2f; line-height: 1.6;">
                            <strong>Qabul qilingan formatlar:</strong><br>
                            • 48°51'30.24"N, 2°17'40.2"E<br>
                            • 41.3639259, 69.2740783<br>
                            • Google Maps URL
                        </div>
                    `;

                    this.resultsContainer.innerHTML = helpHtml;
                    this.resultsContainer.classList.add("show");
                }

                renderPreview() {
                    const input = this.searchInput.value.trim();
                    if (!input) return;

                    let preview = "";
                    let icon = "fa-question";

                    if (input.includes("°") || input.match(/\d+°\d+'/)) {
                        preview = "DMS koordinatalari (Degrees, Minutes, Seconds)";
                        icon = "fa-compass";
                    } else if (input.includes("http")) {
                        preview = "Google Maps havolasi";
                        icon = "fa-link";
                    } else if (input.match(/^-?\d+\.?\d*\s*[,\s]\s*-?\d+\.?\d*/)) {
                        preview = "O'nlik koordinatalari (Latitude, Longitude)";
                        icon = "fa-map-pin";
                    }

                    if (preview) {
                        const html = `
                            <div class="search-results-counter">
                                <i class="fas ${icon}"></i>
                                ${preview}
                            </div>
                            <div style="padding: 12px; font-size: 12px; color: #666; text-align: center;">
                                ↵ Enter tugmasini bosing qidirish uchun
                            </div>
                        `;
                        this.resultsContainer.innerHTML = html;
                        this.resultsContainer.classList.add("show");
                    }
                }

                hideResults() {
                    if (this.resultsContainer) {
                        this.resultsContainer.classList.remove("show");
                    }
                }
            }

            // Global Location Search Manager instance
            window.locationSearchManager = new LocationSearchManager();

            // Utility Functions
            const initProj4 = () => {
                if (typeof proj4 !== "undefined") {
                    proj4.defs(
                        "EPSG:32642",
                        "+proj=utm +zone=42 +datum=WGS84 +units=m +no_defs"
                    );
                }
            };

            const utmToLatLng = (x, y) => {
                try {
                    if (typeof proj4 !== "undefined") {
                        const lonLat = proj4("EPSG:32642", "EPSG:4326", [x, y]);
                        return [lonLat[1], lonLat[0]];
                    }
                } catch (error) {
                    console.warn("Coordinate conversion failed:", error);
                }
                return null;
            };

            const isUTM = (x, y) => Math.abs(x) > 180 || Math.abs(y) > 90;

            const convertCoordinates = (coords) => {
                if (isUTM(coords[0], coords[1])) {
                    return utmToLatLng(coords[0], coords[1]);
                }
                return [coords[1], coords[0]];
            };

            // Enhanced coordinate extraction
            const extractCoordinatesFromUrl = (url) => {
                if (!url) return null;

                try {
                    const decodedUrl = decodeURIComponent(url);
                    console.log("Processing URL:", decodedUrl);

                    // Handle Yandex Maps URLs
                    if (
                        decodedUrl.includes("yandex.uz/maps") ||
                        decodedUrl.includes("yandex.com/maps")
                    ) {
                        const llMatch = decodedUrl.match(/ll=([^&]+)/);
                        if (llMatch) {
                            const coords = llMatch[1]
                                .split("%2C")
                                .join(",")
                                .split(",");
                            if (coords.length === 2) {
                                const lng = parseFloat(coords[0]);
                                const lat = parseFloat(coords[1]);
                                if (
                                    lat >= 39 &&
                                    lat <= 43 &&
                                    lng >= 68 &&
                                    lng <= 71
                                ) {
                                    console.log(
                                        "Extracted Yandex coordinates:",
                                        [lat, lng]
                                    );
                                    return [lat, lng];
                                }
                            }
                        }
                    }

                    // Google Maps patterns - multiple formats
                    const googlePatterns = [
                        // Format: /search/lat,lng or /search/lat,+lng
                        /\/search\/(-?\d+\.\d+),\+?(-?\d+\.\d+)/,
                        // Format: @lat,lng,zoom
                        /@(-?\d+\.?\d*),(-?\d+\.?\d*),?\d*[mz]?/,
                        // Format: decimal coordinates in URL
                        /(-?\d+\.\d{4,}),\+?(-?\d+\.\d{4,})/,
                        // Format: !3d!4d coordinates
                        /!3d(-?\d+\.?\d*)!4d(-?\d+\.?\d*)/,
                        // Format: place coordinates
                        /\/place\/[^@]*@(-?\d+\.?\d*),(-?\d+\.?\d*)/,
                        // Format: DMS coordinates converted
                        /%C2%B0(\d+)'(\d+)\.?(\d*)"N\+(\d+)%C2%B0(\d+)'(\d+)\.?(\d*)"E/,
                        // Format: simple lat,lng with optional + sign
                        /(-?\d+\.?\d+),\+?(-?\d+\.?\d+)/,
                    ];

                    for (const pattern of googlePatterns) {
                        const match = decodedUrl.match(pattern);
                        if (match) {
                            let lat, lng;

                            // Handle DMS (Degrees Minutes Seconds) format
                            if (pattern.source.includes("C2%B0")) {
                                const latDeg = parseInt(match[1]);
                                const latMin = parseInt(match[2]);
                                const latSec = parseFloat(match[3] || 0);
                                const lngDeg = parseInt(match[4]);
                                const lngMin = parseInt(match[5]);
                                const lngSec = parseFloat(match[6] || 0);

                                lat = latDeg + latMin / 60 + latSec / 3600;
                                lng = lngDeg + lngMin / 60 + lngSec / 3600;
                            } else {
                                lat = parseFloat(match[1]);
                                lng = parseFloat(match[2]);
                            }

                            // Validate coordinates are in Uzbekistan range
                            if (
                                lat >= 39 &&
                                lat <= 43 &&
                                lng >= 68 &&
                                lng <= 71
                            ) {
                                console.log("Extracted Google coordinates:", [
                                    lat,
                                    lng,
                                ]);
                                return [lat, lng];
                            }
                        }
                    }

                    // Query parameters fallback
                    try {
                        const urlObj = new URL(decodedUrl);
                        const params = urlObj.searchParams;

                        const qParam = params.get("q");
                        if (qParam) {
                            const qMatch = qParam.match(
                                /(-?\d+\.?\d*),(-?\d+\.?\d*)/
                            );
                            if (qMatch) {
                                const lat = parseFloat(qMatch[1]);
                                const lng = parseFloat(qMatch[2]);
                                if (
                                    lat >= 39 &&
                                    lat <= 43 &&
                                    lng >= 68 &&
                                    lng <= 71
                                ) {
                                    console.log(
                                        "Extracted q parameter coordinates:",
                                        [lat, lng]
                                    );
                                    return [lat, lng];
                                }
                            }
                        }
                    } catch (urlError) {
                        // URL parsing failed, continue
                    }

                    // Fallback: any two decimal numbers that look like coordinates
                    const allCoordMatches = decodedUrl.match(/(-?\d+\.\d+)/g);
                    if (allCoordMatches && allCoordMatches.length >= 2) {
                        for (let i = 0; i < allCoordMatches.length - 1; i++) {
                            const coord1 = parseFloat(allCoordMatches[i]);
                            const coord2 = parseFloat(allCoordMatches[i + 1]);

                            // Try both orders (lat,lng and lng,lat)
                            if (
                                coord1 >= 39 &&
                                coord1 <= 43 &&
                                coord2 >= 68 &&
                                coord2 <= 71
                            ) {
                                console.log(
                                    "Extracted fallback coordinates (lat,lng):",
                                    [coord1, coord2]
                                );
                                return [coord1, coord2];
                            }
                            if (
                                coord2 >= 39 &&
                                coord2 <= 43 &&
                                coord1 >= 68 &&
                                coord1 <= 71
                            ) {
                                console.log(
                                    "Extracted fallback coordinates (lng,lat):",
                                    [coord2, coord1]
                                );
                                return [coord2, coord1];
                            }
                        }
                    }

                    console.log("No valid coordinates found in URL");
                    return null;
                } catch (error) {
                    console.error(
                        "Error extracting coordinates from URL:",
                        url,
                        error
                    );
                    return null;
                }
            };
              // Enhanced marker creation
            const createMarkerIcon = (type, size = 16) => {
                const colors = {
                    renovation: "#7c3aed",
                    investment: "#2563eb",
                    auction: "#ea580c",
                    sold: "#dc2626",
                    regular: "#059669",
                    kmz: "#22f50b",
                    conservation: "#0277bd",
                    reconstruction: "#f57c00",
                    "new-construction": "#8e24aa",
                    "red-line": "#dc2626",
                };

                return L.divIcon({
                    html: `<div class="marker-icon marker-${type}" style="width:${size}px;height:${size}px;background:${
                        colors[type] || colors.regular
                    }"></div>`,
                    className: "custom-marker",
                    iconSize: [size + 6, size + 6],
                    iconAnchor: [(size + 6) / 2, (size + 6) / 2],
                });
            };

            // Enhanced KMZ processing
            const processKMZFile = async (fileUrl) => {
                try {
                    let correctedUrl = fileUrl;
                    if (fileUrl.includes("http://localhost/")) {
                        correctedUrl = fileUrl.replace(
                            "http://localhost/",
                            "http://127.0.0.1:8000/"
                        );
                    }

                    const response = await fetch(correctedUrl);
                    const arrayBuffer = await response.arrayBuffer();

                    const zip = new JSZip();
                    const contents = await zip.loadAsync(arrayBuffer);

                    const kmlFile = Object.keys(contents.files).find(
                        (filename) => filename.toLowerCase().endsWith(".kml")
                    );

                    if (!kmlFile) {
                        throw new Error("No KML file found in KMZ");
                    }

                    const kmlContent = await contents.files[kmlFile].async(
                        "string"
                    );
                    const parser = new DOMParser();
                    const kmlDoc = parser.parseFromString(
                        kmlContent,
                        "text/xml"
                    );

                    const geoJSON = toGeoJSON.kml(kmlDoc);
                    return geoJSON;
                } catch (error) {
                    console.error("Error processing KMZ:", error);
                    throw error;
                }
            };

            // Enhanced strategy color function with red lines support
            const getStrategyColor = (properties) => {
                if (!properties) return STRATEGY_COLORS.default;

                const funksiya =
                    properties.funksiya ||
                    properties.function ||
                    properties.type;
                if (funksiya === "Qizil_chiziqlar") {
                    return STRATEGY_COLORS.Qizil_chiziqlar;
                }

                const strategy =
                    properties.strategiya ||
                    properties.strategy ||
                    properties.type;
                if (strategy) {
                    const normalizedStrategy = strategy
                        .toString()
                        .toLowerCase();

                    for (const [key, color] of Object.entries(
                        STRATEGY_COLORS
                    )) {
                        if (key.toLowerCase() === normalizedStrategy) {
                            return color;
                        }
                    }

                    if (
                        normalizedStrategy.includes("konservat") ||
                        normalizedStrategy.includes("консерв")
                    ) {
                        return STRATEGY_COLORS["Konservatsiya"];
                    }
                    if (
                        normalizedStrategy.includes("rekonstrukt") ||
                        normalizedStrategy.includes("реконструк")
                    ) {
                        return STRATEGY_COLORS["Rekonstruktsiya"];
                    }
                    if (
                        normalizedStrategy.includes("yangi") ||
                        normalizedStrategy.includes("новое") ||
                        normalizedStrategy.includes("строитель")
                    ) {
                        return STRATEGY_COLORS["Yangi_qurilish"];
                    }
                }

                if (funksiya) {
                    return FUNCTION_COLORS[funksiya] || FUNCTION_COLORS.default;
                }

                return STRATEGY_COLORS.default;
            };

            // Enhanced format functions
            const formatDate = (timestamp) => {
                if (!timestamp) return "N/A";
                try {
                    const date = new Date(timestamp);
                    return date.toLocaleDateString("uz-UZ");
                } catch {
                    return "N/A";
                }
            };

            const formatArea = (area) => {
                if (!area) return "N/A";
                if (area > 10000) {
                    return `${(area / 10000).toFixed(2)} га`;
                }
                return `${area.toFixed(2)} м²`;
            };

            const formatStrategy = (strategy) => {
                const strategies = {
                    Konservatsiya: TEXTS.conservation,
                    Rekonstruktsiya: TEXTS.reconstruction,
                    Yangi_qurilish: TEXTS.newConstruction,
                    Invest_qurilish: TEXTS.investConstruction,
                    Rekonstruksiya: TEXTS.reconstruction,
                    Qizil_chiziqlar: TEXTS.redLines,
                };
                return strategies[strategy] || strategy || "N/A";
            };

            const formatFunction = (func) => {
                const functions = {
                    Aholi_yashash_joyi: "Аҳоли яшаш жойи",
                    Savdo_xizmat: "Савдо-хизмат",
                    Sanoat: "Саноат",
                    Madaniy_tarixiy: "Маданий-тарихий",
                    Rekreatsiya: "Рекреация",
                    Transport: "Транспорт",
                    Kommunal: "Коммунал",
                    Qizil_chiziqlar: TEXTS.redLines,
                };
                return functions[func] || func || "N/A";
            };

            // KMZ Search Component - clean version without debug buttons
            const KMZSearchControl = ({ addToast }) => {
                const searchInputRef = useRef(null);
                const resultsRef = useRef(null);
                const statsRef = useRef(null);
                const totalCountRef = useRef(null);

                useEffect(() => {
                    if (
                        searchInputRef.current &&
                        resultsRef.current &&
                        statsRef.current &&
                        totalCountRef.current
                    ) {
                        window.kmzSearchManager.init(
                            searchInputRef.current,
                            resultsRef.current,
                            statsRef.current,
                            totalCountRef.current,
                            addToast
                        );
                    }
                }, [addToast]);

                return React.createElement(
                    "div",
                    { className: "control-panel kmz-search-control" },
                    React.createElement(
                        "div",
                        { className: "search-title" },
                        React.createElement("i", {
                            className: "fas fa-search",
                        }),
                        TEXTS.kmzSearch
                    ),
                    React.createElement("input", {
                        ref: searchInputRef,
                        type: "text",
                        className: "search-input",
                        placeholder:
                            "Tuman, mahalla yoki maydon bo'yicha qidiring...",
                    }),
                    React.createElement(
                        "div",
                        { ref: resultsRef, className: "results-container" },
                        React.createElement(
                            "div",
                            { className: "loading-text" },
                            "KMZ ma'lumotlar yuklanmoqda..."
                        )
                    ),
                    React.createElement(
                        "div",
                        { ref: statsRef, className: "stats-info" },
                        "Jami: ",
                        React.createElement(
                            "span",
                            { ref: totalCountRef },
                            "0"
                        ),
                        " ta KMZ obyekt"
                    )
                );
            };

            // Location Search Component - Find any locations
            const LocationSearchControl = ({ addToast }) => {
                const searchInputRef = useRef(null);
                const resultsRef = useRef(null);

                useEffect(() => {
                    if (searchInputRef.current && resultsRef.current) {
                        window.locationSearchManager.init(
                            searchInputRef.current,
                            resultsRef.current,
                            addToast
                        );
                    }
                }, [addToast]);

                return React.createElement(
                    "div",
                    { className: "control-panel location-search-control" },
                    React.createElement(
                        "div",
                        { className: "search-title" },
                        React.createElement("i", {
                            className: "fas fa-map-pin",
                        }),
                        "Joylashuvni Topish"
                    ),
                    React.createElement("input", {
                        ref: searchInputRef,
                        type: "text",
                        className: "search-input",
                        placeholder:
                            "Koordinata, URL yoki DMS kiriting...",
                    }),
                    React.createElement(
                        "div",
                        { ref: resultsRef, className: "results-container" },
                        React.createElement(
                            "div",
                            { className: "loading-text" },
                            "Joylashuvni topish uchun ma'lumot kiriting"
                        )
                    )
                );
            };

            // Toast Component
            const Toast = ({ toasts, removeToast }) =>
                React.createElement(
                    "div",
                    { className: "toast-container" },
                    toasts.map((toast) =>
                        React.createElement(
                            "div",
                            {
                                key: toast.id,
                                className: `toast ${toast.type}`,
                                onClick: () => removeToast(toast.id),
                            },
                            React.createElement("i", {
                                className: `fas ${
                                    toast.type === "success"
                                        ? "fa-check-circle"
                                        : toast.type === "error"
                                        ? "fa-exclamation-circle"
                                        : toast.type === "warning"
                                        ? "fa-exclamation-triangle"
                                        : "fa-info-circle"
                                }`,
                            }),
                            React.createElement("span", null, toast.message)
                        )
                    )
                );

            // Enhanced Loading Component
            const Loading = ({ show }) =>
                show
                    ? React.createElement(
                          "div",
                          { className: "loading-overlay" },
                          React.createElement(
                              "div",
                              { className: "loading-content" },
                              React.createElement("div", {
                                  className: "loading-spinner",
                              }),
                              React.createElement(
                                  "div",
                                  { className: "loading-text" },
                                  TEXTS.loadingData
                              ),
                              React.createElement(
                                  "div",
                                  { className: "loading-subtext" },
                                  TEXTS.loadingSubtext
                              )
                          )
                      )
                    : null;

            // Enhanced Legend Component with red lines
            const Legend = () =>
                React.createElement(
                    "div",
                    { className: "legend" },
                    React.createElement(
                        "div",
                        { className: "legend-title" },
                        React.createElement("i", {
                            className: "fas fa-palette",
                        }),
                        TEXTS.legend
                    ),
                    React.createElement(
                        "div",
                        { className: "legend-item" },
                        React.createElement("div", {
                            className: "legend-color",
                            style: {
                                backgroundColor:
                                    STRATEGY_COLORS["Konservatsiya"],
                            },
                        }),
                        React.createElement("span", null, TEXTS.conservation)
                    ),
                    React.createElement(
                        "div",
                        { className: "legend-item" },
                        React.createElement("div", {
                            className: "legend-color",
                            style: {
                                backgroundColor:
                                    STRATEGY_COLORS["Rekonstruktsiya"],
                            },
                        }),
                        React.createElement("span", null, TEXTS.reconstruction)
                    ),
                    React.createElement(
                        "div",
                        { className: "legend-item" },
                        React.createElement("div", {
                            className: "legend-color",
                            style: {
                                backgroundColor:
                                    STRATEGY_COLORS["Yangi_qurilish"],
                            },
                        }),
                        React.createElement("span", null, TEXTS.newConstruction)
                    ),
                    React.createElement(
                        "div",
                        { className: "legend-item" },
                        React.createElement("div", {
                            className: "legend-color",
                            style: {
                                backgroundColor:
                                    STRATEGY_COLORS["Invest_qurilish"],
                            },
                        }),
                        React.createElement("span", null, TEXTS.investConstruction)
                    ),
                    React.createElement(
                        "div",
                        { className: "legend-item" },
                        React.createElement("div", {
                            className: "legend-color",
                            style: {
                                backgroundColor: "red",
                            },
                        }),
                        React.createElement("span", null, TEXTS.renovatsiyaProjects)
                    ),
                    React.createElement(
                        "div",
                        { className: "legend-item" },
                        React.createElement("div", {
                            className: "legend-color",
                            style: {
                                backgroundColor:
                                    STRATEGY_COLORS["Qizil_chiziqlar"],
                            },
                        }),
                        React.createElement("span", null, TEXTS.redLines)
                    )
                );

            // Enhanced Sidebar Component
            const Sidebar = ({ isOpen, onClose, item }) =>
                React.createElement(
                    "div",
                    { className: `sidebar ${isOpen ? "open" : ""}` },
                    React.createElement(
                        "div",
                        { className: "sidebar-header" },
                        React.createElement(
                            "div",
                            null,
                            React.createElement(
                                "h2",
                                { className: "sidebar-title" },
                                item?.property_name ||
                                    item?.neighborhood_name ||
                                    item?.mahalla_nomi ||
                                    item?.funksiya ||
                                    item?.["Объект_номи"] ||
                                    item?.["Манзил(МФЙ,кўча)"] ||
                                    TEXTS.objectDetails
                            ),
                            (item?.district_name ||
                                item?.district ||
                                item?.["Туман"]) &&
                                React.createElement(
                                    "div",
                                    { className: "app-subtitle" },
                                    item.district_name ||
                                        item.district ||
                                        item["Туман"]
                                )
                        ),
                        React.createElement(
                            "button",
                            { className: "close-btn", onClick: onClose },
                            React.createElement("i", {
                                className: "fas fa-times",
                            })
                        )
                    ),
                    React.createElement(
                        "div",
                        { className: "sidebar-content" },
                        item &&
                            React.createElement(
                                "div",
                                null,
                                // Basic Information Section
                                React.createElement(
                                    "div",
                                    { className: "section" },
                                    React.createElement(
                                        "h3",
                                        { className: "section-title" },
                                        React.createElement("i", {
                                            className: "fas fa-info-circle",
                                        }),
                                        TEXTS.basicInfo
                                    ),
                                    React.createElement(
                                        "table",
                                        { className: "info-table" },
                                        React.createElement(
                                            "tbody",
                                            null,
                                            // Name
                                            React.createElement(
                                                "tr",
                                                null,
                                                React.createElement(
                                                    "td",
                                                    null,
                                                    TEXTS.name + ":"
                                                ),
                                                React.createElement(
                                                    "td",
                                                    null,
                                                    item.property_name ||
                                                        item.neighborhood_name ||
                                                        item.mahalla_nomi ||
                                                        item["Объект_номи"] ||
                                                        item[
                                                            "Манзил_(МФЙ,_кўча)"
                                                        ] ||
                                                        item.funksiya ||
                                                        "N/A"
                                                )
                                            ),
                                            // Strategy/Type
                                            React.createElement(
                                                "tr",
                                                null,
                                                React.createElement(
                                                    "td",
                                                    null,
                                                    TEXTS.strategy + ":"
                                                ),
                                                React.createElement(
                                                    "td",
                                                    null,
                                                    React.createElement(
                                                        "span",
                                                        {
                                                            className: `badge badge-${
                                                                item.strategiya ===
                                                                "Konservatsiya"
                                                                    ? "conservation"
                                                                    : item.strategiya ===
                                                                      "Rekonstruktsiya"
                                                                    ? "reconstruction"
                                                                    : item.strategiya ===
                                                                      "Yangi_qurilish"
                                                                    ? "new-construction"
                                                                    : item.strategiya ===
                                                                      "Invest_qurilish"
                                                                    ? "new-construction"
                                                                    : item.funksiya ===
                                                                      "Qizil_chiziqlar"
                                                                    ? "red-line"
                                                                    : item[
                                                                          "Таклиф_тури_(Реновация,_Инвестиция,_Аукцион)"
                                                                      ] ===
                                                                      "Реновация"
                                                                    ? "renovation"
                                                                    : item[
                                                                          "Таклиф_тури_(Реновация,_Инвестиция,_Аукцион)"
                                                                      ] ===
                                                                      "Аукцион"
                                                                    ? "auction"
                                                                    : "investment"
                                                            }`,
                                                        },
                                                        formatStrategy(
                                                            item.strategiya
                                                        ) ||
                                                            formatStrategy(
                                                                item.type
                                                            ) ||
                                                            item[
                                                                "Таклиф_тури_(Реновация,_Инвестиция,_Аукцион)"
                                                            ] ||
                                                            formatFunction(
                                                                item.funksiya
                                                            ) ||
                                                            "N/A"
                                                    )
                                                )
                                            ),
                                            // Function
                                            item.funksiya &&
                                                React.createElement(
                                                    "tr",
                                                    null,
                                                    React.createElement(
                                                        "td",
                                                        null,
                                                        TEXTS.function + ":"
                                                    ),
                                                    React.createElement(
                                                        "td",
                                                        null,
                                                        formatFunction(
                                                            item.funksiya
                                                        )
                                                    )
                                                ),
                                            // District/Region
                                            React.createElement(
                                                "tr",
                                                null,
                                                React.createElement(
                                                    "td",
                                                    null,
                                                    TEXTS.district + ":"
                                                ),
                                                React.createElement(
                                                    "td",
                                                    null,
                                                    item.district_name ||
                                                        item.district ||
                                                        item.region_name ||
                                                        item["Туман"] ||
                                                        "N/A"
                                                )
                                            ),
                                            // Area
                                            React.createElement(
                                                "tr",
                                                null,
                                                React.createElement(
                                                    "td",
                                                    null,
                                                    TEXTS.area + ":"
                                                ),
                                                React.createElement(
                                                    "td",
                                                    null,
                                                    item.area_hectare
                                                        ? `${item.area_hectare} га`
                                                        : item.maydoni
                                                        ? formatArea(
                                                              item.maydoni *
                                                                  10000
                                                          )
                                                        : item.land_area
                                                        ? `${item.land_area} га`
                                                        : item[
                                                              "Таклиф_Ер_майдони_(га)"
                                                          ]
                                                        ? `${item["Таклиф_Ер_майдони_(га)"]} га`
                                                        : item["SHAPE__Area"]
                                                        ? formatArea(
                                                              item[
                                                                  "SHAPE__Area"
                                                              ]
                                                          )
                                                        : "N/A"
                                                )
                                            ),
                                            // Building Area (for aktivs)
                                            item.total_building_area &&
                                                React.createElement(
                                                    "tr",
                                                    null,
                                                    React.createElement(
                                                        "td",
                                                        null,
                                                        "Умумий бино майдони:"
                                                    ),
                                                    React.createElement(
                                                        "td",
                                                        null,
                                                        `${item.total_building_area} м²`
                                                    )
                                                ),
                                            // Residential Area
                                            (item.residential_area ||
                                                item["Яшаш_майдон"]) &&
                                                React.createElement(
                                                    "tr",
                                                    null,
                                                    React.createElement(
                                                        "td",
                                                        null,
                                                        "Яшаш майдони:"
                                                    ),
                                                    React.createElement(
                                                        "td",
                                                        null,
                                                        `${
                                                            item.residential_area ||
                                                            item["Яшаш_майдон"]
                                                        } м²`
                                                    )
                                                ),
                                            // Floors
                                            (item.designated_floors ||
                                                item.proposed_floors ||
                                                item["Этажность"]) &&
                                                React.createElement(
                                                    "tr",
                                                    null,
                                                    React.createElement(
                                                        "td",
                                                        null,
                                                        "Қаватлар:"
                                                    ),
                                                    React.createElement(
                                                        "td",
                                                        null,
                                                        item.designated_floors
                                                            ? `${
                                                                  item.designated_floors
                                                              } (белгиланган) / ${
                                                                  item.proposed_floors ||
                                                                  "N/A"
                                                              } (таклиф)`
                                                            : item[
                                                                  "Этажность"
                                                              ] || "N/A"
                                                    )
                                                ),
                                            // Investor
                                            item.investor &&
                                                React.createElement(
                                                    "tr",
                                                    null,
                                                    React.createElement(
                                                        "td",
                                                        null,
                                                        "Инвестор:"
                                                    ),
                                                    React.createElement(
                                                        "td",
                                                        null,
                                                        item.investor
                                                    )
                                                ),
                                            // Price
                                            (item.start_price ||
                                                item.sold_price) &&
                                                React.createElement(
                                                    "tr",
                                                    null,
                                                    React.createElement(
                                                        "td",
                                                        null,
                                                        TEXTS.price + ":"
                                                    ),
                                                    React.createElement(
                                                        "td",
                                                        null,
                                                        `${Number(
                                                            item.start_price ||
                                                                item.sold_price
                                                        ).toLocaleString(
                                                            "uz-UZ"
                                                        )} сум`
                                                    )
                                                )
                                        )
                                    )
                                ),
                                // Image Section
                                item.main_image &&
                                    React.createElement(
                                        "div",
                                        { className: "section" },
                                        React.createElement(
                                            "h3",
                                            { className: "section-title" },
                                            React.createElement("i", {
                                                className: "fas fa-image",
                                            }),
                                            TEXTS.image
                                        ),
                                        React.createElement("img", {
                                            src: item.main_image,
                                            alt:
                                                item.property_name ||
                                                item.neighborhood_name ||
                                                "Property",
                                            style: {
                                                width: "100%",
                                                maxHeight: "200px",
                                                objectFit: "cover",
                                                borderRadius:
                                                    "var(--border-radius)",
                                                boxShadow: "var(--shadow)",
                                            },
                                            onError: (e) =>
                                                (e.target.style.display =
                                                    "none"),
                                        })
                                    )
                            )
                    )
                );

            // Layer Controls Component
            const LayerControls = ({ layers, onToggle, counts }) =>
                React.createElement(
                    "div",
                    { className: "control-panel layer-controls" },
                    React.createElement(
                        "h3",
                        { className: "control-title" },
                        React.createElement("i", {
                            className: "fas fa-layer-group",
                        }),
                        TEXTS.mapLayers
                    ),
                    Object.entries(layers).map(([key, layer]) =>
                        React.createElement(
                            "button",
                            {
                                key: key,
                                className: `layer-button ${
                                    layer.visible ? "active" : ""
                                }`,
                                onClick: () => onToggle(key),
                            },
                            React.createElement(
                                "div",
                                { className: "layer-button-content" },
                                React.createElement(
                                    "div",
                                    { className: "layer-icon" },
                                    React.createElement("i", {
                                        className: layer.icon,
                                    })
                                ),
                                React.createElement("span", null, layer.name)
                            ),
                            React.createElement(
                                "span",
                                { className: "count-badge" },
                                counts[key] || 0
                            )
                        )
                    ),
                    React.createElement(Legend)
                );

            // Map Style Controls Component
            const MapStyleControls = ({ currentStyle, onStyleChange }) =>
                React.createElement(
                    "div",
                    { className: "control-panel map-style-controls" },
                    React.createElement(
                        "h3",
                        { className: "control-title" },
                        React.createElement("i", { className: "fas fa-map" }),
                        TEXTS.mapStyle
                    ),
                    Object.entries(MAP_STYLES).map(([key, style]) =>
                        React.createElement(
                            "button",
                            {
                                key: key,
                                className: `style-button ${
                                    currentStyle === key ? "active" : ""
                                }`,
                                onClick: () => onStyleChange(key),
                            },
                            style.name
                        )
                    )
                );

            // GeoJSON Controls Component
            const GeoJSONControls = ({
                geoJsonLayers,
                onLoad,
                onToggle,
                onRemove,
                onClear,
                status,
                filepath,
                setFilepath,
            }) =>
                React.createElement(
                    "div",
                    { className: "control-panel geojson-controls" },
                    React.createElement(
                        "h3",
                        { className: "control-title" },
                        React.createElement("i", {
                            className: "fas fa-file-code",
                        }),
                        TEXTS.geojsonManager
                    ),
                    React.createElement(
                        "div",
                        { className: "file-input-group" },
                        React.createElement("input", {
                            type: "text",
                            className: "file-input",
                            placeholder: "/path/to/file.geojson",
                            value: filepath,
                            onChange: (e) => setFilepath(e.target.value),
                        }),
                        React.createElement(
                            "div",
                            { className: "button-group" },
                            React.createElement(
                                "button",
                                { className: "primary-btn", onClick: onLoad },
                                React.createElement("i", {
                                    className: "fas fa-upload",
                                }),
                                TEXTS.load
                            ),
                            React.createElement(
                                "button",
                                {
                                    className: "secondary-btn",
                                    onClick: onClear,
                                },
                                React.createElement("i", {
                                    className: "fas fa-trash",
                                }),
                                TEXTS.clearAll
                            )
                        )
                    ),
                    status &&
                        React.createElement(
                            "div",
                            { className: "status-text" },
                            status
                        ),
                    geoJsonLayers.size > 0 &&
                        React.createElement(
                            "div",
                            { className: "layer-list" },
                            Array.from(geoJsonLayers.entries()).map(
                                ([layerId, layerData]) =>
                                    React.createElement(
                                        "div",
                                        {
                                            key: layerId,
                                            className: "layer-item",
                                        },
                                        React.createElement(
                                            "span",
                                            {
                                                className: "layer-name",
                                                title: layerId,
                                            },
                                            layerId
                                        ),
                                        React.createElement(
                                            "div",
                                            { className: "layer-actions" },
                                            React.createElement(
                                                "button",
                                                {
                                                    className: `action-btn toggle-btn ${
                                                        layerData.visible
                                                            ? ""
                                                            : "hidden"
                                                    }`,
                                                    onClick: () =>
                                                        onToggle(layerId),
                                                },
                                                layerData.visible
                                                    ? TEXTS.show
                                                    : TEXTS.hide
                                            ),
                                            React.createElement(
                                                "button",
                                                {
                                                    className:
                                                        "action-btn remove-btn",
                                                    onClick: () =>
                                                        onRemove(layerId),
                                                },
                                                TEXTS.remove
                                            )
                                        )
                                    )
                            )
                        )
                );

            // Main App Component
            const InvestUzMap = () => {
                // State Management
                const [loading, setLoading] = useState(true);
                const [toasts, setToasts] = useState([]);
                const [sidebarOpen, setSidebarOpen] = useState(false);
                const [selectedItem, setSelectedItem] = useState(null);
                const [currentMapStyle, setCurrentMapStyle] = useState("osm");
                const [geoJsonFilepath, setGeoJsonFilepath] = useState(
                    "./tashkent_master_plan.geojson"
                );
                const [geoJsonStatus, setGeoJsonStatus] = useState(
                    "GeoJSON файллари учун тайёр..."
                );

                // Enhanced layer state
                const [layers, setLayers] = useState({
                    jsonData: {
                        name: TEXTS.jsonData,
                        icon: "fas fa-layer-group",
                        visible: false,
                    },
                    auction: {
                        name: TEXTS.auctions,
                        icon: "fas fa-gavel",
                        visible: false,
                    },
                    sold: {
                        name: TEXTS.soldProperties,
                        icon: "fas fa-check-circle",
                        visible: false,
                    },
                    kmz: {
                        name: TEXTS.kmzData,
                        icon: "fas fa-file-archive",
                        visible: false,
                    },
                    renovatsiyaProjects: {
                        name: TEXTS.renovatsiyaProjects,
                        icon: "fas fa-building",
                        visible: false,
                    },
                });

                const [counts, setCounts] = useState({
                    aktivs: 0,
                    jsonData: 0,
                    auction: 0,
                    sold: 0,
                    kmz: 0,
                    renovatsiyaProjects: 0,
                    geojson: 0,
                });

                // Refs
                const mapRef = useRef(null);
                const mapInstanceRef = useRef(null);
                const layerGroupsRef = useRef({});
                const geoJsonLayersRef = useRef(new Map());

                // Make refs globally accessible
                window.mapInstanceRef = mapInstanceRef;
                window.layerGroupsRef = layerGroupsRef;

                // Toast Management
                const addToast = useCallback((message, type = "info") => {
                    const id = Date.now();
                    setToasts((prev) => [...prev, { id, message, type }]);
                    setTimeout(() => {
                        setToasts((prev) =>
                            prev.filter((toast) => toast.id !== id)
                        );
                    }, 5000);
                }, []);

                const removeToast = useCallback((id) => {
                    setToasts((prev) =>
                        prev.filter((toast) => toast.id !== id)
                    );
                }, []);

                // Map Initialization
                const initializeMap = useCallback(() => {
                    if (!mapRef.current || mapInstanceRef.current) return;

                    const map = L.map(mapRef.current, {
                        center: [41.311, 69.279],
                        zoom: 11,
                        minZoom: 10,
                        maxZoom: 18,
                        preferCanvas: true,
                    });

                    // Initialize layer groups
                    const groups = {
                        aktivs: L.markerClusterGroup({
                            chunkedLoading: true,
                            maxClusterRadius: 40,
                        }),
                        jsonData: L.markerClusterGroup({
                            chunkedLoading: true,
                            maxClusterRadius: 40,
                        }),
                        auction: L.markerClusterGroup({
                            chunkedLoading: true,
                            maxClusterRadius: 40,
                        }),
                        sold: L.markerClusterGroup({
                            chunkedLoading: true,
                            maxClusterRadius: 40,
                        }),
                        kmz: L.markerClusterGroup({
                            chunkedLoading: true,
                            maxClusterRadius: 40,
                        }),
                        renovatsiyaProjects: L.featureGroup(),
                        geojson: L.featureGroup(),
                    };

                    Object.entries(groups).forEach(([key, group]) => {
                        if (layers[key]?.visible) {
                            map.addLayer(group);
                        }
                    });

                    layerGroupsRef.current = groups;

                    const osmLayer = L.tileLayer(MAP_STYLES.osm.url, {
                        attribution: MAP_STYLES.osm.attribution,
                    });
                    osmLayer.addTo(map);

                    mapInstanceRef.current = map;
                    initProj4();
                }, [layers]);

                // Enhanced createKMZLayer function
                const createKMZLayer = useCallback((feature, lotData) => {
                    if (!feature.geometry || !feature.geometry.coordinates)
                        return null;

                    const geomType = feature.geometry.type;
                    let layer = null;

                    try {
                        switch (geomType) {
                            case "Point":
                                const coords = convertCoordinates(
                                    feature.geometry.coordinates
                                );
                                if (!coords) return null;
                                layer = L.marker(coords, {
                                    icon: createMarkerIcon("kmz"),
                                });
                                break;

                            case "Polygon":
                                const rings = feature.geometry.coordinates
                                    .map((ring) =>
                                        ring
                                            .map((coord) =>
                                                convertCoordinates(coord)
                                            )
                                            .filter(Boolean)
                                    )
                                    .filter((ring) => ring.length > 0);
                                if (rings.length === 0) return null;
                                layer = L.polygon(rings, {
                                    fillColor: "#22f50b",
                                    weight: 2,
                                    opacity: 0.8,
                                    color: "#ffffff",
                                    fillOpacity: 0.6,
                                });
                                break;

                            case "LineString":
                                const latLngs = feature.geometry.coordinates
                                    .map((coord) => convertCoordinates(coord))
                                    .filter(Boolean);
                                if (latLngs.length === 0) return null;
                                layer = L.polyline(latLngs, {
                                    color: "#f59e0b",
                                    weight: 3,
                                    opacity: 0.8,
                                });
                                break;

                            default:
                                return null;
                        }

                        if (layer) {
                            const popup = `
        <div class="popup-header">KMZ: ${
            lotData.neighborhood_name || "Объект"
        }</div>
        <div class="popup-details">
            <p><strong>Тур:</strong> <span class="badge badge-renovation">KMZ маълумот</span></p>
            <p><strong>${TEXTS.district}:</strong> ${
                                lotData.district_name || "N/A"
                            }</p>
            <p><strong>${TEXTS.area}:</strong> ${
                                lotData.area_hectare || "N/A"
                            } га</p>
            <p><strong>Умумий бино майдони:</strong> ${
                lotData.total_building_area || "N/A"
            } м²</p>
            <p><strong>Яшаш майдони:</strong> ${
                lotData.residential_area || "N/A"
            } м²</p>
            <p><strong>Қаватлар:</strong> ${
                lotData.designated_floors || "N/A"
            } (белгиланган) / ${lotData.proposed_floors || "N/A"} (таклиф)</p>
            <p><strong>УМН коэффициенти:</strong> ${
                lotData.umn_coefficient || "N/A"
            }</p>
            <p><strong>ҚМН фоизи:</strong> ${
                lotData.qmn_percentage ? lotData.qmn_percentage + "%" : "N/A"
            }</p>
            <p><strong>Инвестор:</strong> ${lotData.investor || "N/A"}</p>
            <p><strong>Қарор рақами:</strong> ${
                lotData.decision_number || "N/A"
            }</p>
            <p><strong>Кадастр гувоҳномаси:</strong> ${
                lotData.cadastre_certificate || "N/A"
            }</p>
            <p><strong>Ҳудуд стратегияси:</strong> ${
                lotData.area_strategy || "N/A"
            }</p>
            <p><strong>Статус:</strong> ${lotData.status || "N/A"}</p>
            ${
                lotData.object_information
                    ? `<p><strong>Объект маълумоти:</strong> ${lotData.object_information}</p>`
                    : ""
            }
            ${
                lotData.additional_information
                    ? `<p><strong>Қўшимча маълумот:</strong> ${lotData.additional_information}</p>`
                    : ""
            }
            ${
                lotData.documents && lotData.documents.length > 0
                    ? `
                <div style="margin-top: 10px;">
                    <strong>Ҳужжатлар:</strong>
                    ${lotData.documents
                        .map(
                            (doc) => `
                        <div style="margin: 5px 0;">
                            <a href="${doc.url.replace(
                                "http://localhost/",
                                "http://127.0.0.1:8000/"
                            )}"
                               target="_blank"
                               style="color: #2563eb; text-decoration: none; font-size: 12px;">
                                ${
                                    doc.doc_type === "pdf-document"
                                        ? "📄"
                                        : doc.doc_type === "kmz-document"
                                        ? "🗺️"
                                        : "📎"
                                } ${doc.filename}
                            </a>
                        </div>
                    `
                        )
                        .join("")}
                </div>
            `
                    : ""
            }
        </div>
    `;
                            layer.bindPopup(popup, { maxWidth: 450 });
                            layer.kmzData = { ...lotData, kmzFeature: feature };

                            // IMMEDIATELY register with KMZ search manager
                            if (
                                window.kmzSearchManager &&
                                window.kmzSearchManager.isInitialized
                            ) {
                                window.kmzSearchManager.addKMZItem(
                                    lotData,
                                    layer
                                );
                            } else {
                                // Store for later pickup
                                if (!window.pendingKMZItems) {
                                    window.pendingKMZItems = [];
                                }
                                window.pendingKMZItems.push({
                                    data: lotData,
                                    layer: layer,
                                });
                            }
                        }
                        return layer;
                    } catch (error) {
                        console.warn("Error creating KMZ layer:", error);
                        return null;
                    }
                }, []);

                // Data Fetching Functions
                const fetchAktivsData = useCallback(async () => {
                    try {
                        const response = await fetch(API_ENDPOINTS.aktivs);
                        if (!response.ok)
                            throw new Error(
                                `API request failed: ${response.status}`
                            );

                        const data = await response.json();
                        const lots = data.lots || data || [];

                        let processed = 0;
                        let kmzProcessed = 0;
                        const group = layerGroupsRef.current.aktivs;
                        const kmzGroup = layerGroupsRef.current.kmz;

                        for (const lot of lots) {
                            if (!lot) continue;

                            if (lot.lat && lot.lng) {
                                const marker = L.marker(
                                    [parseFloat(lot.lat), parseFloat(lot.lng)],
                                    {
                                        icon: createMarkerIcon("regular"),
                                    }
                                );

                                const popup = `
                                    <div class="popup-header">${
                                        lot.neighborhood_name || "Активс мулки"
                                    }</div>
                                    ${
                                        lot.main_image
                                            ? `<img src="${lot.main_image}" class="popup-image" onerror="this.style.display='none'">`
                                            : ""
                                    }
                                    <div class="popup-details">
                                        <p><strong>${
                                            TEXTS.district
                                        }:</strong> ${
                                    lot.district_name || "N/A"
                                }</p>
                                        <p><strong>${TEXTS.area}:</strong> ${
                                    lot.area_hectare || "N/A"
                                } га</p>
                                        <p><strong>Статус:</strong> <span class="badge badge-investment">Активс</span></p>
                                    </div>
                                    <button class="details-btn" onclick="window.showDetails('${
                                        lot.id || processed
                                    }', 'aktivs')">
                                        ${TEXTS.viewDetails}
                                    </button>
                                `;

                                marker.bindPopup(popup, { maxWidth: 300 });
                                marker.lotData = lot;
                                group.addLayer(marker);
                                processed++;
                            }

                            // Process KMZ files
                            if (lot.documents && Array.isArray(lot.documents)) {
                                const kmzDocs = lot.documents.filter(
                                    (doc) =>
                                        doc.doc_type === "kmz-document" &&
                                        doc.url
                                );
                                for (const kmzDoc of kmzDocs) {
                                    try {
                                        const geoJSON = await processKMZFile(
                                            kmzDoc.url
                                        );
                                        if (geoJSON && geoJSON.features) {
                                            geoJSON.features.forEach(
                                                (feature) => {
                                                    const layer =
                                                        createKMZLayer(
                                                            feature,
                                                            lot
                                                        );
                                                    if (layer) {
                                                        kmzGroup.addLayer(
                                                            layer
                                                        );
                                                        kmzProcessed++;
                                                    }
                                                }
                                            );
                                        }
                                    } catch (error) {
                                        console.warn(
                                            `Failed to process KMZ for lot ${lot.id}:`,
                                            error
                                        );
                                    }
                                }
                            }
                        }

                        setCounts((prev) => ({
                            ...prev,
                            aktivs: processed,
                            kmz: prev.kmz + kmzProcessed,
                        }));
                        if (processed > 0 || kmzProcessed > 0) {
                            // addToast(
                            //     `${TEXTS.successLoaded}: ${processed} активс, ${kmzProcessed} KMZ`,
                            //     "success"
                            // );
                        }
                        return processed > 0 || kmzProcessed > 0;
                    } catch (error) {
                        console.error("Error fetching aktivs data:", error);
                        addToast(
                            `${TEXTS.errorLoading}: Активс маълумотлар`,
                            "error"
                        );
                        return false;
                    }
                }, [addToast, createKMZLayer]);


                const fetchJsonData = useCallback(async () => {
                    try {
                        const response = await fetch(API_ENDPOINTS.jsonData);
                        if (!response.ok) return false;

                        const data = await response.json();
                        if (!Array.isArray(data)) return false;

                        let processed = 0;
                        const group = layerGroupsRef.current.jsonData;

                        data.forEach((item, index) => {
                            const coordinates = extractCoordinatesFromUrl(
                                item["Таклиф_Харита"] || item["ТаклифХарита"]
                            );
                            if (!coordinates) return;

                            const type =
                                item[
                                    "Таклиф_тури_(Реновация,_Инвестиция,_Аукцион)"
                                ] ||
                                item[
                                    "Таклифтури(Реновация,Инвестиция,Аукцион)"
                                ];
                            let markerType = "investment";
                            if (type === "Реновация") markerType = "renovation";
                            else if (type === "Аукцион") markerType = "auction";

                            const marker = L.marker(coordinates, {
                                icon: createMarkerIcon(markerType),
                            });

                            const popup = `
    <div class="popup-header">${
        item["Манзил_(МФЙ,_кўча)"] || item["Манзил(МФЙ,кўча)"] || "JSON объект"
    }</div>
    <div class="popup-details">
        <p><strong>№:</strong> ${item["№"] || "N/A"}</p>
        <p><strong>Тур:</strong> <span class="badge badge-${markerType}">${
                                type || "Номаълум"
                            }</span></p>
        <p><strong>${TEXTS.district}:</strong> ${item["Туман"] || "N/A"}</p>
        <p><strong>${TEXTS.area}:</strong> ${
                                item["Таклиф_Ер_майдони_(га)"] ||
                                item["ТаклифЕрмайдони(га)"] ||
                                "N/A"
                            } га</p>
        <p><strong>Бош режадаги ҳолати:</strong> ${
            item["Бош_режадаги_ҳолати_ва_қавати"] || "N/A"
        }</p>
        <p><strong>Таклиф қавати ва ҳудуд:</strong> ${
            item["Таклиф_қавати_ва_ҳудуд"] || "N/A"
        }</p>
        <p><strong>Фаолият тури:</strong> ${
            item["Таклиф_Фаолият_тури"] || "N/A"
        }</p>
        <p><strong>Фалияти филтир:</strong> ${
            item["Таклиф_Фалияти_филтир_учун"] || "N/A"
        }</p>
        <p><strong>Этажность:</strong> ${item["Этажность"] || "N/A"}</p>
        <p><strong>Қурилиш ости майдони:</strong> ${
            item["Қурилиш_ости_майдони"]
                ? item["Қурилиш_ости_майдони"] + " м²"
                : "N/A"
        }</p>
        <p><strong>Бинонинг умумий майдони:</strong> ${
            item["Бинонинг_умумий_майдони"]
                ? item["Бинонинг_умумий_майдони"] + " м²"
                : "N/A"
        }</p>
        <p><strong>Хизмат кўрсатиш сохаси:</strong> ${
            item["Хизмат_кўрсатиш_сохаси"]
                ? item["Хизмат_кўрсатиш_сохаси"] + " м²"
                : "N/A"
        }</p>
        <p><strong>Яшаш майдон:</strong> ${
            item["Яшаш_майдон"] ? item["Яшаш_майдон"] + " м²" : "N/A"
        }</p>
        <p><strong>Хонадонлар сони:</strong> ${
            item["хонадонлар_сони"]
                ? Math.round(item["хонадонлар_сони"])
                : "N/A"
        }</p>
        <p><strong>Аҳоли сони:</strong> ${
            item["Ахоли_сони"] ? Math.round(item["Ахоли_сони"]) : "N/A"
        }</p>
        <p><strong>Бош режага киритилганлиги:</strong>
            <span class="badge ${
                item[
                    "Таклиф_Бош_режага_таклиф_киритилганлиги_(таклиф_берилган_лекин_киритилмаган_бўлас_КИРИТИЛМАГАН_хисобланади)"
                ] === "Киритилган"
                    ? "badge-sold"
                    : "badge-auction"
            }">
                ${
                    item[
                        "Таклиф_Бош_режага_таклиф_киритилганлиги_(таклиф_берилган_лекин_киритилмаган_бўлас_КИРИТИЛМАГАН_хисобланади)"
                    ] || "N/A"
                }
            </span>
        </p>
        ${
            item["Таклиф_Харита"]
                ? `
            <div style="margin-top: 10px;">
                <a href="${item["Таклиф_Харита"]}" target="_blank" style="color: #2563eb; text-decoration: none;">
                    🗺️ Харитада кўриш
                </a>
            </div>
        `
                : ""
        }
    </div>
`;

                            marker.bindPopup(popup, { maxWidth: 300 });
                            marker.itemData = item;
                            group.addLayer(marker);
                            processed++;
                        });

                        setCounts((prev) => ({ ...prev, jsonData: processed }));
                        if (processed > 0)
                            addToast(
                                `${TEXTS.successLoaded}: ${processed} JSON объект`,
                                "success"
                            );
                        return processed > 0;
                    } catch (error) {
                        console.error("Error fetching JSON data:", error);
                        return false;
                    }
                }, [addToast]);


                const fetchAuctionData = useCallback(async () => {
                    try {
                        const response = await fetch(API_ENDPOINTS.auction);
                        if (!response.ok) return false;

                        const data = await response.json();
                        const lots = data.lots || [];

                        let processed = 0;
                        const group = layerGroupsRef.current.auction;

                        lots.forEach((lot, index) => {
                            if (!lot.lat || !lot.lng) return;

                            const marker = L.marker(
                                [parseFloat(lot.lat), parseFloat(lot.lng)],
                                {
                                    icon: createMarkerIcon("auction"),
                                }
                            );

                            const popup = `
    <div class="popup-header">${lot.property_name || "Аукцион мулки"}</div>
    ${
        lot.main_image
            ? `<img src="${lot.main_image}" class="popup-image" onerror="this.style.display='none'">`
            : ""
    }
    <div class="popup-details">
        <p><strong>Лот рақами:</strong> ${lot.lot_number || "N/A"}</p>
        <p><strong>Бошланғич нарх:</strong> ${
            lot.start_price
                ? Number(lot.start_price).toLocaleString("uz-UZ") + " сум"
                : "N/A"
        }</p>
        <p><strong>Аукцион санаси:</strong> ${lot.auction_date || "N/A"}</p>
        <p><strong>Ариза мухлати:</strong> ${
            lot.application_deadline || "N/A"
        }</p>
        <p><strong>Вилоят:</strong> ${lot.region || "N/A"}</p>
        <p><strong>Ҳудуд:</strong> ${lot.area || "N/A"}</p>
        <p><strong>Манзил:</strong> ${lot.address || "N/A"}</p>
        <p><strong>${TEXTS.area}:</strong> ${lot.land_area || "N/A"} га</p>
        <p><strong>Қурилиш майдони:</strong> ${
            lot.building_area ? lot.building_area + " м²" : "N/A"
        }</p>
        <p><strong>Қурилиш турлари:</strong> ${lot.build_types || "N/A"}</p>
        <p><strong>Ҳуқуқий тур:</strong> ${lot.law_type || "N/A"}</p>
        <p><strong>Мулк гуруҳи:</strong> ${lot.property_group || "N/A"}</p>
        <p><strong>Мулк категорияси:</strong> ${
            lot.property_category || "N/A"
        }</p>
        <p><strong>Лот ҳолати:</strong> ${lot.lot_status || "N/A"}</p>
        <p><strong>Тўлов тури:</strong> ${lot.payment_type || "N/A"}</p>
        <p><strong>Савдо тури:</strong> ${lot.trade_type || "N/A"}</p>
        ${
            lot.contract_number
                ? `<p><strong>Шартнома рақами:</strong> ${lot.contract_number}</p>`
                : ""
        }
        ${
            lot.contract_date
                ? `<p><strong>Шартнома санаси:</strong> ${lot.contract_date}</p>`
                : ""
        }
        <p><strong>Ҳолат:</strong> <span class="badge badge-auction">Аукцион</span></p>
        ${
            lot.lot_link
                ? `
            <div style="margin-top: 10px;">
                <a href="${lot.lot_link}" target="_blank" style="color: #2563eb; text-decoration: none;">
                    🔗 Лотни кўриш
                </a>
            </div>
        `
                : ""
        }
    </div>
`;
                            marker.bindPopup(popup, { maxWidth: 300 });
                            marker.auctionData = lot;
                            group.addLayer(marker);
                            processed++;
                        });

                        setCounts((prev) => ({ ...prev, auction: processed }));
                        if (processed > 0)
                            addToast(
                                `${TEXTS.successLoaded}: ${processed} аукцион мулки`,
                                "success"
                            );
                        return processed > 0;
                    } catch (error) {
                        console.error("Error fetching auction data:", error);
                        return false;
                    }
                }, [addToast]);

                const fetchSoldData = useCallback(async () => {
                    try {
                        const response = await fetch(API_ENDPOINTS.sold);
                        if (!response.ok) return false;

                        const data = await response.json();
                        const lots = data.lots || [];

                        let processed = 0;
                        const group = layerGroupsRef.current.sold;

                        lots.forEach((lot, index) => {
                            if (!lot.lat || !lot.lng) return;

                            const marker = L.marker(
                                [parseFloat(lot.lat), parseFloat(lot.lng)],
                                {
                                    icon: createMarkerIcon("sold"),
                                }
                            );

                            const popup = `
    <div class="popup-header">🏆 ${lot.property_name || "Сотилган мулк"}</div>
    ${
        lot.main_image
            ? `<img src="${lot.main_image}" class="popup-image" onerror="this.style.display='none'">`
            : ""
    }
    <div class="popup-details">
        <p><strong>Лот рақами:</strong> ${lot.lot_number || "N/A"}</p>
        <p><strong>Сотилди:</strong> ${
            lot.sold_price
                ? Number(lot.sold_price).toLocaleString("uz-UZ") + " сум"
                : "N/A"
        }</p>
        <p><strong>Бошланғич нарх:</strong> ${
            lot.start_price
                ? Number(lot.start_price).toLocaleString("uz-UZ") + " сум"
                : "N/A"
        }</p>
        <p><strong>Ғолиб:</strong> ${lot.winner_name || "N/A"}</p>
        <p><strong>Ғолиб телефони:</strong> ${lot.winner_phone || "N/A"}</p>
        <p><strong>Аукцион санаси:</strong> ${lot.auction_date || "N/A"}</p>
        <p><strong>Аукцион санаси ҳолати:</strong> ${
            lot.auction_date_status || "N/A"
        }</p>
        <p><strong>Майдон:</strong> ${lot.land_area || "N/A"} га</p>
        <p><strong>Майдон изоҳи:</strong> ${lot.land_area_comment || "N/A"}</p>
        <p><strong>Манзил:</strong> ${lot.address || "N/A"}</p>
        <p><strong>Қурилиш тури:</strong> ${lot.building_type || "N/A"}</p>
        <p><strong>Қурилиш тури изоҳи:</strong> ${
            lot.building_type_comment || "N/A"
        }</p>
        <p><strong>Кадастр рақами:</strong> ${lot.kadastr_raqami || "N/A"}</p>
        <p><strong>Зона:</strong> ${lot.zone || "N/A"}</p>
        <p><strong>Тўлов тури:</strong> ${lot.payment_type || "N/A"}</p>
        <p><strong>Фойдаланувчи:</strong> ${lot.user_name || "N/A"}</p>
        <p><strong>Электрон почта:</strong> ${lot.user_email || "N/A"}</p>
        <p><strong>Ҳолат:</strong> <span class="badge badge-sold">✅ Сотилган</span></p>
        ${
            lot.lot_link
                ? `
            <div style="margin-top: 10px;">
                <a href="${lot.lot_link}" target="_blank" style="color: #2563eb; text-decoration: none;">
                    🔗 Лотни кўриш
                </a>
            </div>
        `
                : ""
        }
    </div>
`;

                            marker.bindPopup(popup, { maxWidth: 300 });
                            marker.soldData = lot;
                            group.addLayer(marker);
                            processed++;
                        });

                        setCounts((prev) => ({ ...prev, sold: processed }));
                        if (processed > 0)
                            addToast(
                                `${TEXTS.successLoaded}: ${processed} сотилган мулк`,
                                "success"
                            );
                        return processed > 0;
                    } catch (error) {
                        console.error("Error fetching sold data:", error);
                        return false;
                    }
                }, [addToast]);

                const fetchRenovatsiyaProjects = useCallback(async () => {
                    try {
                        const geoJSON = await processKMZFile(API_ENDPOINTS.renovatsiyaProjects);
                        if (!geoJSON || !geoJSON.features) return false;

                        let processed = 0;
                        const group = layerGroupsRef.current.renovatsiyaProjects;

                        geoJSON.features.forEach((feature) => {
                            if (!feature.geometry || !feature.geometry.coordinates) return;

                            const geomType = feature.geometry.type;
                            const properties = feature.properties || {};
                            let layer = null;

                            try {
                                switch (geomType) {
                                    case "Point":
                                        const coords = convertCoordinates(feature.geometry.coordinates);
                                        if (!coords) return;
                                        layer = L.marker(coords, {
                                            icon: createMarkerIcon("renovation"),
                                        });
                                        break;

                                    case "Polygon":
                                        const rings = feature.geometry.coordinates
                                            .map((ring) =>
                                                ring
                                                    .map((coord) => convertCoordinates(coord))
                                                    .filter(Boolean)
                                            )
                                            .filter((ring) => ring.length > 0);
                                        if (rings.length === 0) return;
                                        layer = L.polygon(rings, {
                                            fillColor: "red",
                                            weight: 2,
                                            opacity: 0.8,
                                            color: "#ffffff",
                                            fillOpacity: 0.5,
                                        });
                                        break;

                                    case "LineString":
                                        const latLngs = feature.geometry.coordinates
                                            .map((coord) => convertCoordinates(coord))
                                            .filter(Boolean);
                                        if (latLngs.length === 0) return;
                                        layer = L.polyline(latLngs, {
                                            color: "red",
                                            weight: 3,
                                            opacity: 0.8,
                                        });
                                        break;

                                    default:
                                        return;
                                }

                                if (layer) {
                                    const popup = `
    <div class="popup-header">Реновация лойиҳаси</div>
    <div class="popup-details">
        <p><strong>Тур:</strong> <span class="badge badge-renovation">Реновация лойиҳалари</span></p>
        <p><strong>Ном:</strong> ${properties.Name || properties.name || "N/A"}</p>
        <p><strong>Тавсиф:</strong> ${properties.Description || properties.description || "N/A"}</p>
        ${properties.district ? `<p><strong>Туман:</strong> ${properties.district}</p>` : ""}
        ${properties.area ? `<p><strong>Майдон:</strong> ${properties.area} га</p>` : ""}
        ${properties.status ? `<p><strong>Ҳолат:</strong> ${properties.status}</p>` : ""}
    </div>
`;
                                    layer.bindPopup(popup, { maxWidth: 300 });
                                    group.addLayer(layer);
                                    processed++;
                                }
                            } catch (error) {
                                console.warn(`Failed to process renovatsiya feature:`, error);
                            }
                        });

                        setCounts((prev) => ({ ...prev, renovatsiyaProjects: processed }));
                        if (processed > 0)
                            addToast(
                                `${TEXTS.successLoaded}: ${processed} реновация лойиҳаси`,
                                "success"
                            );
                        return processed > 0;
                    } catch (error) {
                        console.error("Error fetching renovatsiya projects:", error);
                        return false;
                    }
                }, [addToast]);

                // Layer Toggle
                const toggleLayer = useCallback((layerKey) => {
                    setLayers((prev) => {
                        const newLayers = {
                            ...prev,
                            [layerKey]: {
                                ...prev[layerKey],
                                visible: !prev[layerKey].visible,
                            },
                        };

                        const map = mapInstanceRef.current;
                        const group = layerGroupsRef.current[layerKey];

                        if (group && map) {
                            if (newLayers[layerKey].visible) {
                                map.addLayer(group);
                            } else {
                                map.removeLayer(group);
                            }
                        }

                        return newLayers;
                    });
                }, []);

                // Map Style Change
                const changeMapStyle = useCallback((styleKey) => {
                    const map = mapInstanceRef.current;
                    if (!map) return;

                    map.eachLayer((layer) => {
                        if (layer._url) {
                            map.removeLayer(layer);
                        }
                    });

                    const style = MAP_STYLES[styleKey];

                    if (styleKey === "hybrid") {
                        const baseLayer = L.tileLayer(style.baseUrl, {
                            attribution: style.attribution,
                        });
                        const labelLayer = L.tileLayer(style.labelUrl, {
                            attribution: "",
                        });
                        map.addLayer(baseLayer);
                        map.addLayer(labelLayer);
                    } else {
                        const layer = L.tileLayer(style.url, {
                            attribution: style.attribution,
                        });
                        map.addLayer(layer);
                    }

                    setCurrentMapStyle(styleKey);
                }, []);

                // GeoJSON Functions
                const loadGeoJSON = useCallback(
                    async (filepath) => {
                        if (!filepath.trim()) {
                            addToast("Файл йўлини киритинг", "error");
                            return;
                        }

                        try {
                            setGeoJsonStatus("GeoJSON юкланмоқда...");
                            const response = await fetch(filepath);
                            if (!response.ok)
                                throw new Error(
                                    `HTTP ${response.status}: ${response.statusText}`
                                );

                            const data = await response.json();
                            if (
                                !data.features ||
                                !Array.isArray(data.features)
                            ) {
                                throw new Error("Нотўғри GeoJSON формати");
                            }

                            const layerId = filepath
                                .split("/")
                                .pop()
                                .replace(/\.[^/.]+$/, "");

                            if (geoJsonLayersRef.current.has(layerId)) {
                                const existingLayer =
                                    geoJsonLayersRef.current.get(layerId);
                                mapInstanceRef.current.removeLayer(
                                    existingLayer.group
                                );
                                geoJsonLayersRef.current.delete(layerId);
                            }

                            const featureGroup = L.featureGroup();
                            let featuresProcessed = 0;

                            data.features.forEach((feature) => {
                                const layer = createGeoJSONLayer(feature);
                                if (layer) {
                                    const properties = feature.properties || feature.attributes || {};
                                    addGeoJSONPopup(layer, properties);
                                    featureGroup.addLayer(layer);
                                    featuresProcessed++;
                                }
                            });

                            geoJsonLayersRef.current.set(layerId, {
                                group: featureGroup,
                                visible: true,
                                count: featuresProcessed,
                            });

                            mapInstanceRef.current.addLayer(featureGroup);
                            setCounts((prev) => ({
                                ...prev,
                                geojson: prev.geojson + featuresProcessed,
                            }));

                            if (geoJsonLayersRef.current.size === 1) {
                                try {
                                    mapInstanceRef.current.fitBounds(
                                        featureGroup.getBounds(),
                                        { padding: [20, 20] }
                                    );
                                } catch (e) {
                                    console.warn("Could not fit bounds:", e);
                                }
                            }

                            setGeoJsonStatus(
                                `${featuresProcessed} объект юкланди`
                            );
                            // addToast(
                            //     `GeoJSON муваффақиятли юкланди: ${featuresProcessed} объект`,
                            //     "success"
                            // );
                        } catch (error) {
                            console.error("Error loading GeoJSON:", error);
                            setGeoJsonStatus(`Хатолик: ${error.message}`);
                            addToast(
                                `GeoJSON юклашда хатолик: ${error.message}`,
                                "error"
                            );
                        }
                    },
                    [addToast]
                );

                const createGeoJSONLayer = useCallback((feature) => {
                    if (!feature.geometry) return null;

                    // Handle both standard GeoJSON and ESRI format
                    let geomType = feature.geometry.type;
                    let coords = feature.geometry.coordinates;
                    const properties = feature.properties || feature.attributes || {};

                    // Convert ESRI format to GeoJSON
                    if (feature.geometry.rings && !coords) {
                        geomType = 'Polygon';
                        coords = feature.geometry.rings;
                    }

                    if (!coords) return null;

                    try {
                        switch (geomType) {
                            case "Point":
                                const latLng = convertCoordinates(coords);
                                if (!latLng) return null;

                                const isRedLine =
                                    properties.funksiya === "Qizil_chiziqlar";

                                return L.circleMarker(latLng, {
                                    radius: isRedLine ? 8 : 6,
                                    fillColor: getStrategyColor(properties),
                                    color: isRedLine ? "#ffffff" : "#fff",
                                    weight: isRedLine ? 3 : 2,
                                    opacity: 1,
                                    fillOpacity: isRedLine ? 1 : 0.8,
                                });

                            case "LineString":
                                const latLngs = coords
                                    .map((coord) => convertCoordinates(coord))
                                    .filter(Boolean);
                                if (latLngs.length === 0) return null;

                                const isRedLineString =
                                    properties.funksiya === "Qizil_chiziqlar";

                                return L.polyline(latLngs, {
                                    color: getStrategyColor(properties),
                                    weight: isRedLineString ? 5 : 3,
                                    opacity: isRedLineString ? 0.9 : 0.8,
                                    dashArray: isRedLineString
                                        ? "10, 10"
                                        : null,
                                });

                            case "Polygon":
                                const rings = coords
                                    .map((ring) =>
                                        ring
                                            .map((coord) =>
                                                convertCoordinates(coord)
                                            )
                                            .filter(Boolean)
                                    )
                                    .filter((ring) => ring.length > 0);
                                if (rings.length === 0) return null;

                                const isRedPolygon =
                                    properties.funksiya === "Qizil_chiziqlar";

                                return L.polygon(rings, {
                                    fillColor: getStrategyColor(properties),
                                    weight: isRedPolygon ? 3 : 1.5,
                                    opacity: isRedPolygon ? 1 : 0.8,
                                    color: isRedPolygon ? "#dc2626" : "#ffffff",
                                    fillOpacity: isRedPolygon ? 0.3 : 0.7,
                                    dashArray: isRedPolygon ? "5, 5" : null,
                                });

                            case "MultiPolygon":
                                const multiLatLngs = coords
                                    .map((polygon) =>
                                        polygon
                                            .map((ring) =>
                                                ring
                                                    .map((coord) =>
                                                        convertCoordinates(
                                                            coord
                                                        )
                                                    )
                                                    .filter(Boolean)
                                            )
                                            .filter((ring) => ring.length > 0)
                                    )
                                    .filter((polygon) => polygon.length > 0);
                                if (multiLatLngs.length === 0) return null;

                                const isRedMultiPolygon =
                                    properties.funksiya === "Qizil_chiziqlar";

                                return L.polygon(multiLatLngs, {
                                    fillColor: getStrategyColor(properties),
                                    weight: isRedMultiPolygon ? 3 : 1.5,
                                    opacity: isRedMultiPolygon ? 1 : 0.8,
                                    color: isRedMultiPolygon
                                        ? "#dc2626"
                                        : "#ffffff",
                                    fillOpacity: isRedMultiPolygon ? 0.3 : 0.7,
                                    dashArray: isRedMultiPolygon
                                        ? "5, 5"
                                        : null,
                                });

                            default:
                                console.warn(
                                    "Unsupported geometry type:",
                                    geomType
                                );
                                return null;
                        }
                    } catch (error) {
                        console.warn("Error creating feature layer:", error);
                        return null;
                    }
                }, []);

                const addGeoJSONPopup = useCallback((layer, properties) => {
                    if (!properties) return;

                    const title =
                        properties.mahalla_nomi ||
                        properties.name ||
                        properties.cadastral_number ||
                        "GeoJSON объект";
                    const strategy =
                        properties.strategiya ||
                        properties.strategy ||
                        properties.funksiya ||
                        "Номаълум";
                    const isRedLine = properties.funksiya === "Qizil_chiziqlar";

                    layer.bindPopup(
                        () => {
                            let content = `
                <div class="popup-header">${title}</div>
                <div class="popup-details">
                    <p><strong>${isRedLine ? "Тур" : "Стратегия"}:</strong>
                        <span class="badge badge-${
                            isRedLine
                                ? "red-line"
                                : strategy === "Konservatsiya"
                                ? "conservation"
                                : strategy === "Rekonstruktsiya"
                                ? "reconstruction"
                                : strategy === "Yangi_qurilish"
                                ? "new-construction"
                                : "investment"
                        }">${
                                isRedLine
                                    ? TEXTS.redLines
                                    : formatStrategy(strategy)
                            }</span>
                    </p>
            `;

                            // Show all available properties with proper formatting
                            if (properties.layerId)
                                content += `<p><strong>Қатлам ID:</strong> ${properties.layerId}</p>`;
                            if (properties.layerName)
                                content += `<p><strong>Қатлам номи:</strong> ${properties.layerName}</p>`;
                            if (properties.code)
                                content += `<p><strong>Код:</strong> ${properties.code}</p>`;
                            if (properties.objectid)
                                content += `<p><strong>Объект ID:</strong> ${properties.objectid}</p>`;
                            if (properties.globalid)
                                content += `<p><strong>Глобал ID:</strong> ${properties.globalid}</p>`;
                            if (properties.district)
                                content += `<p><strong>${TEXTS.district}:</strong> ${properties.district}</p>`;
                            if (properties.region_name)
                                content += `<p><strong>Регион:</strong> ${properties.region_name}</p>`;
                            if (properties.maydoni)
                                content += `<p><strong>${TEXTS.area}:</strong> ${properties.maydoni} га</p>`;
                            if (properties.SHAPE__Area)
                                content += `<p><strong>Шакл майдони:</strong> ${properties.SHAPE__Area.toFixed(
                                    2
                                )} м²</p>`;
                            if (properties.SHAPE__Length)
                                content += `<p><strong>Шакл узунлиги:</strong> ${properties.SHAPE__Length.toFixed(
                                    2
                                )} м</p>`;
                            if (properties.qavatlilik)
                                content += `<p><strong>Қаватлилик:</strong> ${properties.qavatlilik}</p>`;
                            if (properties.funksiya)
                                content += `<p><strong>Функция:</strong> ${properties.funksiya}</p>`;
                            if (properties.seysmologik_zonasi)
                                content += `<p><strong>Сейсмик зона:</strong> ${properties.seysmologik_zonasi}</p>`;
                            if (properties.hudud)
                                content += `<p><strong>Ҳудуд:</strong> ${properties.hudud}</p>`;
                            if (properties.strategiya_ishlari_turi)
                                content += `<p><strong>Стратегия иши тури:</strong> ${properties.strategiya_ishlari_turi}</p>`;
                            if (properties.mahalla_id)
                                content += `<p><strong>Маҳалла ID:</strong> ${properties.mahalla_id}</p>`;
                            if (properties.parent_code)
                                content += `<p><strong>Ота код:</strong> ${properties.parent_code}</p>`;
                            if (
                                properties.umumiy_maydonning_yer_maydoniga !==
                                undefined
                            )
                                content += `<p><strong>Умумий майдоннинг ер майдонига нисбати:</strong> ${properties.umumiy_maydonning_yer_maydoniga}</p>`;
                            if (
                                properties.qurilish_maydonining_yer_maydon !==
                                undefined
                            )
                                content += `<p><strong>Қурилиш майдонининг ер майдонига нисбати:</strong> ${properties.qurilish_maydonining_yer_maydon}</p>`;
                            if (properties.created_user)
                                content += `<p><strong>Яратувчи:</strong> ${properties.created_user}</p>`;
                            if (properties.last_edited_user)
                                content += `<p><strong>Охирги таҳрирчи:</strong> ${properties.last_edited_user}</p>`;
                            if (properties.created_date)
                                content += `<p><strong>Яратилган сана:</strong> ${new Date(
                                    properties.created_date
                                ).toLocaleDateString("uz-UZ")}</p>`;
                            if (properties.last_edited_date)
                                content += `<p><strong>Охирги таҳрир санаси:</strong> ${new Date(
                                    properties.last_edited_date
                                ).toLocaleDateString("uz-UZ")}</p>`;
                            if (properties.tekshirildi)
                                content += `<p><strong>Текширилди:</strong> ${properties.tekshirildi}</p>`;
                            if (properties.id_raqami)
                                content += `<p><strong>ID рақами:</strong> ${properties.id_raqami}</p>`;
                            if (isRedLine)
                                content += `<p><strong>Маълумот:</strong> Қизил чизиқлар - муҳофаза қилинадиган ҳудудлар</p>`;

                            // Cadastral data fields
                            if (properties.cadastral_number)
                                content += `<p><strong>Кадастр рақами:</strong> ${properties.cadastral_number}</p>`;
                            if (properties.district_name)
                                content += `<p><strong>Туман:</strong> ${properties.district_name}</p>`;
                            if (properties.region_name)
                                content += `<p><strong>Вилоят:</strong> ${properties.region_name}</p>`;
                            if (properties.sp_unit_type)
                                content += `<p><strong>Тур:</strong> ${properties.sp_unit_type.replace(/_/g, ' ')}</p>`;
                            if (properties.property_kind)
                                content += `<p><strong>Мулк тури:</strong> ${properties.property_kind.replace(/_/g, ' ')}</p>`;
                            if (properties.soato_region)
                                content += `<p><strong>СОАТО регион:</strong> ${properties.soato_region}</p>`;
                            if (properties.soato_district)
                                content += `<p><strong>СОАТО туман:</strong> ${properties.soato_district}</p>`;

                            content += `</div>`;
                            return content;
                        },
                        { maxWidth: 400, className: "geojson-popup" }
                    );
                }, []);

                const toggleGeoJSONLayer = useCallback((layerId) => {
                    const layerData = geoJsonLayersRef.current.get(layerId);
                    if (!layerData) return;

                    const map = mapInstanceRef.current;
                    if (layerData.visible) {
                        map.removeLayer(layerData.group);
                    } else {
                        map.addLayer(layerData.group);
                    }

                    geoJsonLayersRef.current.set(layerId, {
                        ...layerData,
                        visible: !layerData.visible,
                    });
                }, []);

                const removeGeoJSONLayer = useCallback(
                    (layerId) => {
                        const layerData = geoJsonLayersRef.current.get(layerId);
                        if (!layerData) return;

                        mapInstanceRef.current.removeLayer(layerData.group);
                        geoJsonLayersRef.current.delete(layerId);
                        setCounts((prev) => ({
                            ...prev,
                            geojson: Math.max(
                                0,
                                prev.geojson - layerData.count
                            ),
                        }));
                        addToast(`${layerId} қатлам ўчирилди`, "info");
                    },
                    [addToast]
                );

                const clearAllGeoJSON = useCallback(() => {
                    geoJsonLayersRef.current.forEach((layerData) => {
                        mapInstanceRef.current.removeLayer(layerData.group);
                    });
                    geoJsonLayersRef.current.clear();
                    setCounts((prev) => ({ ...prev, geojson: 0 }));
                    setGeoJsonStatus("Барча GeoJSON қатламлари тозаланди");
                    addToast("Барча GeoJSON қатламлари тозаланди", "info");
                }, [addToast]);

                // Global functions for popup buttons
                window.showDetails = useCallback((id, type) => {
                    let item = null;
                    const groups = layerGroupsRef.current;
                    if (groups[type]) {
                        groups[type].eachLayer((layer) => {
                            if (
                                layer.lotData &&
                                (layer.lotData.id == id ||
                                    layer.lotData.id === `lot-${id}`)
                            ) {
                                item = layer.lotData;
                            } else if (layer.itemData) {
                                item = layer.itemData;
                            } else if (layer.auctionData) {
                                item = layer.auctionData;
                            } else if (layer.soldData) {
                                item = layer.soldData;
                            } else if (layer.kmzData) {
                                item = layer.kmzData;
                            }
                        });
                    }

                    if (item) {
                        setSelectedItem(item);
                        setSidebarOpen(true);
                    }
                }, []);

                // Data Loading Effect
                useEffect(() => {
                    const loadAllData = async () => {
                        if (!mapInstanceRef.current) return;

                        setLoading(true);

                        try {
                            const results = await Promise.allSettled([
                                fetchAktivsData(),
                                fetchJsonData(),
                                fetchAuctionData(),
                                fetchSoldData(),
                                fetchRenovatsiyaProjects(),
                            ]);

                            const successCount = results.filter(
                                (result) =>
                                    result.status === "fulfilled" &&
                                    result.value
                            ).length;

                            if (successCount > 0) {
                                setTimeout(() => {
                                    loadGeoJSON(API_ENDPOINTS.geoJsonStrategy);
                                }, 1000);
                                setTimeout(() => {
                                    loadGeoJSON('./TOSHKENT_CADASTRAL_COMPLETE.geojson');
                                }, 1500);

                                mapInstanceRef.current.setView(
                                    [41.311, 69.279],
                                    11
                                );
                                addToast(
                                    `Маълумотлар муваффақиятли юкланди`,
                                    "success"
                                );
                            } else {
                                addToast(
                                    "Ҳеч қандай маълумот юкланмади. Серверни текширинг.",
                                    "warning"
                                );
                                mapInstanceRef.current.setView(
                                    [41.311, 69.279],
                                    11
                                );
                            }
                        } catch (error) {
                            console.error("Error during data loading:", error);
                            addToast("Ишга туширишда хатолик", "error");
                            mapInstanceRef.current.setView(
                                [41.311, 69.279],
                                11
                            );
                        } finally {
                            setLoading(false);
                        }
                    };

                    if (mapRef.current && !mapInstanceRef.current) {
                        initializeMap();
                        setTimeout(loadAllData, 100);
                    }
                }, [
                    initializeMap,
                    fetchAktivsData,
                    fetchJsonData,
                    fetchAuctionData,
                    fetchSoldData,
                    fetchRenovatsiyaProjects,
                    loadGeoJSON,
                    addToast,
                ]);

                // Memoized components
                const memoizedKMZSearchControl = useMemo(
                    () => React.createElement(KMZSearchControl, { addToast }),
                    [addToast]
                );

                const memoizedLocationSearchControl = useMemo(
                    () => React.createElement(LocationSearchControl, { addToast }),
                    [addToast]
                );

                const memoizedLayerControls = useMemo(
                    () =>
                        React.createElement(LayerControls, {
                            layers: layers,
                            onToggle: toggleLayer,
                            counts: counts,
                        }),
                    [layers, counts, toggleLayer]
                );

                const memoizedMapStyleControls = useMemo(
                    () =>
                        React.createElement(MapStyleControls, {
                            currentStyle: currentMapStyle,
                            onStyleChange: changeMapStyle,
                        }),
                    [currentMapStyle, changeMapStyle]
                );

                const memoizedGeoJSONControls = useMemo(
                    () =>
                        React.createElement(GeoJSONControls, {
                            geoJsonLayers: geoJsonLayersRef.current,
                            onLoad: () => loadGeoJSON(geoJsonFilepath),
                            onToggle: toggleGeoJSONLayer,
                            onRemove: removeGeoJSONLayer,
                            onClear: clearAllGeoJSON,
                            status: geoJsonStatus,
                            filepath: geoJsonFilepath,
                            setFilepath: setGeoJsonFilepath,
                        }),
                    [
                        geoJsonFilepath,
                        geoJsonStatus,
                        loadGeoJSON,
                        toggleGeoJSONLayer,
                        removeGeoJSONLayer,
                        clearAllGeoJSON,
                    ]
                );

                return React.createElement(
                    "div",
                    { className: "app-container" },
                    // Header with Uzbek Flag
                    React.createElement(
                        "header",
                        { className: "app-header" },
                        React.createElement(
                            "div",
                            { className: "app-logo" },
                            React.createElement(
                                "div",
                                { className: "logo-icon" },
                                React.createElement("i", {
                                    className: "fas fa-map-marked-alt",
                                })
                            ),
                            React.createElement(
                                "div",
                                null,
                                React.createElement(
                                    "div",
                                    { className: "app-title" },
                                    TEXTS.appTitle
                                ),
                                React.createElement(
                                    "div",
                                    { className: "app-subtitle" },
                                    TEXTS.appSubtitle
                                )
                            )
                        ),
                        React.createElement(
                            "div",
                            { className: "header-controls" },
                            React.createElement(
                                "div",
                                { className: "lang-switcher" },
                                React.createElement(
                                    "button",
                                    { className: "lang-btn active" },
                                    "УЗ"
                                ),
                                React.createElement(
                                    "button",
                                    { className: "lang-btn" },
                                    "RU"
                                ),
                                React.createElement(
                                    "button",
                                    { className: "lang-btn" },
                                    "EN"
                                )
                            )
                        ),
                        React.createElement("div", {
                            className: "uzbek-flag-stripe",
                        })
                    ),

                    // Main Content
                    React.createElement(
                        "div",
                        { className: "main-content" },
                        React.createElement(
                            "div",
                            { className: "map-container" },
                            // Map
                            React.createElement("div", {
                                ref: mapRef,
                                id: "map",
                            }),

                            // Control Panels
                            memoizedMapStyleControls,
                            memoizedLocationSearchControl,
                            memoizedKMZSearchControl,
                            memoizedLayerControls,
                            memoizedGeoJSONControls
                        ),

                        // Sidebar
                        React.createElement(Sidebar, {
                            isOpen: sidebarOpen,
                            onClose: () => setSidebarOpen(false),
                            item: selectedItem,
                        })
                    ),

                    // Loading Overlay
                    React.createElement(Loading, { show: loading }),

                    // Toast Notifications
                    React.createElement(Toast, {
                        toasts: toasts,
                        removeToast: removeToast,
                    })
                );
            };

            // Render the app using React 18's createRoot
            const root = createRoot(document.getElementById("root"));
            root.render(React.createElement(InvestUzMap));

        </script>
    </body>
</html>
